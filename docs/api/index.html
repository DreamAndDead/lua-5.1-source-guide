<!doctype html><html lang=zh dir=ltr><head><meta name=generator content="Hugo 0.80.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lua 的一个杰出的特性是，非常易于与 C 程序集成。
一个原因是 Lua 本身是用 C 语言实现的， 另一个原因则是 Lua 内部在 vm 层面设计提供了相应的 api。
design #  从之前的视角来看，代码编译为 Proto，vm 开启线程，封装为 Closure 并按指令执行。
从另一个角度来看 Lua 代码的运行过程。
如果反过来看，vm 本身是静态不动的，程序的运行由输入的 Proto 而驱动。 之所以产生这样的视角，是因为 vm 必须有指令输入，告诉其应该执行什么， 否则 vm 本身也只是空转而已。
api 层提供的功能就是如此，控制 vm 应该如何执行。
如此来看，Lua 代码和 api 都是在操作 lua_State ，vm 的运行时状态。 只不过一个是编译为 opcode 由 vm 主动执行，一个是通过 c 函数接口来直接控制。
  值得注意的时，api 不仅提供与语言外部使用，也在内部发挥着重要作用。
api 在外部使用，可以将 Lua 作为 C lib 来使用； 同时 api 在内部，实现了诸多 Lua 语言标准库的功能。"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="c api"><meta property="og:description" content="Lua 的一个杰出的特性是，非常易于与 C 程序集成。
一个原因是 Lua 本身是用 C 语言实现的， 另一个原因则是 Lua 内部在 vm 层面设计提供了相应的 api。
design #  从之前的视角来看，代码编译为 Proto，vm 开启线程，封装为 Closure 并按指令执行。
从另一个角度来看 Lua 代码的运行过程。
如果反过来看，vm 本身是静态不动的，程序的运行由输入的 Proto 而驱动。 之所以产生这样的视角，是因为 vm 必须有指令输入，告诉其应该执行什么， 否则 vm 本身也只是空转而已。
api 层提供的功能就是如此，控制 vm 应该如何执行。
如此来看，Lua 代码和 api 都是在操作 lua_State ，vm 的运行时状态。 只不过一个是编译为 opcode 由 vm 主动执行，一个是通过 c 函数接口来直接控制。
  值得注意的时，api 不仅提供与语言外部使用，也在内部发挥着重要作用。
api 在外部使用，可以将 Lua 作为 C lib 来使用； 同时 api 在内部，实现了诸多 Lua 语言标准库的功能。"><meta property="og:type" content="article"><meta property="og:url" content="https://dreamanddead.github.io/lua-5.1-source-guide/docs/api/"><meta property="article:published_time" content="2021-01-15T17:48:00+08:00"><meta property="article:modified_time" content="2021-02-23T13:26:02+08:00"><title>c api | lua 5.1 source guide</title><link rel=manifest href=/lua-5.1-source-guide/manifest.json><link rel=icon href=/lua-5.1-source-guide/favicon.png type=image/x-icon><link rel=stylesheet href=/lua-5.1-source-guide/book.min.44110be292c9f873dbe57bd8895d52b387519bad9a89a86ed5c3705e11d6b0d5.css integrity="sha256-RBEL4pLJ+HPb5XvYiV1Ss4dRm62aiahu1cNwXhHWsNU="><script defer src=/lua-5.1-source-guide/zh.search.min.7290bfd60a7f5c526bdb44d6c18babbd3e5ba6b7b0df02ac8bda3f32a4cf6542.js integrity="sha256-cpC/1gp/XFJr20TWwYurvT5bprew3wKsi9o/MqTPZUI="></script><script defer src=/lua-5.1-source-guide/sw.min.630373637e97fa7891a03b850675656b8da4625d692de7ef0581b22b995ab946.js integrity="sha256-YwNzY36X+niRoDuFBnVla42kYl1pLefvBYGyK5lauUY="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/lua-5.1-source-guide><img src=/lua-5.1-source-guide/logo.png alt=Logo><span>lua 5.1 source guide</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/lua-5.1-source-guide/docs/overview/>overview</a></li><li>basic<ul><li><a href=/lua-5.1-source-guide/docs/object/>object</a></li><li><a href=/lua-5.1-source-guide/docs/memory/>memory</a></li><li><a href=/lua-5.1-source-guide/docs/string/>string</a></li><li><a href=/lua-5.1-source-guide/docs/table/>table</a></li></ul></li><li>compiler<ul><li><a href=/lua-5.1-source-guide/docs/lexer/>lexer</a></li><li><a href=/lua-5.1-source-guide/docs/opcode/>opcode</a></li><li><a href=/lua-5.1-source-guide/docs/parser/>parser</a></li><li><a href=/lua-5.1-source-guide/docs/generator/>generator</a></li></ul></li><li>vm<ul><li><a href=/lua-5.1-source-guide/docs/vm/>vm</a></li><li><a href=/lua-5.1-source-guide/docs/api/ class=active>c api</a></li><li><a href=/lua-5.1-source-guide/docs/stdlib/>stdlib</a></li><li><a href=/lua-5.1-source-guide/docs/gc/>gc</a></li></ul></li></ul><p><br></p><ul><li><a href=https://github.com/DreamAndDead/lua-5.1-source-guide target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/lua-5.1-source-guide/svg/menu.svg class=book-icon alt=Menu></label>
<strong>c api</strong>
<label for=toc-control><img src=/lua-5.1-source-guide/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#design>design</a></li><li><a href=#stack>stack</a></li><li><a href=#c-closure>c closure</a></li><li><a href=#practice>practice</a></li></ul></li></ul></nav></aside></header><article class=markdown><p>Lua 的一个杰出的特性是，非常易于与 C 程序集成。</p><p>一个原因是 Lua 本身是用 C 语言实现的，
另一个原因则是 Lua 内部在 vm 层面设计提供了相应的 api。</p><h2 id=design>design
<a class=anchor href=#design>#</a></h2><p>从之前的视角来看，代码编译为 Proto，vm 开启线程，封装为 Closure 并按指令执行。</p><p>从另一个角度来看 Lua 代码的运行过程。</p><p>如果反过来看，vm 本身是静态不动的，程序的运行由输入的 Proto 而驱动。
之所以产生这样的视角，是因为 vm 必须有指令输入，告诉其应该执行什么，
否则 vm 本身也只是空转而已。</p><p>api 层提供的功能就是如此，控制 vm 应该如何执行。</p><p>如此来看，Lua 代码和 api 都是在操作 <code>lua_State</code> ，vm 的运行时状态。
只不过一个是编译为 opcode 由 vm 主动执行，一个是通过 c 函数接口来直接控制。</p><figure><img src=api-design.png></figure><p>值得注意的时，api 不仅提供与语言外部使用，也在内部发挥着重要作用。</p><p>api 在外部使用，可以将 Lua 作为 C lib 来使用；
同时 api 在内部，实现了诸多 Lua 语言标准库的功能。</p><h2 id=stack>stack
<a class=anchor href=#stack>#</a></h2><p>说到 vm 运行时状态，最重要的部分就是栈。</p><p>实际上，几乎全部 api 都是对栈的操作。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>/*
</span><span style=color:#75715e>** state manipulation
</span><span style=color:#75715e>*/</span>
LUA_API lua_State <span style=color:#f92672>*</span>(lua_newstate) (lua_Alloc f, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>ud);
LUA_API <span style=color:#a6e22e>void</span>       (lua_close) (lua_State <span style=color:#f92672>*</span>L);
LUA_API lua_State <span style=color:#f92672>*</span>(lua_newthread) (lua_State <span style=color:#f92672>*</span>L);

LUA_API <span style=color:#a6e22e>lua_CFunction</span> (lua_atpanic) (lua_State <span style=color:#f92672>*</span>L, lua_CFunction panicf);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** basic stack manipulation
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>int</span>   (lua_gettop) (lua_State <span style=color:#f92672>*</span>L);
LUA_API <span style=color:#a6e22e>void</span>  (lua_settop) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushvalue) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_remove) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_insert) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_replace) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>   (lua_checkstack) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> sz);

LUA_API <span style=color:#a6e22e>void</span>  (lua_xmove) (lua_State <span style=color:#f92672>*</span>from, lua_State <span style=color:#f92672>*</span>to, <span style=color:#66d9ef>int</span> n);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** access functions (stack -&gt; C)
</span><span style=color:#75715e>*/</span>

LUA_API <span style=color:#a6e22e>int</span>             (lua_isnumber) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>             (lua_isstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>             (lua_iscfunction) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>             (lua_isuserdata) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>             (lua_type) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span>     <span style=color:#f92672>*</span>(lua_typename) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> tp);

LUA_API <span style=color:#a6e22e>int</span>            (lua_equal) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx1, <span style=color:#66d9ef>int</span> idx2);
LUA_API <span style=color:#a6e22e>int</span>            (lua_rawequal) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx1, <span style=color:#66d9ef>int</span> idx2);
LUA_API <span style=color:#a6e22e>int</span>            (lua_lessthan) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx1, <span style=color:#66d9ef>int</span> idx2);

LUA_API <span style=color:#a6e22e>lua_Number</span>      (lua_tonumber) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>lua_Integer</span>     (lua_tointeger) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>int</span>             (lua_toboolean) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span>     <span style=color:#f92672>*</span>(lua_tolstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx, size_t <span style=color:#f92672>*</span>len);
LUA_API <span style=color:#a6e22e>size_t</span>          (lua_objlen) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>lua_CFunction</span>   (lua_tocfunction) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#66d9ef>void</span>	       <span style=color:#f92672>*</span>(lua_touserdata) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API lua_State      <span style=color:#f92672>*</span>(lua_tothread) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span>     <span style=color:#f92672>*</span>(lua_topointer) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** push functions (C -&gt; stack)
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushnil) (lua_State <span style=color:#f92672>*</span>L);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushnumber) (lua_State <span style=color:#f92672>*</span>L, lua_Number n);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushinteger) (lua_State <span style=color:#f92672>*</span>L, lua_Integer n);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushlstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>s, size_t l);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>s);
LUA_API <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>(lua_pushvfstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>fmt,
						      va_list argp);
LUA_API <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>(lua_pushfstring) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>fmt, ...);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushcclosure) (lua_State <span style=color:#f92672>*</span>L, lua_CFunction fn, <span style=color:#66d9ef>int</span> n);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushboolean) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> b);
LUA_API <span style=color:#a6e22e>void</span>  (lua_pushlightuserdata) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>p);
LUA_API <span style=color:#a6e22e>int</span>   (lua_pushthread) (lua_State <span style=color:#f92672>*</span>L);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** get functions (Lua -&gt; stack)
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>void</span>  (lua_gettable) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_getfield) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>k);
LUA_API <span style=color:#a6e22e>void</span>  (lua_rawget) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_rawgeti) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx, <span style=color:#66d9ef>int</span> n);
LUA_API <span style=color:#a6e22e>void</span>  (lua_createtable) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> narr, <span style=color:#66d9ef>int</span> nrec);
LUA_API <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>(lua_newuserdata) (lua_State <span style=color:#f92672>*</span>L, size_t sz);
LUA_API <span style=color:#a6e22e>int</span>   (lua_getmetatable) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> objindex);
LUA_API <span style=color:#a6e22e>void</span>  (lua_getfenv) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** set functions (stack -&gt; Lua)
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>void</span>  (lua_settable) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_setfield) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>k);
LUA_API <span style=color:#a6e22e>void</span>  (lua_rawset) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);
LUA_API <span style=color:#a6e22e>void</span>  (lua_rawseti) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx, <span style=color:#66d9ef>int</span> n);
LUA_API <span style=color:#a6e22e>int</span>   (lua_setmetatable) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> objindex);
LUA_API <span style=color:#a6e22e>int</span>   (lua_setfenv) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** `load&#39; and `call&#39; functions (load and run Lua code)
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>void</span>  (lua_call) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> nargs, <span style=color:#66d9ef>int</span> nresults);
LUA_API <span style=color:#a6e22e>int</span>   (lua_pcall) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> nargs, <span style=color:#66d9ef>int</span> nresults, <span style=color:#66d9ef>int</span> errfunc);
LUA_API <span style=color:#a6e22e>int</span>   (lua_cpcall) (lua_State <span style=color:#f92672>*</span>L, lua_CFunction func, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>ud);
LUA_API <span style=color:#a6e22e>int</span>   (lua_load) (lua_State <span style=color:#f92672>*</span>L, lua_Reader reader, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dt,
					<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>chunkname);

LUA_API <span style=color:#a6e22e>int</span> (lua_dump) (lua_State <span style=color:#f92672>*</span>L, lua_Writer writer, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>data);


<span style=color:#75715e>/*
</span><span style=color:#75715e>** coroutine functions
</span><span style=color:#75715e>*/</span>
LUA_API <span style=color:#a6e22e>int</span>  (lua_yield) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> nresults);
LUA_API <span style=color:#a6e22e>int</span>  (lua_resume) (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> narg);
LUA_API <span style=color:#a6e22e>int</span>  (lua_status) (lua_State <span style=color:#f92672>*</span>L);</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 1</span>:
lua.h</div><p>在官方文档<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>中，有对所有 api 功能的绝佳描述。</p><p>结合之前 opcode 的实现过程以及一些基本的栈操作理解，相应的 api 实现并不难理解。</p><p>其中值得注意的是栈的索引。</p><p>在对栈进行操作之前，必须先索引到其中的元素。</p><p>api 内部使用一种自定义的映射关系，将整数映射到元素的栈位置。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>static</span> TValue <span style=color:#f92672>*</span><span style=color:#a6e22e>index2adr</span> (lua_State <span style=color:#f92672>*</span>L, <span style=color:#66d9ef>int</span> idx) {
  <span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
    TValue <span style=color:#f92672>*</span>o <span style=color:#f92672>=</span> L<span style=color:#f92672>-&gt;</span>base <span style=color:#f92672>+</span> (idx <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
    api_check(L, idx <span style=color:#f92672>&lt;=</span> L<span style=color:#f92672>-&gt;</span>ci<span style=color:#f92672>-&gt;</span>top <span style=color:#f92672>-</span> L<span style=color:#f92672>-&gt;</span>base);
    <span style=color:#66d9ef>if</span> (o <span style=color:#f92672>&gt;=</span> L<span style=color:#f92672>-&gt;</span>top) <span style=color:#66d9ef>return</span> cast(TValue <span style=color:#f92672>*</span>, luaO_nilobject);
    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>return</span> o;
  }
  <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;</span> LUA_REGISTRYINDEX) {
    api_check(L, idx <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>-</span>idx <span style=color:#f92672>&lt;=</span> L<span style=color:#f92672>-&gt;</span>top <span style=color:#f92672>-</span> L<span style=color:#f92672>-&gt;</span>base);
    <span style=color:#66d9ef>return</span> L<span style=color:#f92672>-&gt;</span>top <span style=color:#f92672>+</span> idx;
  }
  <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>switch</span> (idx) {  <span style=color:#75715e>/* pseudo-indices */</span>
    <span style=color:#66d9ef>case</span> LUA_REGISTRYINDEX: <span style=color:#66d9ef>return</span> registry(L);
    <span style=color:#66d9ef>case</span> LUA_ENVIRONINDEX: {
      Closure <span style=color:#f92672>*</span>func <span style=color:#f92672>=</span> curr_func(L);
      sethvalue(L, <span style=color:#f92672>&amp;</span>L<span style=color:#f92672>-&gt;</span>env, func<span style=color:#f92672>-&gt;</span>c.env);
      <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>L<span style=color:#f92672>-&gt;</span>env;
    }
    <span style=color:#66d9ef>case</span> LUA_GLOBALSINDEX: <span style=color:#66d9ef>return</span> gt(L);
    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> {
      Closure <span style=color:#f92672>*</span>func <span style=color:#f92672>=</span> curr_func(L);
      idx <span style=color:#f92672>=</span> LUA_GLOBALSINDEX <span style=color:#f92672>-</span> idx;
      <span style=color:#66d9ef>return</span> (idx <span style=color:#f92672>&lt;=</span> func<span style=color:#f92672>-&gt;</span>c.nupvalues)
		<span style=color:#f92672>?</span> <span style=color:#f92672>&amp;</span>func<span style=color:#f92672>-&gt;</span>c.upvalue[idx<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
		<span style=color:#f92672>:</span> cast(TValue <span style=color:#f92672>*</span>, luaO_nilobject);
    }
  }
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 2</span>:
lapi.c</div><figure><img src=api-index2addr.png></figure><p>其中 <code>L->base</code> 和 <code>L->top</code> 标识了栈底和栈顶。</p><p>正整数索引从 1 开始，索引 1 指向 <code>L->base</code> ，递增向上。</p><p>负整数索引从 -1 开始，索引 <code>L->top</code> 之下的元素，递减向下。</p><p>0 不作为索引来使用。</p><p>在上面的规则之外，api 内部使用几个特别定义的索引值，</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>/*
</span><span style=color:#75715e>** pseudo-indices
</span><span style=color:#75715e>*/</span>
<span style=color:#75715e>#define LUA_REGISTRYINDEX	(-10000)
</span><span style=color:#75715e>#define LUA_ENVIRONINDEX	(-10001)
</span><span style=color:#75715e>#define LUA_GLOBALSINDEX	(-10002)
</span><span style=color:#75715e>#define lua_upvalueindex(i)	(LUA_GLOBALSINDEX-(i))</span></code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 3</span>:
lua.h</div><ul><li><code>LUA_REGISTRYINDEX</code> 索引全局状态的 <code>l_registry</code></li><li><code>LUA_ENVIRONINDEX</code> 索引当前 closure 的环境</li><li><code>LUA_GLOBALSINDEX</code> 索引当前 <code>lua_State</code> 的全局表</li><li>更小的负数，依次索引当前 closure 的 upvalue</li></ul><h2 id=c-closure>c closure
<a class=anchor href=#c-closure>#</a></h2><p>在 vm 章节提到过，closure 有两种类型，CClosure 和 LClosure。</p><p>LClosure 即从 Lua 代码编译得到的函数，而 CClosure 是通过 C api 实现的函数。</p><p>因为 CClosure 要和 Lua 交互，所以要遵循一定的约定<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>。</p><p>首先，CClosure 在 C 语言中需要定义为 <code>lua_CFunction</code> 类型，</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span> (<span style=color:#f92672>*</span>lua_CFunction) (lua_State <span style=color:#f92672>*</span>L);</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 4</span>:
lua.h</div><p>其中，在调用时，从 base 到 top 都是 CClosure 的参数，</p><p>最终，将返回值按顺序压栈，并返回参数个数。</p><p>这个传参，调用，返回值的约定和 vm 内部解析 LClosure 是一样的。</p><p>官方文档<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>提供了一段示例代码，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;lua.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;lualib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;lauxlib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>foo</span> (lua_State <span style=color:#f92672>*</span>L) {
  <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> lua_gettop(L);    <span style=color:#75715e>/* number of arguments */</span>
  lua_Number sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>int</span> i;
  <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; i <span style=color:#f92672>&lt;=</span> n; i<span style=color:#f92672>++</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>lua_isnumber(L, i)) {
      lua_pushstring(L, <span style=color:#e6db74>&#34;incorrect argument&#34;</span>);
      lua_error(L);
    }
    sum <span style=color:#f92672>+=</span> lua_tonumber(L, i);
  }
  lua_pushnumber(L, sum<span style=color:#f92672>/</span>n);        <span style=color:#75715e>/* first result */</span>
  lua_pushnumber(L, sum);         <span style=color:#75715e>/* second result */</span>
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>2</span>;                   <span style=color:#75715e>/* number of results */</span>
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argv[])
{
    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> file <span style=color:#f92672>=</span> NULL;
    file <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>1</span>];

    lua_State<span style=color:#f92672>*</span> L <span style=color:#f92672>=</span> luaL_newstate();

    luaL_openlibs(L);

    lua_pushcfunction(L, foo);

    lua_setfield(L, LUA_GLOBALSINDEX, <span style=color:#e6db74>&#34;foo&#34;</span>);

    luaL_dofile(L, file);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>avg, sum <span style=color:#f92672>=</span> foo(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)

print(avg, sum)
</code></pre></div><p>通过</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ make -s example
</code></pre></div><p>可以编译运行上述示例。</p><p>其中先注册了 CClosure 为全局变量 foo，再在 lua 代码中调用，
打印出所有参数的平均值和总和。</p><p>其中栈的变化情况如下，</p><figure><img src=api-closure-call.png></figure><h2 id=practice>practice
<a class=anchor href=#practice>#</a></h2><p>在 <code>example/</code> 目录下，实现了两种 foo 的实现方式。</p><p>cclosure 小节在 C 语言层面，定义 foo 并注册到全局表中，而在 Lua 层面调用；
<code>example/lclosure.c</code> <code>example/lclosure.lua</code> 将 foo 在 Lua 代码中定义为全局变量，
而在 C 语言层面调用。</p><p>读者可通过</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ make -s example
</code></pre></div><p>来对比这两种协同方式。</p><table><thead><tr><th>章节涉及文件</th><th>建议了解程度</th></tr></thead><tbody><tr><td>lua.h</td><td>★ ★ ★ ★ ★</td></tr><tr><td>lapi.h</td><td>★ ☆ ☆ ☆ ☆</td></tr><tr><td>lapi.c</td><td>★ ★ ★ ★ ★</td></tr></tbody></table><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#3>http://www.lua.org/manual/5.1/manual.html#3</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#lua%5FCFunction>http://www.lua.org/manual/5.1/manual.html#lua%5FCFunction</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/DreamAndDead/lua-5.1-source-guide/commit/8c359ebae66c3a96c4a0c7ed6ba49ad52483055a title="最后修改者 DreamAndDead | February 23, 2021" target=_blank rel=noopener><img src=/lua-5.1-source-guide/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 23, 2021</span></a></div><div><a class="flex align-center" href=https://github.com/DreamAndDead/lua-5.1-source-guide/edit/master/site/content/docs/api/index.md target=_blank rel=noopener><img src=/lua-5.1-source-guide/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span></a></div></div></footer><div class=book-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lua-book"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#design>design</a></li><li><a href=#stack>stack</a></li><li><a href=#c-closure>c closure</a></li><li><a href=#practice>practice</a></li></ul></li></ul></nav></div></aside></main></body></html>