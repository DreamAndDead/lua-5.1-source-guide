<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-01-20 三 13:07 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>std lib</title>
<meta name="generator" content="Org mode">
<meta name="author" content="DreamAndDead">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link id="theme" rel="stylesheet" type="text/css" href="htmlize.css">
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">std lib</h1>
<p>
在 lex 章节提到，require next 之类不是关键字而是函数，
在 api 章节提到 api 也用于内部作用，
它们描述的都是 lua 标准库。
</p>

<p>
本章节就来讲解 lua 内部是如何处理标准库的。
</p>

<div id="outline-container-orgbc34983" class="outline-2">
<h2 id="orgbc34983"><span class="section-number-2">1</span> register</h2>
<div class="outline-text-2" id="text-1">
<p>
标准库可以说是多种功能函数的集合，在被使用之前，必须先被注册。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>lualib.h</label><pre class="src src-C"><span class="linenr">18: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_COLIBNAME</span>   <span class="org-string">"coroutine"</span>
<span class="linenr">19: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_base) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">20: </span>
<span class="linenr">21: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_TABLIBNAME</span>  <span class="org-string">"table"</span>
<span class="linenr">22: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_table) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">23: </span>
<span class="linenr">24: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_IOLIBNAME</span>   <span class="org-string">"io"</span>
<span class="linenr">25: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_io) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">26: </span>
<span class="linenr">27: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_OSLIBNAME</span>   <span class="org-string">"os"</span>
<span class="linenr">28: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_os) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">29: </span>
<span class="linenr">30: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_STRLIBNAME</span>  <span class="org-string">"string"</span>
<span class="linenr">31: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_string) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">32: </span>
<span class="linenr">33: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_MATHLIBNAME</span> <span class="org-string">"math"</span>
<span class="linenr">34: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_math) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">35: </span>
<span class="linenr">36: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_DBLIBNAME</span>   <span class="org-string">"debug"</span>
<span class="linenr">37: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_debug) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">38: </span>
<span class="linenr">39: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_LOADLIBNAME</span> <span class="org-string">"package"</span>
<span class="linenr">40: </span><span class="org-type">LUALIB_API</span> <span class="org-type">int</span> (luaopen_package) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>);
<span class="linenr">41: </span>
<span class="linenr">42: </span>
<span class="linenr">43: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">open all previous libraries</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">44: </span><span class="org-type">LUALIB_API</span> <span class="org-type">void</span> (luaL_openlibs) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>); 
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>lauxlib.h</label><pre class="src src-C"><span class="linenr">35: </span><span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">luaL_Reg</span> {
<span class="linenr">36: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
<span class="linenr">37: </span>  <span class="org-type">lua_CFunction</span> <span class="org-variable-name">func</span>;
<span class="linenr">38: </span>} <span class="org-type">luaL_Reg</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>linit.c</label><pre class="src src-C"><span class="linenr">17: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> <span class="org-variable-name">lualibs</span>[] = {
<span class="linenr">18: </span>  {<span class="org-string">""</span>, luaopen_base},
<span class="linenr">19: </span>  {LUA_LOADLIBNAME, luaopen_package},
<span class="linenr">20: </span>  {LUA_TABLIBNAME, luaopen_table},
<span class="linenr">21: </span>  {LUA_IOLIBNAME, luaopen_io},
<span class="linenr">22: </span>  {LUA_OSLIBNAME, luaopen_os},
<span class="linenr">23: </span>  {LUA_STRLIBNAME, luaopen_string},
<span class="linenr">24: </span>  {LUA_MATHLIBNAME, luaopen_math},
<span class="linenr">25: </span>  {LUA_DBLIBNAME, luaopen_debug},
<span class="linenr">26: </span>  {<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>}
<span class="linenr">27: </span>};
<span class="linenr">28: </span>
<span class="linenr">29: </span>
<span class="linenr">30: </span>LUALIB_API <span class="org-type">void</span> <span class="org-function-name">luaL_openlibs</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">31: </span>  <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> *<span class="org-variable-name">lib</span> = lualibs;
<span class="linenr">32: </span>  <span class="org-keyword">for</span> (; lib-&gt;func; lib++) {
<span class="linenr">33: </span>    lua_pushcfunction(L, lib-&gt;func);
<span class="linenr">34: </span>    lua_pushstring(L, lib-&gt;name);
<span class="linenr">35: </span>    lua_call(L, 1, 0);
<span class="linenr">36: </span>  }
<span class="linenr">37: </span>}
</pre>
</div>

<p>
各个模块实现了各自的功能，分别注册到不同的模块名中。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">file</th>
<th scope="col" class="org-left">module</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">lbaselib.c</td>
<td class="org-left">(coroutine)</td>
</tr>

<tr>
<td class="org-left">lmathlib.c</td>
<td class="org-left">math</td>
</tr>

<tr>
<td class="org-left">lstrlib.c</td>
<td class="org-left">string</td>
</tr>

<tr>
<td class="org-left">ltablib.c</td>
<td class="org-left">table</td>
</tr>

<tr>
<td class="org-left">liolib.c</td>
<td class="org-left">io</td>
</tr>

<tr>
<td class="org-left">loslib.c</td>
<td class="org-left">os</td>
</tr>

<tr>
<td class="org-left">ldblib.c</td>
<td class="org-left">debug</td>
</tr>

<tr>
<td class="org-left">loadlib.c</td>
<td class="org-left">package</td>
</tr>
</tbody>
</table>

<p>
同时每个模块各自实现注册方法，由 <code>luaL_openlibs</code> 统一调用。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>lauxlib.c</label><pre class="src src-C"><span class="linenr">229: </span><span class="org-type">LUALIB_API</span> <span class="org-type">void</span> (luaL_register) (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">libname</span>,
<span class="linenr">230: </span>                                <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> *<span class="org-variable-name">l</span>) {
<span class="linenr">231: </span>  luaI_openlib(L, libname, l, 0);
<span class="linenr">232: </span>}
<span class="linenr">233: </span>
<span class="linenr">234: </span>
<span class="linenr">235: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">libsize</span> (<span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> *<span class="org-variable-name">l</span>) {
<span class="linenr">236: </span>  <span class="org-type">int</span> <span class="org-variable-name">size</span> = 0;
<span class="linenr">237: </span>  <span class="org-keyword">for</span> (; l-&gt;name; l++) size++;
<span class="linenr">238: </span>  <span class="org-keyword">return</span> size;
<span class="linenr">239: </span>}
<span class="linenr">240: </span>
<span class="linenr">241: </span>
<span class="linenr">242: </span><span class="org-type">LUALIB_API</span> <span class="org-type">void</span> <span class="org-function-name">luaI_openlib</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">libname</span>,
<span class="linenr">243: </span>                              <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> *<span class="org-variable-name">l</span>, <span class="org-type">int</span> <span class="org-variable-name">nup</span>) {
<span class="linenr">244: </span>  <span class="org-keyword">if</span> (libname) {
<span class="linenr">245: </span>    <span class="org-type">int</span> <span class="org-variable-name">size</span> = libsize(l);
<span class="linenr">246: </span>    <span class="org-comment-delimiter">/* </span><span class="org-comment">check whether lib already exists</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">247: </span>    luaL_findtable(L, LUA_REGISTRYINDEX, <span class="org-string">"_LOADED"</span>, 1);
<span class="linenr">248: </span>    lua_getfield(L, -1, libname);  <span class="org-comment-delimiter">/* </span><span class="org-comment">get _LOADED[libname]</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">249: </span>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>lua_istable(L, -1)) {  <span class="org-comment-delimiter">/* </span><span class="org-comment">not found?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">250: </span>      lua_pop(L, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">remove previous result</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">251: </span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">try global variable (and create one if it does not exist)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">252: </span>      <span class="org-keyword">if</span> (luaL_findtable(L, LUA_GLOBALSINDEX, libname, size) != <span class="org-constant">NULL</span>)
<span class="linenr">253: </span>        luaL_error(L, <span class="org-string">"name conflict for module "</span> LUA_QS, libname);
<span class="linenr">254: </span>      lua_pushvalue(L, -1);
<span class="linenr">255: </span>      lua_setfield(L, -3, libname);  <span class="org-comment-delimiter">/* </span><span class="org-comment">_LOADED[libname] = new table</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">256: </span>    }
<span class="linenr">257: </span>    lua_remove(L, -2);  <span class="org-comment-delimiter">/* </span><span class="org-comment">remove _LOADED table</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">258: </span>    lua_insert(L, -(nup+1));  <span class="org-comment-delimiter">/* </span><span class="org-comment">move library table to below upvalues</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">259: </span>  }
<span class="linenr">260: </span>  <span class="org-keyword">for</span> (; l-&gt;name; l++) {
<span class="linenr">261: </span>    <span class="org-type">int</span> <span class="org-variable-name">i</span>;
<span class="linenr">262: </span>    <span class="org-keyword">for</span> (i=0; i&lt;nup; i++)  <span class="org-comment-delimiter">/* </span><span class="org-comment">copy upvalues to the top</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">263: </span>      lua_pushvalue(L, -nup);
<span class="linenr">264: </span>    lua_pushcclosure(L, l-&gt;func, nup);
<span class="linenr">265: </span>    lua_setfield(L, -(nup+2), l-&gt;name);
<span class="linenr">266: </span>  }
<span class="linenr">267: </span>  lua_pop(L, nup);  <span class="org-comment-delimiter">/* </span><span class="org-comment">remove upvalues</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">268: </span>}
</pre>
</div>

<p>
首先进行注册的是全局方法和 coroutine 模块，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">626: </span><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">base_open</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">627: </span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">set global _G</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">628: </span>  lua_pushvalue(L, LUA_GLOBALSINDEX);
<span class="linenr">629: </span>  lua_setglobal(L, <span class="org-string">"_G"</span>);
<span class="linenr">630: </span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">open lib into global table</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">631: </span>  luaL_register(L, <span class="org-string">"_G"</span>, base_funcs);
<span class="linenr">632: </span>  lua_pushliteral(L, LUA_VERSION);
<span class="linenr">633: </span>  lua_setglobal(L, <span class="org-string">"_VERSION"</span>);  <span class="org-comment-delimiter">/* </span><span class="org-comment">set global _VERSION</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">634: </span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">`ipairs' and `pairs' need auxiliary functions as upvalues</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">635: </span>  auxopen(L, <span class="org-string">"ipairs"</span>, luaB_ipairs, ipairsaux);
<span class="linenr">636: </span>  auxopen(L, <span class="org-string">"pairs"</span>, luaB_pairs, luaB_next);
<span class="linenr">637: </span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">`newproxy' needs a weaktable as upvalue</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">638: </span>  lua_createtable(L, 0, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">new table `w'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">639: </span>  lua_pushvalue(L, -1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">`w' will be its own metatable</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">640: </span>  lua_setmetatable(L, -2);
<span class="linenr">641: </span>  lua_pushliteral(L, <span class="org-string">"kv"</span>);
<span class="linenr">642: </span>  lua_setfield(L, -2, <span class="org-string">"__mode"</span>);  <span class="org-comment-delimiter">/* </span><span class="org-comment">metatable(w).__mode = "kv"</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">643: </span>  lua_pushcclosure(L, luaB_newproxy, 1);
<span class="linenr">644: </span>  lua_setglobal(L, <span class="org-string">"newproxy"</span>);  <span class="org-comment-delimiter">/* </span><span class="org-comment">set global `newproxy'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">645: </span>}
<span class="linenr">646: </span>
<span class="linenr">647: </span>
<span class="linenr">648: </span>LUALIB_API <span class="org-type">int</span> <span class="org-function-name">luaopen_base</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">649: </span>  base_open(L);
<span class="linenr">650: </span>  luaL_register(L, LUA_COLIBNAME, co_funcs);
<span class="linenr">651: </span>  <span class="org-keyword">return</span> 2;
<span class="linenr">652: </span>}
</pre>
</div>

<p>
line 628 629 在全局表中添加 _G，指向全局表自身。
</p>

<p>
line 631 <code>luaL_register(L, "_G", base_funcs);</code> 将全局函数注册到 _G 中。
</p>

<p>
在注册过程中，在 REGISTRY 表中使用 _LOADED 记录相应注册的项，避免注册时出现重复冲突。
同时将相应的注册项添加到全局表中。
</p>

<p>
最终全部模块注册后，REGISTRY 表的内容大致如下，其中 _LOADED.<sub>G</sub> 引用的正是全局表，
</p>

<div class="org-src-container">
<pre class="src src-lua">registry = {
   _LOADED = {
      <span class="org-builtin">_G</span> = {
         <span class="org-builtin">_G</span> = {
            <span class="org-comment-delimiter">-- </span><span class="org-comment">...</span>
         },
         <span class="org-builtin">assert</span> = ...,
         <span class="org-builtin">dofile</span> = ...,
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         <span class="org-builtin">coroutine</span> = {
            <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
            <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         },
         <span class="org-builtin">math</span> = {
            <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
            <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         },
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
      },
      <span class="org-builtin">coroutine</span> = {
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
      },
      <span class="org-builtin">math</span> = {
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
         <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
      },
      <span class="org-comment-delimiter">--</span><span class="org-comment">...</span>
   }
}
</pre>
</div>

<p>
可通过
</p>

<pre class="example" id="org1084ae0">
$ make -s registry
</pre>

<p>
来查看更具体的 REGISTRY 内容。
</p>
</div>
</div>

<div id="outline-container-org27016fb" class="outline-2">
<h2 id="org27016fb"><span class="section-number-2">2</span> module</h2>
<div class="outline-text-2" id="text-2">
<p>
base 模块注册了所有基础全局函数，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">447: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> <span class="org-variable-name">base_funcs</span>[] = {
<span class="linenr">448: </span>  {<span class="org-string">"assert"</span>, luaB_assert},
<span class="linenr">449: </span>  {<span class="org-string">"collectgarbage"</span>, luaB_collectgarbage},
<span class="linenr">450: </span>  {<span class="org-string">"dofile"</span>, luaB_dofile},
<span class="linenr">451: </span>  {<span class="org-string">"error"</span>, luaB_error},
<span class="linenr">452: </span>  {<span class="org-string">"gcinfo"</span>, luaB_gcinfo},
<span class="linenr">453: </span>  {<span class="org-string">"getfenv"</span>, luaB_getfenv},
<span class="linenr">454: </span>  {<span class="org-string">"getmetatable"</span>, luaB_getmetatable},
<span class="linenr">455: </span>  {<span class="org-string">"loadfile"</span>, luaB_loadfile},
<span class="linenr">456: </span>  {<span class="org-string">"load"</span>, luaB_load},
<span class="linenr">457: </span>  {<span class="org-string">"loadstring"</span>, luaB_loadstring},
<span class="linenr">458: </span>  {<span class="org-string">"next"</span>, luaB_next},
<span class="linenr">459: </span>  {<span class="org-string">"pcall"</span>, luaB_pcall},
<span class="linenr">460: </span>  {<span class="org-string">"print"</span>, luaB_print},
<span class="linenr">461: </span>  {<span class="org-string">"rawequal"</span>, luaB_rawequal},
<span class="linenr">462: </span>  {<span class="org-string">"rawget"</span>, luaB_rawget},
<span class="linenr">463: </span>  {<span class="org-string">"rawset"</span>, luaB_rawset},
<span class="linenr">464: </span>  {<span class="org-string">"select"</span>, luaB_select},
<span class="linenr">465: </span>  {<span class="org-string">"setfenv"</span>, luaB_setfenv},
<span class="linenr">466: </span>  {<span class="org-string">"setmetatable"</span>, luaB_setmetatable},
<span class="linenr">467: </span>  {<span class="org-string">"tonumber"</span>, luaB_tonumber},
<span class="linenr">468: </span>  {<span class="org-string">"tostring"</span>, luaB_tostring},
<span class="linenr">469: </span>  {<span class="org-string">"type"</span>, luaB_type},
<span class="linenr">470: </span>  {<span class="org-string">"unpack"</span>, luaB_unpack},
<span class="linenr">471: </span>  {<span class="org-string">"xpcall"</span>, luaB_xpcall},
<span class="linenr">472: </span>  {<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>}
<span class="linenr">473: </span>};
</pre>
</div>

<p>
其中每个函数都对应一个 C 函数实现，函数使用 api 接口与 Lua 进行数据交互，
然后将函数注册到 Lua 的全局表中，在运行 Lua 代码时就可以平滑调用。
正如 api 章节所述，这即是 api 在内部实现发挥的作用。
</p>

<p>
其它模块的注册过程与之类似，读者可结合官方文档<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>针对相应的方法进行了解。
</p>
</div>
</div>

<div id="outline-container-org67c8d46" class="outline-2">
<h2 id="org67c8d46"><span class="section-number-2">3</span> coroutine</h2>
<div class="outline-text-2" id="text-3">
<p>
一个出人意料的点在于，协程是用 api 来实现的，而不是内建在 vm 中。
</p>

<p>
coroutine 模块一并在 baselib 中注册，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">605: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> <span class="org-variable-name">co_funcs</span>[] = {
<span class="linenr">606: </span>  {<span class="org-string">"create"</span>, luaB_cocreate},
<span class="linenr">607: </span>  {<span class="org-string">"resume"</span>, luaB_coresume},
<span class="linenr">608: </span>  {<span class="org-string">"running"</span>, luaB_corunning},
<span class="linenr">609: </span>  {<span class="org-string">"status"</span>, luaB_costatus},
<span class="linenr">610: </span>  {<span class="org-string">"wrap"</span>, luaB_cowrap},
<span class="linenr">611: </span>  {<span class="org-string">"yield"</span>, luaB_yield},
<span class="linenr">612: </span>  {<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>}
<span class="linenr">613: </span>};
</pre>
</div>

<p>
其中的方法，正是在 lua 代码中使用的 coroutine.* 方法。
</p>
</div>

<div id="outline-container-orgbecc05e" class="outline-3">
<h3 id="orgbecc05e"><span class="section-number-3">3.1</span> create</h3>
<div class="outline-text-3" id="text-3-1">
<p>
至此，我们已经了解了 8 种基础类型的 7 种，余下的 thread 类型，正是协程。
而并不意外的，协程本身正是 <code>lua_State</code> 。
</p>

<p>
<code>lua_State</code> 记录了所有 lua 代码运行时的状态，协程可理解为是 vm 另外运行的一块 lua 代码，
所以用 <code>lua_State</code> 来表示。
</p>

<p>
从操作系统层面而言，lua 解释器是一个单线程程序。
lua 实现的协程，虽然在内部声明类型为 thread，但是本质上，
只是多个不同的 <code>lua_State</code> 交替控制权在轮换执行。
</p>

<p>
也就是说，协程是异步并发的，而不是并行的。
</p>


<div id="orgcb1a716" class="figure">
<p><img src="stdlib-thread.png" alt="stdlib-thread.png">
</p>
</div>

<p>
lua 内部默认存在“主线程” main thread，就是多次出现在代码中的 <code>lua_State *L</code> 。
</p>

<p>
主线程可创建出新的协程并通过 resume 执行，此时主线程失去控制权；
协程通过 yield 放弃控制权，回到主线程调用时；
主线程可通过 resume 重新进入协程的中断点，继续执行。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">576: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">luaB_cocreate</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">577: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">NL</span> = lua_newthread(L);
<span class="linenr">578: </span>  luaL_argcheck(L, lua_isfunction(L, 1) &amp;&amp; <span class="org-negation-char">!</span>lua_iscfunction(L, 1), 1,
<span class="linenr">579: </span>    <span class="org-string">"Lua function expected"</span>);
<span class="linenr">580: </span>  lua_pushvalue(L, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">move function to top</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">581: </span>  lua_xmove(L, NL, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">move function from L to NL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">582: </span>  <span class="org-keyword">return</span> 1;
<span class="linenr">583: </span>}
</pre>
</div>


<div id="orgf14748c" class="figure">
<p><img src="stdlib-create.png" alt="stdlib-create.png">
</p>
</div>

<p>
lua 内部通过 coroutine.create(f) 来创建协程，在主线程 L 的栈底即存在 <code>luaB_cocreate</code> 和 f，
通过 <code>lua_newthead</code> 创建协程 NL（即 <code>lua_State</code> ）并入栈，再将 f 复制到栈顶，
并通过 xmove 移动到 NL 的栈中，作为起始调用函数，最终返回 NL。
</p>

<p>
<code>lua_newthead</code> 最终调用了 <code>luaE_newthread</code> ，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>lstate.c</label><pre class="src src-C"><span class="linenr">119: </span><span class="org-type">lua_State</span> *<span class="org-function-name">luaE_newthread</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">120: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">L1</span> = tostate(luaM_malloc(L, state_size(lua_State)));
<span class="linenr">121: </span>  luaC_link(L, obj2gco(L1), LUA_TTHREAD);
<span class="linenr">122: </span>  preinit_state(L1, G(L));
<span class="linenr">123: </span>  stack_init(L1, L);  <span class="org-comment-delimiter">/* </span><span class="org-comment">init stack</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">124: </span>  setobj2n(L, gt(L1), gt(L));  <span class="org-comment-delimiter">/* </span><span class="org-comment">share table of globals</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">125: </span>  L1-&gt;hookmask = L-&gt;hookmask;
<span class="linenr">126: </span>  L1-&gt;basehookcount = L-&gt;basehookcount;
<span class="linenr">127: </span>  L1-&gt;hook = L-&gt;hook;
<span class="linenr">128: </span>  resethookcount(L1);
<span class="linenr">129: </span>  lua_assert(iswhite(obj2gco(L1)));
<span class="linenr">130: </span>  <span class="org-keyword">return</span> L1;
<span class="linenr">131: </span>}
</pre>
</div>

<p>
在 line 124 表明，协程是共享全局表的，即在协程中修改全局变量是相互影响的。
</p>
</div>
</div>

<div id="outline-container-orgcfcc444" class="outline-3">
<h3 id="orgcfcc444"><span class="section-number-3">3.2</span> resume &amp; yield</h3>
<div class="outline-text-3" id="text-3-2">
<p>
resume 函数开始执行/恢复协程的运行，第一个参数为协程本身，后续参数为传递入协程的参数，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">518: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">auxresume</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">lua_State</span> *<span class="org-variable-name">co</span>, <span class="org-type">int</span> <span class="org-variable-name">narg</span>) {
<span class="linenr">519: </span>  <span class="org-type">int</span> <span class="org-variable-name">status</span> = costatus(L, co);
<span class="linenr">520: </span>  <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>lua_checkstack(co, narg))
<span class="linenr">521: </span>    luaL_error(L, <span class="org-string">"too many arguments to resume"</span>);
<span class="linenr">522: </span>  <span class="org-keyword">if</span> (status != CO_SUS) {
<span class="linenr">523: </span>    lua_pushfstring(L, <span class="org-string">"cannot resume %s coroutine"</span>, statnames[status]);
<span class="linenr">524: </span>    <span class="org-keyword">return</span> -1;  <span class="org-comment-delimiter">/* </span><span class="org-comment">error flag</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">525: </span>  }
<span class="linenr">526: </span>  lua_xmove(L, co, narg);
<span class="linenr">527: </span>  lua_setlevel(L, co);
<span class="linenr">528: </span>  status = lua_resume(co, narg);
<span class="linenr">529: </span>  <span class="org-keyword">if</span> (status == 0 || status == LUA_YIELD) {
<span class="linenr">530: </span>    <span class="org-type">int</span> <span class="org-variable-name">nres</span> = lua_gettop(co);
<span class="linenr">531: </span>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>lua_checkstack(L, nres + 1))
<span class="linenr">532: </span>      luaL_error(L, <span class="org-string">"too many results to resume"</span>);
<span class="linenr">533: </span>    lua_xmove(co, L, nres);  <span class="org-comment-delimiter">/* </span><span class="org-comment">move yielded values</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">534: </span>    <span class="org-keyword">return</span> nres;
<span class="linenr">535: </span>  }
<span class="linenr">536: </span>  <span class="org-keyword">else</span> {
<span class="linenr">537: </span>    lua_xmove(co, L, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">move error message</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">538: </span>    <span class="org-keyword">return</span> -1;  <span class="org-comment-delimiter">/* </span><span class="org-comment">error flag</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">539: </span>  }
<span class="linenr">540: </span>}
<span class="linenr">541: </span>
<span class="linenr">542: </span>
<span class="linenr">543: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">luaB_coresume</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">544: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">co</span> = lua_tothread(L, 1);
<span class="linenr">545: </span>  <span class="org-type">int</span> <span class="org-variable-name">r</span>;
<span class="linenr">546: </span>  luaL_argcheck(L, co, 1, <span class="org-string">"coroutine expected"</span>);
<span class="linenr">547: </span>  r = auxresume(L, co, lua_gettop(L) - 1);
<span class="linenr">548: </span>  <span class="org-keyword">if</span> (r &lt; 0) {
<span class="linenr">549: </span>    lua_pushboolean(L, 0);
<span class="linenr">550: </span>    lua_insert(L, -2);
<span class="linenr">551: </span>    <span class="org-keyword">return</span> 2;  <span class="org-comment-delimiter">/* </span><span class="org-comment">return false + error message</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">552: </span>  }
<span class="linenr">553: </span>  <span class="org-keyword">else</span> {
<span class="linenr">554: </span>    lua_pushboolean(L, 1);
<span class="linenr">555: </span>    lua_insert(L, -(r + 1));
<span class="linenr">556: </span>    <span class="org-keyword">return</span> r + 1;  <span class="org-comment-delimiter">/* </span><span class="org-comment">return true + `resume' returns</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">557: </span>  }
<span class="linenr">558: </span>}
</pre>
</div>

<p>
line 544 先找到协程，
line 526 再通过 xmove 将参数传递到相应的栈中，
line 528 恢复其执行，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>ldo.c</label><pre class="src src-C"><span class="linenr">418: </span>LUA_API <span class="org-type">int</span> <span class="org-function-name">lua_resume</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">int</span> <span class="org-variable-name">nargs</span>) {
<span class="linenr">419: </span>  <span class="org-type">int</span> <span class="org-variable-name">status</span>;
<span class="linenr">420: </span>  lua_lock(L);
<span class="linenr">421: </span>  <span class="org-keyword">if</span> (L-&gt;status != LUA_YIELD &amp;&amp; (L-&gt;status != 0 || L-&gt;ci != L-&gt;base_ci))
<span class="linenr">422: </span>      <span class="org-keyword">return</span> resume_error(L, <span class="org-string">"cannot resume non-suspended coroutine"</span>);
<span class="linenr">423: </span>  <span class="org-keyword">if</span> (L-&gt;nCcalls &gt;= LUAI_MAXCCALLS)
<span class="linenr">424: </span>    <span class="org-keyword">return</span> resume_error(L, <span class="org-string">"C stack overflow"</span>);
<span class="linenr">425: </span>  luai_userstateresume(L, nargs);
<span class="linenr">426: </span>  lua_assert(L-&gt;errfunc == 0);
<span class="linenr">427: </span>  L-&gt;baseCcalls = ++L-&gt;nCcalls;
<span class="linenr">428: </span>  status = luaD_rawrunprotected(L, resume, L-&gt;top - nargs);
<span class="linenr">429: </span>  <span class="org-keyword">if</span> (status != 0) {  <span class="org-comment-delimiter">/* </span><span class="org-comment">error?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">430: </span>    L-&gt;status = cast_byte(status);  <span class="org-comment-delimiter">/* </span><span class="org-comment">mark thread as `dead'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">431: </span>    luaD_seterrorobj(L, status, L-&gt;top);
<span class="linenr">432: </span>    L-&gt;ci-&gt;top = L-&gt;top;
<span class="linenr">433: </span>  }
<span class="linenr">434: </span>  <span class="org-keyword">else</span> {
<span class="linenr">435: </span>    lua_assert(L-&gt;nCcalls == L-&gt;baseCcalls);
<span class="linenr">436: </span>    status = L-&gt;status;
<span class="linenr">437: </span>  }
<span class="linenr">438: </span>  --L-&gt;nCcalls;
<span class="linenr">439: </span>  lua_unlock(L);
<span class="linenr">440: </span>  <span class="org-keyword">return</span> status;
<span class="linenr">441: </span>}
</pre>
</div>

<p>
执行协程之后，最终返回其状态值。
</p>

<p>
line 529 判断状态为 yield 时，回收其栈上的返回值，通过 xmove 移动到 L 中。
</p>

<p>
与之相配合的，yield 函数则直接准备参数数量，重置 <code>lua_State</code> 的状态为 yield 即可。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">593: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">luaB_yield</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">594: </span>  <span class="org-keyword">return</span> lua_yield(L, lua_gettop(L));
<span class="linenr">595: </span>}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>ldo.c</label><pre class="src src-C"><span class="linenr">444: </span>LUA_API <span class="org-type">int</span> <span class="org-function-name">lua_yield</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">int</span> <span class="org-variable-name">nresults</span>) {
<span class="linenr">445: </span>  luai_userstateyield(L, nresults);
<span class="linenr">446: </span>  lua_lock(L);
<span class="linenr">447: </span>  <span class="org-keyword">if</span> (L-&gt;nCcalls &gt; L-&gt;baseCcalls)
<span class="linenr">448: </span>    luaG_runerror(L, <span class="org-string">"attempt to yield across metamethod/C-call boundary"</span>);
<span class="linenr">449: </span>  L-&gt;base = L-&gt;top - nresults;  <span class="org-comment-delimiter">/* </span><span class="org-comment">protect stack slots below</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">450: </span>  L-&gt;status = LUA_YIELD;
<span class="linenr">451: </span>  lua_unlock(L);
<span class="linenr">452: </span>  <span class="org-keyword">return</span> -1;
<span class="linenr">453: </span>}
</pre>
</div>

<p>
比如如下示例代码，
</p>

<div class="org-src-container">
<pre class="src src-lua"><span class="org-keyword">local</span> <span class="org-variable-name">co</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>(<span class="org-variable-name">a</span>, <span class="org-variable-name">b</span>, <span class="org-variable-name">c</span>)
      <span class="org-keyword">local</span> <span class="org-variable-name">d</span>, <span class="org-variable-name">e</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">yield</span>(a + b + c)
      <span class="org-keyword">return</span> d + e
      <span class="org-keyword">end</span>)

<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co, 1, 2, 3))
<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co, 4, 5))
<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co))
</pre>
</div>

<pre class="example">
true	6
true	9
false	cannot resume dead coroutine
</pre>


<p>
第一次 resume 时，将参数传递入 NL，
</p>


<div id="org1dafad9" class="figure">
<p><img src="stdlib-resume.png" alt="stdlib-resume.png">
</p>
</div>

<p>
协程内部执行 yield，返回状态 <code>LUA_YIELD</code> ，resume 通过 xmove 将结果从栈回收至 L，
最终 resume 自己压栈 bool 值 true 并 insert 所有返回值，作为调用 resume 的返回值。
</p>


<div id="org5f00664" class="figure">
<p><img src="stdlib-resume-return.png" alt="stdlib-resume-return.png">
</p>
</div>

<p>
第二次调用 resume 时，传递参数 4 5，在协程内部，从中断的地方继续执行，
4 5 作为 yield 调用的返回值，赋值与 d e。
</p>


<div id="org6b9687f" class="figure">
<p><img src="stdlib-resume-2.png" alt="stdlib-resume-2.png">
</p>
</div>

<p>
最终协程内部 return 执行结束，resume 执行相同的过程，回收栈上的返回值。
</p>


<div id="org18a5097" class="figure">
<p><img src="stdlib-resume-return-2.png" alt="stdlib-resume-return-2.png">
</p>
</div>
</div>
</div>

<div id="outline-container-orgc6a2816" class="outline-3">
<h3 id="orgc6a2816"><span class="section-number-3">3.3</span> status</h3>
<div class="outline-text-3" id="text-3-3">
<p>
在 lua.h 中，定义线程状态有如下几种，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>lua.h</label><pre class="src src-C"><span class="linenr">42: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">thread status; 0 is OK</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">43: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_YIELD</span>       1
<span class="linenr">44: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_ERRRUN</span>      2
<span class="linenr">45: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_ERRSYNTAX</span>   3
<span class="linenr">46: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_ERRMEM</span>      4
<span class="linenr">47: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_ERRERR</span>      5
</pre>
</div>

<p>
在线程运行没有出错的情况下，对协程状态的检测会更加细致，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>lbaselib.c</label><pre class="src src-C"><span class="linenr">482: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">CO_RUN</span>  0       <span class="org-comment-delimiter">/* </span><span class="org-comment">running</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">483: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">CO_SUS</span>  1       <span class="org-comment-delimiter">/* </span><span class="org-comment">suspended</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">484: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">CO_NOR</span>  2       <span class="org-comment-delimiter">/* </span><span class="org-comment">'normal' (it resumed another coroutine)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">485: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">CO_DEAD</span> 3
<span class="linenr">486: </span>
<span class="linenr">487: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-keyword">const</span> <span class="org-variable-name">statnames</span>[] =
<span class="linenr">488: </span>    {<span class="org-string">"running"</span>, <span class="org-string">"suspended"</span>, <span class="org-string">"normal"</span>, <span class="org-string">"dead"</span>};
<span class="linenr">489: </span>
<span class="linenr">490: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">costatus</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">lua_State</span> *<span class="org-variable-name">co</span>) {
<span class="linenr">491: </span>  <span class="org-keyword">if</span> (L == co) <span class="org-keyword">return</span> CO_RUN;
<span class="linenr">492: </span>  <span class="org-keyword">switch</span> (lua_status(co)) {
<span class="linenr">493: </span>    <span class="org-keyword">case</span> LUA_YIELD:
<span class="linenr">494: </span>      <span class="org-keyword">return</span> CO_SUS;
<span class="linenr">495: </span>    <span class="org-keyword">case</span> 0: {
<span class="linenr">496: </span>      <span class="org-type">lua_Debug</span> <span class="org-variable-name">ar</span>;
<span class="linenr">497: </span>      <span class="org-keyword">if</span> (lua_getstack(co, 0, &amp;ar) &gt; 0)  <span class="org-comment-delimiter">/* </span><span class="org-comment">does it have frames?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">498: </span>        <span class="org-keyword">return</span> CO_NOR;  <span class="org-comment-delimiter">/* </span><span class="org-comment">it is running</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">499: </span>      <span class="org-keyword">else</span> <span class="org-keyword">if</span> (lua_gettop(co) == 0)
<span class="linenr">500: </span>          <span class="org-keyword">return</span> CO_DEAD;
<span class="linenr">501: </span>      <span class="org-keyword">else</span>
<span class="linenr">502: </span>        <span class="org-keyword">return</span> CO_SUS;  <span class="org-comment-delimiter">/* </span><span class="org-comment">initial state</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">503: </span>    }
<span class="linenr">504: </span>    <span class="org-keyword">default</span>:  <span class="org-comment-delimiter">/* </span><span class="org-comment">some error occured</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">505: </span>      <span class="org-keyword">return</span> CO_DEAD;
<span class="linenr">506: </span>  }
<span class="linenr">507: </span>}
<span class="linenr">508: </span>
<span class="linenr">509: </span>
<span class="linenr">510: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">luaB_costatus</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">511: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">co</span> = lua_tothread(L, 1);
<span class="linenr">512: </span>  luaL_argcheck(L, co, 1, <span class="org-string">"coroutine expected"</span>);
<span class="linenr">513: </span>  lua_pushstring(L, statnames[costatus(L, co)]);
<span class="linenr">514: </span>  <span class="org-keyword">return</span> 1;
<span class="linenr">515: </span>}
</pre>
</div>

<p>
在调用 <code>luaB_costatus</code> 时要明确一点，正在调用的线程，正是拥有控制权而正在运行的线程。
</p>


<p>
<code>CO_RUN</code> 状态，对应于协程自身检测自身的状态，在检测的此刻必然是 running 状态。
</p>

<div class="org-src-container">
<pre class="src src-lua"><span class="org-keyword">local</span> <span class="org-variable-name">co</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>(<span class="org-variable-name">co</span>)
      <span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">status</span>(co))
<span class="org-keyword">end</span>)

<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co, co)
</pre>
</div>

<pre class="example">
running
</pre>



<p>
在协程刚刚新建/yield 之后，对应的状态为 <code>CO_SUS</code> 。
</p>

<div class="org-src-container">
<pre class="src src-lua"><span class="org-keyword">local</span> <span class="org-variable-name">co</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>()
      <span class="org-builtin">coroutine</span>.<span class="org-builtin">yield</span>()
<span class="org-keyword">end</span>)

<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">status</span>(co))
<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co)
<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">status</span>(co))
</pre>
</div>

<pre class="example">
suspended
suspended
</pre>


<p>
如果协程本身 resume 了其它协程，此刻检测其状态，对应 <code>CO_NOR</code> 。
</p>

<div class="org-src-container">
<pre class="src src-lua"><span class="org-keyword">local</span> <span class="org-variable-name">co</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>(<span class="org-variable-name">co</span>)
      <span class="org-keyword">local</span> <span class="org-variable-name">a</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>()
            <span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">status</span>(co))
      <span class="org-keyword">end</span>)

      <span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(a)
<span class="org-keyword">end</span>)

<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co, co)
</pre>
</div>

<pre class="example">
normal
</pre>


<p>
当协程执行结束/运行出错，状态都为 <code>CO_DEAD</code> 。
</p>

<div class="org-src-container">
<pre class="src src-lua"><span class="org-keyword">local</span> <span class="org-variable-name">co</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(<span class="org-keyword">function</span>()
      <span class="org-builtin">coroutine</span>.<span class="org-builtin">yield</span>()
<span class="org-keyword">end</span>)

<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co)
<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co)
<span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(co)

<span class="org-builtin">print</span>(<span class="org-builtin">coroutine</span>.<span class="org-builtin">status</span>(co))
</pre>
</div>

<pre class="example">
dead
</pre>


<p>
需要注意的是，主线程是无法检测状态的，因为在 lua 代码层面根本没有相应的变量来对应其 <code>lua_State</code> 。
</p>
</div>
</div>
</div>


<div id="outline-container-orgebde426" class="outline-2">
<h2 id="orgebde426"><span class="section-number-2">4</span> debug</h2>
<div class="outline-text-2" id="text-4">
<p>
标准库提供了 debug 库，在 lua 语言层面提供了接口，用于自省和设置钩子。
</p>

<p>
debug 库内部的实现可以印证之前所有的描述，这一章就来了解下 debug 库的相关实现。
</p>
</div>

<div id="outline-container-org3cb7d10" class="outline-3">
<h3 id="org3cb7d10"><span class="section-number-3">4.1</span> getinfo</h3>
<div class="outline-text-3" id="text-4-1">
<p>
debug 库提供了如下函数，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>ldblib.c</label><pre class="src src-C"><span class="linenr">375: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">luaL_Reg</span> <span class="org-variable-name">dblib</span>[] = {
<span class="linenr">376: </span>  {<span class="org-string">"debug"</span>, db_debug},
<span class="linenr">377: </span>  {<span class="org-string">"getfenv"</span>, db_getfenv},
<span class="linenr">378: </span>  {<span class="org-string">"gethook"</span>, db_gethook},
<span class="linenr">379: </span>  {<span class="org-string">"getinfo"</span>, db_getinfo},
<span class="linenr">380: </span>  {<span class="org-string">"getlocal"</span>, db_getlocal},
<span class="linenr">381: </span>  {<span class="org-string">"getregistry"</span>, db_getregistry},
<span class="linenr">382: </span>  {<span class="org-string">"getmetatable"</span>, db_getmetatable},
<span class="linenr">383: </span>  {<span class="org-string">"getupvalue"</span>, db_getupvalue},
<span class="linenr">384: </span>  {<span class="org-string">"setfenv"</span>, db_setfenv},
<span class="linenr">385: </span>  {<span class="org-string">"sethook"</span>, db_sethook},
<span class="linenr">386: </span>  {<span class="org-string">"setlocal"</span>, db_setlocal},
<span class="linenr">387: </span>  {<span class="org-string">"setmetatable"</span>, db_setmetatable},
<span class="linenr">388: </span>  {<span class="org-string">"setupvalue"</span>, db_setupvalue},
<span class="linenr">389: </span>  {<span class="org-string">"traceback"</span>, db_errorfb},
<span class="linenr">390: </span>  {<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>}
<span class="linenr">391: </span>};
</pre>
</div>

<p>
getinfo 用于运行时自省，可以得到很多运行时的信息。
</p>

<p>
根据官方文档<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>的描述，参数 thread 和 what 是可选的。
</p>

<pre class="example" id="org386f5a6">
debug.getinfo ([thread,] function [, what])
</pre>

<p>
在实现中，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>ldblib.c</label><pre class="src src-C"><span class="linenr">76: </span><span class="org-keyword">static</span> <span class="org-type">lua_State</span> *<span class="org-function-name">getthread</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">int</span> *<span class="org-variable-name">arg</span>) {
<span class="linenr">77: </span>  <span class="org-keyword">if</span> (lua_isthread(L, 1)) {
<span class="linenr">78: </span>    *arg = 1;
<span class="linenr">79: </span>    <span class="org-keyword">return</span> lua_tothread(L, 1);
<span class="linenr">80: </span>  }
<span class="linenr">81: </span>  <span class="org-keyword">else</span> {
<span class="linenr">82: </span>    *arg = 0;
<span class="linenr">83: </span>    <span class="org-keyword">return</span> L;
<span class="linenr">84: </span>  }
<span class="linenr">85: </span>}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>ldblib.c</label><pre class="src src-C"><span class="linenr"> 99: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">db_getinfo</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">100: </span>  <span class="org-type">lua_Debug</span> <span class="org-variable-name">ar</span>;
<span class="linenr">101: </span>  <span class="org-type">int</span> <span class="org-variable-name">arg</span>;
<span class="linenr">102: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">L1</span> = getthread(L, &amp;arg);
<span class="linenr">103: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">options</span> = luaL_optstring(L, arg+2, <span class="org-string">"flnSu"</span>);
<span class="linenr">104: </span>  <span class="org-keyword">if</span> (lua_isnumber(L, arg+1)) {
<span class="linenr">105: </span>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>lua_getstack(L1, (<span class="org-type">int</span>)lua_tointeger(L, arg+1), &amp;ar)) {
<span class="linenr">106: </span>      lua_pushnil(L);  <span class="org-comment-delimiter">/* </span><span class="org-comment">level out of range</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">107: </span>      <span class="org-keyword">return</span> 1;
<span class="linenr">108: </span>    }
<span class="linenr">109: </span>  }
<span class="linenr">110: </span>  <span class="org-keyword">else</span> <span class="org-keyword">if</span> (lua_isfunction(L, arg+1)) {
<span class="linenr">111: </span>    lua_pushfstring(L, <span class="org-string">"&gt;%s"</span>, options);
<span class="linenr">112: </span>    options = lua_tostring(L, -1);
<span class="linenr">113: </span>    lua_pushvalue(L, arg+1);
<span class="linenr">114: </span>    lua_xmove(L, L1, 1);
<span class="linenr">115: </span>  }
<span class="linenr">116: </span>  <span class="org-keyword">else</span>
<span class="linenr">117: </span>    <span class="org-keyword">return</span> luaL_argerror(L, arg+1, <span class="org-string">"function or level expected"</span>);
<span class="linenr">118: </span>  <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>lua_getinfo(L1, options, &amp;ar))
<span class="linenr">119: </span>    <span class="org-keyword">return</span> luaL_argerror(L, arg+2, <span class="org-string">"invalid option"</span>);
<span class="linenr">120: </span>  lua_createtable(L, 0, 2);
<span class="linenr">121: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'S'</span>)) {
<span class="linenr">122: </span>    settabss(L, <span class="org-string">"source"</span>, ar.source);
<span class="linenr">123: </span>    settabss(L, <span class="org-string">"short_src"</span>, ar.short_src);
<span class="linenr">124: </span>    settabsi(L, <span class="org-string">"linedefined"</span>, ar.linedefined);
<span class="linenr">125: </span>    settabsi(L, <span class="org-string">"lastlinedefined"</span>, ar.lastlinedefined);
<span class="linenr">126: </span>    settabss(L, <span class="org-string">"what"</span>, ar.what);
<span class="linenr">127: </span>  }
<span class="linenr">128: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'l'</span>))
<span class="linenr">129: </span>    settabsi(L, <span class="org-string">"currentline"</span>, ar.currentline);
<span class="linenr">130: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'u'</span>))
<span class="linenr">131: </span>    settabsi(L, <span class="org-string">"nups"</span>, ar.nups);
<span class="linenr">132: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'n'</span>)) {
<span class="linenr">133: </span>    settabss(L, <span class="org-string">"name"</span>, ar.name);
<span class="linenr">134: </span>    settabss(L, <span class="org-string">"namewhat"</span>, ar.namewhat);
<span class="linenr">135: </span>  }
<span class="linenr">136: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'L'</span>))
<span class="linenr">137: </span>    treatstackoption(L, L1, <span class="org-string">"activelines"</span>);
<span class="linenr">138: </span>  <span class="org-keyword">if</span> (strchr(options, <span class="org-string">'f'</span>))
<span class="linenr">139: </span>    treatstackoption(L, L1, <span class="org-string">"func"</span>);
<span class="linenr">140: </span>  <span class="org-keyword">return</span> 1;  <span class="org-comment-delimiter">/* </span><span class="org-comment">return table</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">141: </span>}
</pre>
</div>

<p>
如果没有 thread，则从当前线程获取信息；如果没有 what，默认为 "flnSu"。
</p>

<p>
在 line 118 调用 <code>lua_getinfo</code> 来获取信息。
</p>

<p>
其中根据需要获取的信息的缩写，将所有信息存储到 <code>lua_Debug</code> 结构中返回。
不同的缩写对应不同的字段。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>lua.h</label><pre class="src src-C"><span class="linenr">346: </span><span class="org-keyword">struct</span> <span class="org-type">lua_Debug</span> {
<span class="linenr">347: </span>  <span class="org-type">int</span> <span class="org-variable-name">event</span>;
<span class="linenr">348: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">(n)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">349: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">namewhat</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">(n) `global', `local', `field', `method'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">350: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">what</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">(S) `Lua', `C', `main', `tail'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">351: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">source</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">(S)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">352: </span>  <span class="org-type">int</span> <span class="org-variable-name">currentline</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">(l)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">353: </span>  <span class="org-type">int</span> <span class="org-variable-name">nups</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">(u) number of upvalues</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">354: </span>  <span class="org-type">int</span> <span class="org-variable-name">linedefined</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">(S)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">355: </span>  <span class="org-type">int</span> <span class="org-variable-name">lastlinedefined</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">(S)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">356: </span>  <span class="org-type">char</span> <span class="org-variable-name">short_src</span>[LUA_IDSIZE]; <span class="org-comment-delimiter">/* </span><span class="org-comment">(S)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">357: </span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">private part</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">358: </span>  <span class="org-type">int</span> <span class="org-variable-name">i_ci</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">active function</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">359: </span>};
</pre>
</div>

<p>
在 <code>lua_getinfo</code> 内部，就是分别获取不同信息再整合到 <code>lua_Debug</code> 的过程。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>ldebug.c</label><pre class="src src-C"><span class="linenr">193: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">auxgetinfo</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">what</span>, <span class="org-type">lua_Debug</span> *<span class="org-variable-name">ar</span>,
<span class="linenr">194: </span>                    <span class="org-type">Closure</span> *<span class="org-variable-name">f</span>, <span class="org-type">CallInfo</span> *<span class="org-variable-name">ci</span>) {
<span class="linenr">195: </span>  <span class="org-type">int</span> <span class="org-variable-name">status</span> = 1;
<span class="linenr">196: </span>  <span class="org-keyword">if</span> (f == <span class="org-constant">NULL</span>) {
<span class="linenr">197: </span>    info_tailcall(ar);
<span class="linenr">198: </span>    <span class="org-keyword">return</span> status;
<span class="linenr">199: </span>  }
<span class="linenr">200: </span>  <span class="org-keyword">for</span> (; *what; what++) {
<span class="linenr">201: </span>    <span class="org-keyword">switch</span> (*what) {
<span class="linenr">202: </span>      <span class="org-keyword">case</span> <span class="org-string">'S'</span>: {
<span class="linenr">203: </span>        funcinfo(ar, f);
<span class="linenr">204: </span>        <span class="org-keyword">break</span>;
<span class="linenr">205: </span>      }
<span class="linenr">206: </span>      <span class="org-keyword">case</span> <span class="org-string">'l'</span>: {
<span class="linenr">207: </span>        ar-&gt;currentline = (ci) ? currentline(L, ci) : -1;
<span class="linenr">208: </span>        <span class="org-keyword">break</span>;
<span class="linenr">209: </span>      }
<span class="linenr">210: </span>      <span class="org-keyword">case</span> <span class="org-string">'u'</span>: {
<span class="linenr">211: </span>        ar-&gt;nups = f-&gt;c.nupvalues;
<span class="linenr">212: </span>        <span class="org-keyword">break</span>;
<span class="linenr">213: </span>      }
<span class="linenr">214: </span>      <span class="org-keyword">case</span> <span class="org-string">'n'</span>: {
<span class="linenr">215: </span>        ar-&gt;namewhat = (ci) ? getfuncname(L, ci, &amp;ar-&gt;name) : <span class="org-constant">NULL</span>;
<span class="linenr">216: </span>        <span class="org-keyword">if</span> (ar-&gt;namewhat == <span class="org-constant">NULL</span>) {
<span class="linenr">217: </span>          ar-&gt;namewhat = <span class="org-string">""</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">not found</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">218: </span>          ar-&gt;name = <span class="org-constant">NULL</span>;
<span class="linenr">219: </span>        }
<span class="linenr">220: </span>        <span class="org-keyword">break</span>;
<span class="linenr">221: </span>      }
<span class="linenr">222: </span>      <span class="org-keyword">case</span> <span class="org-string">'L'</span>:
<span class="linenr">223: </span>      <span class="org-keyword">case</span> <span class="org-string">'f'</span>:  <span class="org-comment-delimiter">/* </span><span class="org-comment">handled by lua_getinfo</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">224: </span>        <span class="org-keyword">break</span>;
<span class="linenr">225: </span>      <span class="org-keyword">default</span>: status = 0;  <span class="org-comment-delimiter">/* </span><span class="org-comment">invalid option</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">226: </span>    }
<span class="linenr">227: </span>  }
<span class="linenr">228: </span>  <span class="org-keyword">return</span> status;
<span class="linenr">229: </span>}
<span class="linenr">230: </span>
<span class="linenr">231: </span>
<span class="linenr">232: </span>LUA_API <span class="org-type">int</span> <span class="org-function-name">lua_getinfo</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">what</span>, <span class="org-type">lua_Debug</span> *<span class="org-variable-name">ar</span>) {
<span class="linenr">233: </span>  <span class="org-type">int</span> <span class="org-variable-name">status</span>;
<span class="linenr">234: </span>  <span class="org-type">Closure</span> *<span class="org-variable-name">f</span> = <span class="org-constant">NULL</span>;
<span class="linenr">235: </span>  <span class="org-type">CallInfo</span> *<span class="org-variable-name">ci</span> = <span class="org-constant">NULL</span>;
<span class="linenr">236: </span>  lua_lock(L);
<span class="linenr">237: </span>  <span class="org-keyword">if</span> (*what == <span class="org-string">'&gt;'</span>) {
<span class="linenr">238: </span>    <span class="org-type">StkId</span> <span class="org-variable-name">func</span> = L-&gt;top - 1;
<span class="linenr">239: </span>    luai_apicheck(L, ttisfunction(func));
<span class="linenr">240: </span>    what++;  <span class="org-comment-delimiter">/* </span><span class="org-comment">skip the '&gt;'</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">241: </span>    f = clvalue(func);
<span class="linenr">242: </span>    L-&gt;top--;  <span class="org-comment-delimiter">/* </span><span class="org-comment">pop function</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">243: </span>  }
<span class="linenr">244: </span>  <span class="org-keyword">else</span> <span class="org-keyword">if</span> (ar-&gt;i_ci != 0) {  <span class="org-comment-delimiter">/* </span><span class="org-comment">no tail call?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">245: </span>    ci = L-&gt;base_ci + ar-&gt;i_ci;
<span class="linenr">246: </span>    lua_assert(ttisfunction(ci-&gt;func));
<span class="linenr">247: </span>    f = clvalue(ci-&gt;func);
<span class="linenr">248: </span>  }
<span class="linenr">249: </span>  status = auxgetinfo(L, what, ar, f, ci);
<span class="linenr">250: </span>  <span class="org-keyword">if</span> (strchr(what, <span class="org-string">'f'</span>)) {
<span class="linenr">251: </span>    <span class="org-keyword">if</span> (f == <span class="org-constant">NULL</span>) setnilvalue(L-&gt;top);
<span class="linenr">252: </span>    <span class="org-keyword">else</span> setclvalue(L, L-&gt;top, f);
<span class="linenr">253: </span>    incr_top(L);
<span class="linenr">254: </span>  }
<span class="linenr">255: </span>  <span class="org-keyword">if</span> (strchr(what, <span class="org-string">'L'</span>))
<span class="linenr">256: </span>    collectvalidlines(L, f);
<span class="linenr">257: </span>  lua_unlock(L);
<span class="linenr">258: </span>  <span class="org-keyword">return</span> status;
<span class="linenr">259: </span>}
</pre>
</div>

<p>
结合官方文档<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>，不难理解 getinfo 的行为。
</p>
</div>
</div>

<div id="outline-container-orgc72fa6d" class="outline-3">
<h3 id="orgc72fa6d"><span class="section-number-3">4.2</span> getlocal</h3>
<div class="outline-text-3" id="text-4-2">
<p>
getlocal 方法，最终深入到 func 模块中的 <code>luaF_getlocalname</code> 函数，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>ldebug.c</label><pre class="src src-C"><span class="linenr">112: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-function-name">findlocal</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">CallInfo</span> *<span class="org-variable-name">ci</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>) {
<span class="linenr">113: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
<span class="linenr">114: </span>  <span class="org-type">Proto</span> *<span class="org-variable-name">fp</span> = getluaproto(ci);
<span class="linenr">115: </span>  <span class="org-keyword">if</span> (fp &amp;&amp; (name = luaF_getlocalname(fp, n, currentpc(L, ci))) != <span class="org-constant">NULL</span>)
<span class="linenr">116: </span>    <span class="org-keyword">return</span> name;  <span class="org-comment-delimiter">/* </span><span class="org-comment">is a local variable in a Lua function</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">117: </span>  <span class="org-keyword">else</span> {
<span class="linenr">118: </span>    <span class="org-type">StkId</span> <span class="org-variable-name">limit</span> = (ci == L-&gt;ci) ? L-&gt;top : (ci+1)-&gt;func;
<span class="linenr">119: </span>    <span class="org-keyword">if</span> (limit - ci-&gt;base &gt;= n &amp;&amp; n &gt; 0)  <span class="org-comment-delimiter">/* </span><span class="org-comment">is 'n' inside 'ci' stack?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">120: </span>      <span class="org-keyword">return</span> <span class="org-string">"(*temporary)"</span>;
<span class="linenr">121: </span>    <span class="org-keyword">else</span>
<span class="linenr">122: </span>      <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;
<span class="linenr">123: </span>  }
<span class="linenr">124: </span>}
<span class="linenr">125: </span>
<span class="linenr">126: </span>
<span class="linenr">127: </span><span class="org-type">LUA_API</span> <span class="org-keyword">const</span> <span class="org-type">char</span> *lua_getlocal (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-keyword">const</span> <span class="org-type">lua_Debug</span> *<span class="org-variable-name">ar</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>) {
<span class="linenr">128: </span>  <span class="org-type">CallInfo</span> *<span class="org-variable-name">ci</span> = L-&gt;base_ci + ar-&gt;i_ci;
<span class="linenr">129: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span> = findlocal(L, ci, n);
<span class="linenr">130: </span>  lua_lock(L);
<span class="linenr">131: </span>  <span class="org-keyword">if</span> (name)
<span class="linenr">132: </span>      luaA_pushobject(L, ci-&gt;base + (n - 1));
<span class="linenr">133: </span>  lua_unlock(L);
<span class="linenr">134: </span>  <span class="org-keyword">return</span> name;
<span class="linenr">135: </span>}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>lfunc.c</label><pre class="src src-C"><span class="linenr">159: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">160: </span><span class="org-comment">** Look for n-th local variable at line `line' in function `func'.</span>
<span class="linenr">161: </span><span class="org-comment">** Returns NULL if not found.</span>
<span class="linenr">162: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">163: </span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-function-name">luaF_getlocalname</span> (<span class="org-keyword">const</span> <span class="org-type">Proto</span> *<span class="org-variable-name">f</span>, <span class="org-type">int</span> <span class="org-variable-name">local_number</span>, <span class="org-type">int</span> <span class="org-variable-name">pc</span>) {
<span class="linenr">164: </span>  <span class="org-type">int</span> <span class="org-variable-name">i</span>;
<span class="linenr">165: </span>  <span class="org-keyword">for</span> (i = 0; i&lt;f-&gt;sizelocvars &amp;&amp; f-&gt;locvars[i].startpc &lt;= pc; i++) {
<span class="linenr">166: </span>    <span class="org-keyword">if</span> (pc &lt; f-&gt;locvars[i].endpc) {  <span class="org-comment-delimiter">/* </span><span class="org-comment">is variable active?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">167: </span>      local_number--;
<span class="linenr">168: </span>      <span class="org-keyword">if</span> (local_number == 0)
<span class="linenr">169: </span>        <span class="org-keyword">return</span> getstr(f-&gt;locvars[i].varname);
<span class="linenr">170: </span>    }
<span class="linenr">171: </span>  }
<span class="linenr">172: </span>  <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">not found</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">173: </span>}
</pre>
</div>

<p>
其中正是通过 <code>f-&gt;locvars</code> 来进行寻找，这和 generator 章节是相同的。
</p>
</div>
</div>

<div id="outline-container-org7320d57" class="outline-3">
<h3 id="org7320d57"><span class="section-number-3">4.3</span> getupval</h3>
<div class="outline-text-3" id="text-4-3">
<p>
getupval 方法，最终调用 api 模块中的 <code>lua_getupvalue</code> 函数，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>lapi.c</label><pre class="src src-C"><span class="linenr">1039: </span><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-function-name">aux_upvalue</span> (<span class="org-type">StkId</span> <span class="org-variable-name">fi</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>, <span class="org-type">TValue</span> **<span class="org-variable-name">val</span>) {
<span class="linenr">1040: </span>  <span class="org-type">Closure</span> *<span class="org-variable-name">f</span>;
<span class="linenr">1041: </span>  <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>ttisfunction(fi)) <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;
<span class="linenr">1042: </span>  f = clvalue(fi);
<span class="linenr">1043: </span>  <span class="org-keyword">if</span> (f-&gt;c.isC) {
<span class="linenr">1044: </span>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>(1 &lt;= n &amp;&amp; n &lt;= f-&gt;c.nupvalues)) <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;
<span class="linenr">1045: </span>    *val = &amp;f-&gt;c.upvalue[n-1];
<span class="linenr">1046: </span>    <span class="org-keyword">return</span> <span class="org-string">""</span>;
<span class="linenr">1047: </span>  }
<span class="linenr">1048: </span>  <span class="org-keyword">else</span> {
<span class="linenr">1049: </span>    <span class="org-type">Proto</span> *<span class="org-variable-name">p</span> = f-&gt;l.p;
<span class="linenr">1050: </span>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>(1 &lt;= n &amp;&amp; n &lt;= p-&gt;sizeupvalues)) <span class="org-keyword">return</span> <span class="org-constant">NULL</span>;
<span class="linenr">1051: </span>    *val = f-&gt;l.upvals[n-1]-&gt;v;
<span class="linenr">1052: </span>    <span class="org-keyword">return</span> getstr(p-&gt;upvalues[n-1]);
<span class="linenr">1053: </span>  }
<span class="linenr">1054: </span>}
<span class="linenr">1055: </span>
<span class="linenr">1056: </span>
<span class="linenr">1057: </span><span class="org-type">LUA_API</span> <span class="org-keyword">const</span> <span class="org-type">char</span> *lua_getupvalue (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">int</span> <span class="org-variable-name">funcindex</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>) {
<span class="linenr">1058: </span>  <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
<span class="linenr">1059: </span>  <span class="org-type">TValue</span> *<span class="org-variable-name">val</span>;
<span class="linenr">1060: </span>  lua_lock(L);
<span class="linenr">1061: </span>  name = aux_upvalue(index2adr(L, funcindex), n, &amp;val);
<span class="linenr">1062: </span>  <span class="org-keyword">if</span> (name) {
<span class="linenr">1063: </span>    setobj2s(L, L-&gt;top, val);
<span class="linenr">1064: </span>    api_incr_top(L);
<span class="linenr">1065: </span>  }
<span class="linenr">1066: </span>  lua_unlock(L);
<span class="linenr">1067: </span>  <span class="org-keyword">return</span> name;
<span class="linenr">1068: </span>}
</pre>
</div>

<p>
其中正是通过 <code>Closure.upvalues</code> 来寻找 upval 的。
</p>
</div>
</div>

<div id="outline-container-orgb497b37" class="outline-3">
<h3 id="orgb497b37"><span class="section-number-3">4.4</span> hook</h3>
<div class="outline-text-3" id="text-4-4">
<p>
debug 模块提供的另一方面的功能就是 hook。
</p>

<p>
hook 有 4 种类型<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup>， 分别为 <code>call return line count</code> 。
</p>


<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>lua.h</label><pre class="src src-C"><span class="linenr">308: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">309: </span><span class="org-comment">** Event codes</span>
<span class="linenr">310: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">311: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_HOOKCALL</span>    0
<span class="linenr">312: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_HOOKRET</span>     1
<span class="linenr">313: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_HOOKLINE</span>    2
<span class="linenr">314: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_HOOKCOUNT</span>   3
<span class="linenr">315: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_HOOKTAILRET</span> 4
<span class="linenr">316: </span>
<span class="linenr">317: </span>
<span class="linenr">318: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">319: </span><span class="org-comment">** Event masks</span>
<span class="linenr">320: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">321: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_MASKCALL</span>    (1 &lt;&lt; LUA_HOOKCALL)
<span class="linenr">322: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_MASKRET</span>     (1 &lt;&lt; LUA_HOOKRET)
<span class="linenr">323: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_MASKLINE</span>    (1 &lt;&lt; LUA_HOOKLINE)
<span class="linenr">324: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">LUA_MASKCOUNT</span>   (1 &lt;&lt; LUA_HOOKCOUNT)
</pre>
</div>

<p>
sethook 先解析 mask 和 count，再调用 <code>lua_sethook</code> 设置 hook。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>ldblib.c</label><pre class="src src-C"><span class="linenr">225: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">makemask</span> (<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">smask</span>, <span class="org-type">int</span> <span class="org-variable-name">count</span>) {
<span class="linenr">226: </span>  <span class="org-type">int</span> <span class="org-variable-name">mask</span> = 0;
<span class="linenr">227: </span>  <span class="org-keyword">if</span> (strchr(smask, <span class="org-string">'c'</span>)) mask |= LUA_MASKCALL;
<span class="linenr">228: </span>  <span class="org-keyword">if</span> (strchr(smask, <span class="org-string">'r'</span>)) mask |= LUA_MASKRET;
<span class="linenr">229: </span>  <span class="org-keyword">if</span> (strchr(smask, <span class="org-string">'l'</span>)) mask |= LUA_MASKLINE;
<span class="linenr">230: </span>  <span class="org-keyword">if</span> (count &gt; 0) mask |= LUA_MASKCOUNT;
<span class="linenr">231: </span>  <span class="org-keyword">return</span> mask;
<span class="linenr">232: </span>}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>ldblib.c</label><pre class="src src-C"><span class="linenr">258: </span><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">db_sethook</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>) {
<span class="linenr">259: </span>  <span class="org-type">int</span> <span class="org-variable-name">arg</span>, <span class="org-variable-name">mask</span>, <span class="org-variable-name">count</span>;
<span class="linenr">260: </span>  <span class="org-type">lua_Hook</span> <span class="org-variable-name">func</span>;
<span class="linenr">261: </span>  <span class="org-type">lua_State</span> *<span class="org-variable-name">L1</span> = getthread(L, &amp;arg);
<span class="linenr">262: </span>  <span class="org-keyword">if</span> (lua_isnoneornil(L, arg+1)) {
<span class="linenr">263: </span>    lua_settop(L, arg+1);
<span class="linenr">264: </span>    func = <span class="org-constant">NULL</span>; mask = 0; count = 0;  <span class="org-comment-delimiter">/* </span><span class="org-comment">turn off hooks</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">265: </span>  }
<span class="linenr">266: </span>  <span class="org-keyword">else</span> {
<span class="linenr">267: </span>    <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">smask</span> = luaL_checkstring(L, arg+2);
<span class="linenr">268: </span>    luaL_checktype(L, arg+1, LUA_TFUNCTION);
<span class="linenr">269: </span>    count = luaL_optint(L, arg+3, 0);
<span class="linenr">270: </span>    func = hookf; mask = makemask(smask, count);
<span class="linenr">271: </span>  }
<span class="linenr">272: </span>  gethooktable(L);
<span class="linenr">273: </span>  lua_pushlightuserdata(L, L1);
<span class="linenr">274: </span>  lua_pushvalue(L, arg+1);
<span class="linenr">275: </span>  lua_rawset(L, -3);  <span class="org-comment-delimiter">/* </span><span class="org-comment">set new hook</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">276: </span>  lua_pop(L, 1);  <span class="org-comment-delimiter">/* </span><span class="org-comment">remove hook table</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">277: </span>  lua_sethook(L1, func, mask, count);  <span class="org-comment-delimiter">/* </span><span class="org-comment">set hooks</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">278: </span>  <span class="org-keyword">return</span> 0;
<span class="linenr">279: </span>}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>ldebug.c</label><pre class="src src-C"><span class="linenr">53: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">54: </span><span class="org-comment">** this function can be called asynchronous (e.g. during a signal)</span>
<span class="linenr">55: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">56: </span>LUA_API <span class="org-type">int</span> <span class="org-function-name">lua_sethook</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">lua_Hook</span> <span class="org-variable-name">func</span>, <span class="org-type">int</span> <span class="org-variable-name">mask</span>, <span class="org-type">int</span> <span class="org-variable-name">count</span>) {
<span class="linenr">57: </span>  <span class="org-keyword">if</span> (func == <span class="org-constant">NULL</span> || mask == 0) {  <span class="org-comment-delimiter">/* </span><span class="org-comment">turn off hooks?</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">58: </span>    mask = 0;
<span class="linenr">59: </span>    func = <span class="org-constant">NULL</span>;
<span class="linenr">60: </span>  }
<span class="linenr">61: </span>  L-&gt;hook = func;
<span class="linenr">62: </span>  L-&gt;basehookcount = count;
<span class="linenr">63: </span>  resethookcount(L);
<span class="linenr">64: </span>  L-&gt;hookmask = cast_byte(mask);
<span class="linenr">65: </span>  <span class="org-keyword">return</span> 1;
<span class="linenr">66: </span>}
</pre>
</div>

<p>
其中将所有 hook 信息存储到当前 <code>lua_State</code> 中。
</p>

<p>
hook 调用的时间点散落在 lvm.c 和 ldo.c 中，全部通过 <code>luaD_callhook</code> 来调用。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>ldo.c</label><pre class="src src-C"><span class="linenr">181: </span><span class="org-type">void</span> <span class="org-function-name">luaD_callhook</span> (<span class="org-type">lua_State</span> *<span class="org-variable-name">L</span>, <span class="org-type">int</span> <span class="org-variable-name">event</span>, <span class="org-type">int</span> <span class="org-variable-name">line</span>) {
<span class="linenr">182: </span>  <span class="org-type">lua_Hook</span> <span class="org-variable-name">hook</span> = L-&gt;hook;
<span class="linenr">183: </span>  <span class="org-keyword">if</span> (hook &amp;&amp; L-&gt;allowhook) {
<span class="linenr">184: </span>    <span class="org-type">ptrdiff_t</span> <span class="org-variable-name">top</span> = savestack(L, L-&gt;top);
<span class="linenr">185: </span>    <span class="org-type">ptrdiff_t</span> <span class="org-variable-name">ci_top</span> = savestack(L, L-&gt;ci-&gt;top);
<span class="linenr">186: </span>    <span class="org-type">lua_Debug</span> <span class="org-variable-name">ar</span>;
<span class="linenr">187: </span>    ar.event = event;
<span class="linenr">188: </span>    ar.currentline = line;
<span class="linenr">189: </span>    <span class="org-keyword">if</span> (event == LUA_HOOKTAILRET)
<span class="linenr">190: </span>      ar.i_ci = 0;  <span class="org-comment-delimiter">/* </span><span class="org-comment">tail call; no debug information about it</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">191: </span>    <span class="org-keyword">else</span>
<span class="linenr">192: </span>      ar.i_ci = cast_int(L-&gt;ci - L-&gt;base_ci);
<span class="linenr">193: </span>    luaD_checkstack(L, LUA_MINSTACK);  <span class="org-comment-delimiter">/* </span><span class="org-comment">ensure minimum stack size</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">194: </span>    L-&gt;ci-&gt;top = L-&gt;top + LUA_MINSTACK;
<span class="linenr">195: </span>    lua_assert(L-&gt;ci-&gt;top &lt;= L-&gt;stack_last);
<span class="linenr">196: </span>    L-&gt;allowhook = 0;  <span class="org-comment-delimiter">/* </span><span class="org-comment">cannot call hooks inside a hook</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">197: </span>    lua_unlock(L);
<span class="linenr">198: </span>    (*hook)(L, &amp;ar);
<span class="linenr">199: </span>    lua_lock(L);
<span class="linenr">200: </span>    lua_assert(<span class="org-negation-char">!</span>L-&gt;allowhook);
<span class="linenr">201: </span>    L-&gt;allowhook = 1;
<span class="linenr">202: </span>    L-&gt;ci-&gt;top = restorestack(L, ci_top);
<span class="linenr">203: </span>    L-&gt;top = restorestack(L, top);
<span class="linenr">204: </span>  }
<span class="linenr">205: </span>}
</pre>
</div>

<p>
可能通过搜索 <code>luaD_callhook</code> 的调用位置，确认不同的 mask 对应的调用时机，
这一点和 vm 的运行相关，细节就不再赘述。
</p>
</div>
</div>
</div>


<div id="outline-container-orgba1d57c" class="outline-2">
<h2 id="orgba1d57c"><span class="section-number-2">5</span> practice</h2>
<div class="outline-text-2" id="text-5">
<p>
标准库的代码量并不小，但是安排的架构很清晰，读者可根据自己的需要和兴趣有目的的按点阅读。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">章节涉及文件</th>
<th scope="col" class="org-left">建议阅读程度</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">linit.c</td>
<td class="org-left">★ ★ ★ ★ ★</td>
</tr>

<tr>
<td class="org-left">lbaselib.c</td>
<td class="org-left">★ ★ ★ ★ ☆</td>
</tr>

<tr>
<td class="org-left">lmathlib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">lstrlib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">ltablib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">liolib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">loslib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">loadlib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">ldblib.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>

<tr>
<td class="org-left">ldebug.c</td>
<td class="org-left">★ ★ ☆ ☆ ☆</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
: <a href="http://www.lua.org/manual/5.1/manual.html#5">http://www.lua.org/manual/5.1/manual.html#5</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
: <a href="http://www.lua.org/manual/5.1/manual.html#5.9">http://www.lua.org/manual/5.1/manual.html#5.9</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
: <a href="http://www.lua.org/manual/5.1/manual.html#lua_getinfo">http://www.lua.org/manual/5.1/manual.html#lua_getinfo</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
: <a href="http://www.lua.org/manual/5.1/manual.html#lua_sethook">http://www.lua.org/manual/5.1/manual.html#lua_sethook</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">

<p>Revised: 2021-01-20 三 13:06</p>
<p>Created: 2021-01-18 一 16:08</p>
<p>Author: DreamAndDead</p>
<p>Email: <a href="mailto:dreamanddead@foxmail.com">dreamanddead@foxmail.com</a></p>
<script src="https://utteranc.es/client.js" repo="DreamAndDead/DreamAndDead.github.io" issue-term="pathname" label="Comment" theme="github-light" crossorigin="anonymous" async></script>
</div>
</body>
</html>
