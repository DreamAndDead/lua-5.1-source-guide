<!doctype html><html lang=zh dir=ltr><head><meta name=generator content="Hugo 0.80.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在 lex 章节提到，require next 之类不是关键字而是函数， 在 api 章节提到 api 也用于内部作用， 它们描述的都是 lua 标准库。
本章节就来讲解 lua 内部是如何处理标准库的。
register #  标准库可以说是多种功能函数的集合，在被使用之前，必须先被注册。
18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  #define LUA_COLIBNAME	&#34;coroutine&#34; LUALIB_API int (luaopen_base) (lua_State *L); #define LUA_TABLIBNAME	&#34;table&#34; LUALIB_API int (luaopen_table) (lua_State *L); #define LUA_IOLIBNAME	&#34;io&#34; LUALIB_API int (luaopen_io) (lua_State *L); #define LUA_OSLIBNAME	&#34;os&#34; LUALIB_API int (luaopen_os) (lua_State *L); #define LUA_STRLIBNAME	&#34;string&#34; LUALIB_API int (luaopen_string) (lua_State *L); #define LUA_MATHLIBNAME	&#34;math&#34; LUALIB_API int (luaopen_math) (lua_State *L); #define LUA_DBLIBNAME	&#34;debug&#34; LUALIB_API int (luaopen_debug) (lua_State *L); #define LUA_LOADLIBNAME	&#34;package&#34; LUALIB_API int (luaopen_package) (lua_State *L); /* open all previous libraries */ LUALIB_API void (luaL_openlibs) (lua_State *L);   Code Snippet 1: lualib."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="std lib"><meta property="og:description" content="在 lex 章节提到，require next 之类不是关键字而是函数， 在 api 章节提到 api 也用于内部作用， 它们描述的都是 lua 标准库。
本章节就来讲解 lua 内部是如何处理标准库的。
register #  标准库可以说是多种功能函数的集合，在被使用之前，必须先被注册。
18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  #define LUA_COLIBNAME	&#34;coroutine&#34; LUALIB_API int (luaopen_base) (lua_State *L); #define LUA_TABLIBNAME	&#34;table&#34; LUALIB_API int (luaopen_table) (lua_State *L); #define LUA_IOLIBNAME	&#34;io&#34; LUALIB_API int (luaopen_io) (lua_State *L); #define LUA_OSLIBNAME	&#34;os&#34; LUALIB_API int (luaopen_os) (lua_State *L); #define LUA_STRLIBNAME	&#34;string&#34; LUALIB_API int (luaopen_string) (lua_State *L); #define LUA_MATHLIBNAME	&#34;math&#34; LUALIB_API int (luaopen_math) (lua_State *L); #define LUA_DBLIBNAME	&#34;debug&#34; LUALIB_API int (luaopen_debug) (lua_State *L); #define LUA_LOADLIBNAME	&#34;package&#34; LUALIB_API int (luaopen_package) (lua_State *L); /* open all previous libraries */ LUALIB_API void (luaL_openlibs) (lua_State *L);   Code Snippet 1: lualib."><meta property="og:type" content="article"><meta property="og:url" content="https://dreamanddead.github.io/lua-5.1-source-guide/docs/stdlib/"><meta property="article:published_time" content="2021-01-18T16:08:00+08:00"><meta property="article:modified_time" content="2021-02-23T13:26:02+08:00"><title>std lib | lua 5.1 source guide</title><link rel=manifest href=/lua-5.1-source-guide/manifest.json><link rel=icon href=/lua-5.1-source-guide/favicon.png type=image/x-icon><link rel=stylesheet href=/lua-5.1-source-guide/book.min.dfc677a7972fb0d86dd6eaf657edfad83e2c433246dffdf64911ee91450f0378.css integrity="sha256-38Z3p5cvsNht1ur2V+362D4sQzJG3/32SRHukUUPA3g="><script defer src=/lua-5.1-source-guide/zh.search.min.63a734a12cfe0fd29995becea70dc8f315c1540f9981491da7d955afee3cf62e.js integrity="sha256-Y6c0oSz+D9KZlb7Opw3I8xXBVA+ZgUkdp9lVr+489i4="></script><script defer src=/lua-5.1-source-guide/sw.min.630373637e97fa7891a03b850675656b8da4625d692de7ef0581b22b995ab946.js integrity="sha256-YwNzY36X+niRoDuFBnVla42kYl1pLefvBYGyK5lauUY="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/lua-5.1-source-guide><img src=/lua-5.1-source-guide/logo.png alt=Logo><span>lua 5.1 source guide</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/lua-5.1-source-guide/docs/overview/>overview</a></li><li>basic<ul><li><a href=/lua-5.1-source-guide/docs/object/>object</a></li><li><a href=/lua-5.1-source-guide/docs/memory/>memory</a></li><li><a href=/lua-5.1-source-guide/docs/string/>string</a></li><li><a href=/lua-5.1-source-guide/docs/table/>table</a></li></ul></li><li>compiler<ul><li><a href=/lua-5.1-source-guide/docs/lexer/>lexer</a></li><li><a href=/lua-5.1-source-guide/docs/opcode/>opcode</a></li><li><a href=/lua-5.1-source-guide/docs/parser/>parser</a></li><li><a href=/lua-5.1-source-guide/docs/generator/>generator</a></li></ul></li><li>vm<ul><li><a href=/lua-5.1-source-guide/docs/vm/>vm</a></li><li><a href=/lua-5.1-source-guide/docs/api/>c api</a></li><li><a href=/lua-5.1-source-guide/docs/stdlib/ class=active>stdlib</a></li><li><a href=/lua-5.1-source-guide/docs/gc/>gc</a></li></ul></li></ul><p><br></p><ul><li><a href=https://github.com/DreamAndDead/lua-5.1-source-guide target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/lua-5.1-source-guide/svg/menu.svg class=book-icon alt=Menu></label>
<strong>std lib</strong>
<label for=toc-control><img src=/lua-5.1-source-guide/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#register>register</a></li><li><a href=#module>module</a></li><li><a href=#coroutine>coroutine</a><ul><li><a href=#create>create</a></li><li><a href=#resume-and-yield>resume & yield</a></li><li><a href=#status>status</a></li></ul></li><li><a href=#debug>debug</a><ul><li><a href=#getinfo>getinfo</a></li><li><a href=#getlocal>getlocal</a></li><li><a href=#getupval>getupval</a></li><li><a href=#hook>hook</a></li></ul></li><li><a href=#practice>practice</a></li></ul></li></ul></nav></aside></header><article class=markdown><p>在 lex 章节提到，require next 之类不是关键字而是函数，
在 api 章节提到 api 也用于内部作用，
它们描述的都是 lua 标准库。</p><p>本章节就来讲解 lua 内部是如何处理标准库的。</p><h2 id=register>register
<a class=anchor href=#register>#</a></h2><p>标准库可以说是多种功能函数的集合，在被使用之前，必须先被注册。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#1e889b>#define LUA_COLIBNAME	&#34;coroutine&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_base) (lua_State *L);

<span style=color:#1e889b>#define LUA_TABLIBNAME	&#34;table&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_table) (lua_State *L);

<span style=color:#1e889b>#define LUA_IOLIBNAME	&#34;io&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_io) (lua_State *L);

<span style=color:#1e889b>#define LUA_OSLIBNAME	&#34;os&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_os) (lua_State *L);

<span style=color:#1e889b>#define LUA_STRLIBNAME	&#34;string&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_string) (lua_State *L);

<span style=color:#1e889b>#define LUA_MATHLIBNAME	&#34;math&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_math) (lua_State *L);

<span style=color:#1e889b>#define LUA_DBLIBNAME	&#34;debug&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_debug) (lua_State *L);

<span style=color:#1e889b>#define LUA_LOADLIBNAME	&#34;package&#34;
</span><span style=color:#1e889b></span>LUALIB_API <span style=color:#008b45>int</span> (luaopen_package) (lua_State *L);


<span style=color:#228b22>/* open all previous libraries */</span>
LUALIB_API <span style=color:#008b45>void</span> (luaL_openlibs) (lua_State *L);</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 1</span>:
lualib.h</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>typedef</span> <span style=color:#8b008b;font-weight:700>struct</span> luaL_Reg {
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *name;
  lua_CFunction func;
} luaL_Reg;</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 2</span>:
lauxlib.h</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg lualibs[] = {
  {<span style=color:#cd5555>&#34;&#34;</span>, luaopen_base},
  {LUA_LOADLIBNAME, luaopen_package},
  {LUA_TABLIBNAME, luaopen_table},
  {LUA_IOLIBNAME, luaopen_io},
  {LUA_OSLIBNAME, luaopen_os},
  {LUA_STRLIBNAME, luaopen_string},
  {LUA_MATHLIBNAME, luaopen_math},
  {LUA_DBLIBNAME, luaopen_debug},
  {<span style=color:#658b00>NULL</span>, <span style=color:#658b00>NULL</span>}
};


LUALIB_API <span style=color:#00688b;font-weight:700>void</span> <span style=color:#008b45>luaL_openlibs</span> (lua_State *L) {
  <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg *lib = lualibs;
  <span style=color:#8b008b;font-weight:700>for</span> (; lib-&gt;func; lib++) {
    lua_pushcfunction(L, lib-&gt;func);
    lua_pushstring(L, lib-&gt;name);
    lua_call(L, <span style=color:#b452cd>1</span>, <span style=color:#b452cd>0</span>);
  }
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 3</span>:
linit.c</div><p>各个模块实现了各自的功能，分别注册到不同的模块名中。</p><table><thead><tr><th>file</th><th>module</th></tr></thead><tbody><tr><td>lbaselib.c</td><td>(coroutine)</td></tr><tr><td>lmathlib.c</td><td>math</td></tr><tr><td>lstrlib.c</td><td>string</td></tr><tr><td>ltablib.c</td><td>table</td></tr><tr><td>liolib.c</td><td>io</td></tr><tr><td>loslib.c</td><td>os</td></tr><tr><td>ldblib.c</td><td>debug</td></tr><tr><td>loadlib.c</td><td>package</td></tr></tbody></table><p>同时每个模块各自实现注册方法，由 <code>luaL_openlibs</code> 统一调用。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">232
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">233
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">234
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">235
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">236
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">237
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">238
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">239
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">240
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">241
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">242
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">243
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">244
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">245
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">246
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">247
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">248
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">249
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">250
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">251
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">252
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">253
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">254
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">255
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">256
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">257
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">258
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">259
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">260
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">261
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">262
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">263
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">264
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">265
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">266
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">267
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">268
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>LUALIB_API <span style=color:#008b45>void</span> (luaL_register) (lua_State *L, <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *libname,
				<span style=color:#8b008b;font-weight:700>const</span> luaL_Reg *l) {
  luaI_openlib(L, libname, l, <span style=color:#b452cd>0</span>);
}


<span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>libsize</span> (<span style=color:#8b008b;font-weight:700>const</span> luaL_Reg *l) {
  <span style=color:#00688b;font-weight:700>int</span> size = <span style=color:#b452cd>0</span>;
  <span style=color:#8b008b;font-weight:700>for</span> (; l-&gt;name; l++) size++;
  <span style=color:#8b008b;font-weight:700>return</span> size;
}


LUALIB_API <span style=color:#00688b;font-weight:700>void</span> <span style=color:#008b45>luaI_openlib</span> (lua_State *L, <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *libname,
			      <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg *l, <span style=color:#00688b;font-weight:700>int</span> nup) {
  <span style=color:#8b008b;font-weight:700>if</span> (libname) {
    <span style=color:#00688b;font-weight:700>int</span> size = libsize(l);
    <span style=color:#228b22>/* check whether lib already exists */</span>
    luaL_findtable(L, LUA_REGISTRYINDEX, <span style=color:#cd5555>&#34;_LOADED&#34;</span>, <span style=color:#b452cd>1</span>);
    lua_getfield(L, -<span style=color:#b452cd>1</span>, libname);  <span style=color:#228b22>/* get _LOADED[libname] */</span>
    <span style=color:#8b008b;font-weight:700>if</span> (!lua_istable(L, -<span style=color:#b452cd>1</span>)) {  <span style=color:#228b22>/* not found? */</span>
      lua_pop(L, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* remove previous result */</span>
      <span style=color:#228b22>/* try global variable (and create one if it does not exist) */</span>
      <span style=color:#8b008b;font-weight:700>if</span> (luaL_findtable(L, LUA_GLOBALSINDEX, libname, size) != <span style=color:#658b00>NULL</span>)
	luaL_error(L, <span style=color:#cd5555>&#34;name conflict for module &#34;</span> LUA_QS, libname);
      lua_pushvalue(L, -<span style=color:#b452cd>1</span>);
      lua_setfield(L, -<span style=color:#b452cd>3</span>, libname);  <span style=color:#228b22>/* _LOADED[libname] = new table */</span>
    }
    lua_remove(L, -<span style=color:#b452cd>2</span>);  <span style=color:#228b22>/* remove _LOADED table */</span>
    lua_insert(L, -(nup+<span style=color:#b452cd>1</span>));  <span style=color:#228b22>/* move library table to below upvalues */</span>
  }
  <span style=color:#8b008b;font-weight:700>for</span> (; l-&gt;name; l++) {
    <span style=color:#00688b;font-weight:700>int</span> i;
    <span style=color:#8b008b;font-weight:700>for</span> (i=<span style=color:#b452cd>0</span>; i&lt;nup; i++)  <span style=color:#228b22>/* copy upvalues to the top */</span>
      lua_pushvalue(L, -nup);
    lua_pushcclosure(L, l-&gt;func, nup);
    lua_setfield(L, -(nup+<span style=color:#b452cd>2</span>), l-&gt;name);
  }
  lua_pop(L, nup);  <span style=color:#228b22>/* remove upvalues */</span>
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 4</span>:
lauxlib.c</div><p>首先进行注册的是全局方法和 coroutine 模块，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">626
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">627
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">628
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">629
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">630
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">631
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">632
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">633
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">634
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">635
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">636
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">637
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">638
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">639
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">640
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">641
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">642
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">643
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">644
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">645
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">646
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">647
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">648
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">649
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">650
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">651
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">652
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>void</span> <span style=color:#008b45>base_open</span> (lua_State *L) {
  <span style=color:#228b22>/* set global _G */</span>
  lua_pushvalue(L, LUA_GLOBALSINDEX);
  lua_setglobal(L, <span style=color:#cd5555>&#34;_G&#34;</span>);
  <span style=color:#228b22>/* open lib into global table */</span>
  luaL_register(L, <span style=color:#cd5555>&#34;_G&#34;</span>, base_funcs);
  lua_pushliteral(L, LUA_VERSION);
  lua_setglobal(L, <span style=color:#cd5555>&#34;_VERSION&#34;</span>);  <span style=color:#228b22>/* set global _VERSION */</span>
  <span style=color:#228b22>/* `ipairs&#39; and `pairs&#39; need auxiliary functions as upvalues */</span>
  auxopen(L, <span style=color:#cd5555>&#34;ipairs&#34;</span>, luaB_ipairs, ipairsaux);
  auxopen(L, <span style=color:#cd5555>&#34;pairs&#34;</span>, luaB_pairs, luaB_next);
  <span style=color:#228b22>/* `newproxy&#39; needs a weaktable as upvalue */</span>
  lua_createtable(L, <span style=color:#b452cd>0</span>, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* new table `w&#39; */</span>
  lua_pushvalue(L, -<span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* `w&#39; will be its own metatable */</span>
  lua_setmetatable(L, -<span style=color:#b452cd>2</span>);
  lua_pushliteral(L, <span style=color:#cd5555>&#34;kv&#34;</span>);
  lua_setfield(L, -<span style=color:#b452cd>2</span>, <span style=color:#cd5555>&#34;__mode&#34;</span>);  <span style=color:#228b22>/* metatable(w).__mode = &#34;kv&#34; */</span>
  lua_pushcclosure(L, luaB_newproxy, <span style=color:#b452cd>1</span>);
  lua_setglobal(L, <span style=color:#cd5555>&#34;newproxy&#34;</span>);  <span style=color:#228b22>/* set global `newproxy&#39; */</span>
}


LUALIB_API <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>luaopen_base</span> (lua_State *L) {
  base_open(L);
  luaL_register(L, LUA_COLIBNAME, co_funcs);
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>2</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 5</span>:
lbaselib.c</div><p>line 628 629 在全局表中添加 _G，指向全局表自身。</p><p>line 631 <code>luaL_register(L, "_G", base_funcs);</code> 将全局函数注册到 _G 中。</p><p>在注册过程中，在 REGISTRY 表中使用 _LOADED 记录相应注册的项，避免注册时出现重复冲突。
同时将相应的注册项添加到全局表中。</p><p>最终全部模块注册后，REGISTRY 表的内容大致如下，其中 _LOADED._G 引用的正是全局表，</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>registry = {
   _LOADED = {
      _G = {
	 _G = {
	    <span style=color:#228b22>-- ...</span>
	 },
	 assert = ...,
	 dofile = ...,
	 <span style=color:#228b22>--...</span>
	 <span style=color:#228b22>--...</span>
	 coroutine = {
	    <span style=color:#228b22>--...</span>
	    <span style=color:#228b22>--...</span>
	 },
	 math = {
	    <span style=color:#228b22>--...</span>
	    <span style=color:#228b22>--...</span>
	 },
	 <span style=color:#228b22>--...</span>
      },
      coroutine = {
	 <span style=color:#228b22>--...</span>
	 <span style=color:#228b22>--...</span>
      },
      math = {
	 <span style=color:#228b22>--...</span>
	 <span style=color:#228b22>--...</span>
      },
      <span style=color:#228b22>--...</span>
   }
}
</code></pre></div><p>可通过</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ make -s registry
</code></pre></div><p>来查看更具体的 REGISTRY 内容。</p><h2 id=module>module
<a class=anchor href=#module>#</a></h2><p>base 模块注册了所有基础全局函数，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">447
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">448
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">449
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">450
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">451
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">452
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">453
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">454
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">455
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">456
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">457
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">458
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">459
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">460
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">461
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">462
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">463
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">464
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">465
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">466
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">467
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">468
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">469
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">470
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">471
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">472
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">473
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg base_funcs[] = {
  {<span style=color:#cd5555>&#34;assert&#34;</span>, luaB_assert},
  {<span style=color:#cd5555>&#34;collectgarbage&#34;</span>, luaB_collectgarbage},
  {<span style=color:#cd5555>&#34;dofile&#34;</span>, luaB_dofile},
  {<span style=color:#cd5555>&#34;error&#34;</span>, luaB_error},
  {<span style=color:#cd5555>&#34;gcinfo&#34;</span>, luaB_gcinfo},
  {<span style=color:#cd5555>&#34;getfenv&#34;</span>, luaB_getfenv},
  {<span style=color:#cd5555>&#34;getmetatable&#34;</span>, luaB_getmetatable},
  {<span style=color:#cd5555>&#34;loadfile&#34;</span>, luaB_loadfile},
  {<span style=color:#cd5555>&#34;load&#34;</span>, luaB_load},
  {<span style=color:#cd5555>&#34;loadstring&#34;</span>, luaB_loadstring},
  {<span style=color:#cd5555>&#34;next&#34;</span>, luaB_next},
  {<span style=color:#cd5555>&#34;pcall&#34;</span>, luaB_pcall},
  {<span style=color:#cd5555>&#34;print&#34;</span>, luaB_print},
  {<span style=color:#cd5555>&#34;rawequal&#34;</span>, luaB_rawequal},
  {<span style=color:#cd5555>&#34;rawget&#34;</span>, luaB_rawget},
  {<span style=color:#cd5555>&#34;rawset&#34;</span>, luaB_rawset},
  {<span style=color:#cd5555>&#34;select&#34;</span>, luaB_select},
  {<span style=color:#cd5555>&#34;setfenv&#34;</span>, luaB_setfenv},
  {<span style=color:#cd5555>&#34;setmetatable&#34;</span>, luaB_setmetatable},
  {<span style=color:#cd5555>&#34;tonumber&#34;</span>, luaB_tonumber},
  {<span style=color:#cd5555>&#34;tostring&#34;</span>, luaB_tostring},
  {<span style=color:#cd5555>&#34;type&#34;</span>, luaB_type},
  {<span style=color:#cd5555>&#34;unpack&#34;</span>, luaB_unpack},
  {<span style=color:#cd5555>&#34;xpcall&#34;</span>, luaB_xpcall},
  {<span style=color:#658b00>NULL</span>, <span style=color:#658b00>NULL</span>}
};</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 6</span>:
lbaselib.c</div><p>其中每个函数都对应一个 C 函数实现，函数使用 api 接口与 Lua 进行数据交互，
然后将函数注册到 Lua 的全局表中，在运行 Lua 代码时就可以平滑调用。
正如 api 章节所述，这即是 api 在内部实现发挥的作用。</p><p>其它模块的注册过程与之类似，读者可结合官方文档<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>针对相应的方法进行了解。</p><h2 id=coroutine>coroutine
<a class=anchor href=#coroutine>#</a></h2><p>一个出人意料的点在于，协程是用 api 来实现的，而不是内建在 vm 中。</p><p>coroutine 模块一并在 baselib 中注册，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">605
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">606
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">607
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">608
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">609
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">610
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">611
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">612
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">613
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg co_funcs[] = {
  {<span style=color:#cd5555>&#34;create&#34;</span>, luaB_cocreate},
  {<span style=color:#cd5555>&#34;resume&#34;</span>, luaB_coresume},
  {<span style=color:#cd5555>&#34;running&#34;</span>, luaB_corunning},
  {<span style=color:#cd5555>&#34;status&#34;</span>, luaB_costatus},
  {<span style=color:#cd5555>&#34;wrap&#34;</span>, luaB_cowrap},
  {<span style=color:#cd5555>&#34;yield&#34;</span>, luaB_yield},
  {<span style=color:#658b00>NULL</span>, <span style=color:#658b00>NULL</span>}
};</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 7</span>:
lbaselib.c</div><p>其中的方法，正是在 lua 代码中使用的 coroutine.* 方法。</p><h3 id=create>create
<a class=anchor href=#create>#</a></h3><p>至此，我们已经了解了 8 种基础类型的 7 种，余下的 thread 类型，正是协程。
而并不意外的，协程本身正是 <code>lua_State</code> 。</p><p><code>lua_State</code> 记录了所有 lua 代码运行时的状态，协程可理解为是 vm 另外运行的一块 lua 代码，
所以用 <code>lua_State</code> 来表示。</p><p>从操作系统层面而言，lua 解释器是一个单线程程序。
lua 实现的协程，虽然在内部声明类型为 thread，但是本质上，
只是多个不同的 <code>lua_State</code> 交替控制权在轮换执行。</p><p>也就是说，协程是异步并发的，而不是并行的。</p><figure><img src=stdlib-thread.png></figure><p>lua 内部默认存在“主线程” main thread，就是多次出现在代码中的 <code>lua_State *L</code> 。</p><p>主线程可创建出新的协程并通过 resume 执行，此时主线程失去控制权；
协程通过 yield 放弃控制权，回到主线程调用时；
主线程可通过 resume 重新进入协程的中断点，继续执行。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">576
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">577
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">578
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">579
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">580
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">581
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">582
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">583
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>luaB_cocreate</span> (lua_State *L) {
  lua_State *NL = lua_newthread(L);
  luaL_argcheck(L, lua_isfunction(L, <span style=color:#b452cd>1</span>) &amp;&amp; !lua_iscfunction(L, <span style=color:#b452cd>1</span>), <span style=color:#b452cd>1</span>,
    <span style=color:#cd5555>&#34;Lua function expected&#34;</span>);
  lua_pushvalue(L, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* move function to top */</span>
  lua_xmove(L, NL, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* move function from L to NL */</span>
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>1</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 8</span>:
lbaselib.c</div><figure><img src=stdlib-create.png></figure><p>lua 内部通过 coroutine.create(f) 来创建协程，在主线程 L 的栈底即存在 <code>luaB_cocreate</code> 和 f，
通过 <code>lua_newthead</code> 创建协程 NL（即 <code>lua_State</code> ）并入栈，再将 f 复制到栈顶，
并通过 xmove 移动到 NL 的栈中，作为起始调用函数，最终返回 NL。</p><p><code>lua_newthead</code> 最终调用了 <code>luaE_newthread</code> ，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>lua_State *<span style=color:#008b45>luaE_newthread</span> (lua_State *L) {
  lua_State *L1 = tostate(luaM_malloc(L, state_size(lua_State)));
  luaC_link(L, obj2gco(L1), LUA_TTHREAD);
  preinit_state(L1, G(L));
  stack_init(L1, L);  <span style=color:#228b22>/* init stack */</span>
  setobj2n(L, gt(L1), gt(L));  <span style=color:#228b22>/* share table of globals */</span>
  L1-&gt;hookmask = L-&gt;hookmask;
  L1-&gt;basehookcount = L-&gt;basehookcount;
  L1-&gt;hook = L-&gt;hook;
  resethookcount(L1);
  lua_assert(iswhite(obj2gco(L1)));
  <span style=color:#8b008b;font-weight:700>return</span> L1;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 9</span>:
lstate.c</div><p>在 line 124 表明，协程是共享全局表的，即在协程中修改全局变量是相互影响的。</p><h3 id=resume-and-yield>resume & yield
<a class=anchor href=#resume-and-yield>#</a></h3><p>resume 函数开始执行/恢复协程的运行，第一个参数为协程本身，后续参数为传递入协程的参数，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">518
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">519
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">520
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">521
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">522
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">523
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">524
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">525
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">526
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">527
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">528
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">529
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">530
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">531
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">532
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">533
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">534
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">535
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">536
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">537
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">538
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">539
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">540
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">541
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">542
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">543
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">544
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">545
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">546
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">547
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">548
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">549
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">550
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">551
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">552
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">553
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">554
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">555
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">556
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">557
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">558
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>auxresume</span> (lua_State *L, lua_State *co, <span style=color:#00688b;font-weight:700>int</span> narg) {
  <span style=color:#00688b;font-weight:700>int</span> status = costatus(L, co);
  <span style=color:#8b008b;font-weight:700>if</span> (!lua_checkstack(co, narg))
    luaL_error(L, <span style=color:#cd5555>&#34;too many arguments to resume&#34;</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (status != CO_SUS) {
    lua_pushfstring(L, <span style=color:#cd5555>&#34;cannot resume %s coroutine&#34;</span>, statnames[status]);
    <span style=color:#8b008b;font-weight:700>return</span> -<span style=color:#b452cd>1</span>;  <span style=color:#228b22>/* error flag */</span>
  }
  lua_xmove(L, co, narg);
  lua_setlevel(L, co);
  status = lua_resume(co, narg);
  <span style=color:#8b008b;font-weight:700>if</span> (status == <span style=color:#b452cd>0</span> || status == LUA_YIELD) {
    <span style=color:#00688b;font-weight:700>int</span> nres = lua_gettop(co);
    <span style=color:#8b008b;font-weight:700>if</span> (!lua_checkstack(L, nres + <span style=color:#b452cd>1</span>))
      luaL_error(L, <span style=color:#cd5555>&#34;too many results to resume&#34;</span>);
    lua_xmove(co, L, nres);  <span style=color:#228b22>/* move yielded values */</span>
    <span style=color:#8b008b;font-weight:700>return</span> nres;
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    lua_xmove(co, L, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* move error message */</span>
    <span style=color:#8b008b;font-weight:700>return</span> -<span style=color:#b452cd>1</span>;  <span style=color:#228b22>/* error flag */</span>
  }
}


<span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>luaB_coresume</span> (lua_State *L) {
  lua_State *co = lua_tothread(L, <span style=color:#b452cd>1</span>);
  <span style=color:#00688b;font-weight:700>int</span> r;
  luaL_argcheck(L, co, <span style=color:#b452cd>1</span>, <span style=color:#cd5555>&#34;coroutine expected&#34;</span>);
  r = auxresume(L, co, lua_gettop(L) - <span style=color:#b452cd>1</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (r &lt; <span style=color:#b452cd>0</span>) {
    lua_pushboolean(L, <span style=color:#b452cd>0</span>);
    lua_insert(L, -<span style=color:#b452cd>2</span>);
    <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>2</span>;  <span style=color:#228b22>/* return false + error message */</span>
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    lua_pushboolean(L, <span style=color:#b452cd>1</span>);
    lua_insert(L, -(r + <span style=color:#b452cd>1</span>));
    <span style=color:#8b008b;font-weight:700>return</span> r + <span style=color:#b452cd>1</span>;  <span style=color:#228b22>/* return true + `resume&#39; returns */</span>
  }
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 10</span>:
lbaselib.c</div><p>line 544 先找到协程，
line 526 再通过 xmove 将参数传递到相应的栈中，
line 528 恢复其执行，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">418
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">419
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">420
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">421
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">422
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">423
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">424
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">425
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">426
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">427
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">428
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">429
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">430
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">431
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">432
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">433
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">434
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">435
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">436
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">437
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">438
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">439
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">440
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">441
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>LUA_API <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>lua_resume</span> (lua_State *L, <span style=color:#00688b;font-weight:700>int</span> nargs) {
  <span style=color:#00688b;font-weight:700>int</span> status;
  lua_lock(L);
  <span style=color:#8b008b;font-weight:700>if</span> (L-&gt;status != LUA_YIELD &amp;&amp; (L-&gt;status != <span style=color:#b452cd>0</span> || L-&gt;ci != L-&gt;base_ci))
      <span style=color:#8b008b;font-weight:700>return</span> resume_error(L, <span style=color:#cd5555>&#34;cannot resume non-suspended coroutine&#34;</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (L-&gt;nCcalls &gt;= LUAI_MAXCCALLS)
    <span style=color:#8b008b;font-weight:700>return</span> resume_error(L, <span style=color:#cd5555>&#34;C stack overflow&#34;</span>);
  luai_userstateresume(L, nargs);
  lua_assert(L-&gt;errfunc == <span style=color:#b452cd>0</span>);
  L-&gt;baseCcalls = ++L-&gt;nCcalls;
  status = luaD_rawrunprotected(L, resume, L-&gt;top - nargs);
  <span style=color:#8b008b;font-weight:700>if</span> (status != <span style=color:#b452cd>0</span>) {  <span style=color:#228b22>/* error? */</span>
    L-&gt;status = cast_byte(status);  <span style=color:#228b22>/* mark thread as `dead&#39; */</span>
    luaD_seterrorobj(L, status, L-&gt;top);
    L-&gt;ci-&gt;top = L-&gt;top;
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    lua_assert(L-&gt;nCcalls == L-&gt;baseCcalls);
    status = L-&gt;status;
  }
  --L-&gt;nCcalls;
  lua_unlock(L);
  <span style=color:#8b008b;font-weight:700>return</span> status;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 11</span>:
ldo.c</div><p>执行协程之后，最终返回其状态值。</p><p>line 529 判断状态为 yield 时，回收其栈上的返回值，通过 xmove 移动到 L 中。</p><p>与之相配合的，yield 函数则直接准备参数数量，重置 <code>lua_State</code> 的状态为 yield 即可。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">593
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">594
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">595
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>luaB_yield</span> (lua_State *L) {
  <span style=color:#8b008b;font-weight:700>return</span> lua_yield(L, lua_gettop(L));
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 12</span>:
lbaselib.c</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">444
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">445
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">446
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">447
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">448
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">449
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">450
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">451
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">452
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">453
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>LUA_API <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>lua_yield</span> (lua_State *L, <span style=color:#00688b;font-weight:700>int</span> nresults) {
  luai_userstateyield(L, nresults);
  lua_lock(L);
  <span style=color:#8b008b;font-weight:700>if</span> (L-&gt;nCcalls &gt; L-&gt;baseCcalls)
    luaG_runerror(L, <span style=color:#cd5555>&#34;attempt to yield across metamethod/C-call boundary&#34;</span>);
  L-&gt;base = L-&gt;top - nresults;  <span style=color:#228b22>/* protect stack slots below */</span>
  L-&gt;status = LUA_YIELD;
  lua_unlock(L);
  <span style=color:#8b008b;font-weight:700>return</span> -<span style=color:#b452cd>1</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 13</span>:
ldo.c</div><p>比如如下示例代码，</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#8b008b;font-weight:700>local</span> co = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>(a, b, c)
      <span style=color:#8b008b;font-weight:700>local</span> d, e = coroutine.yield(a + b + c)
      <span style=color:#8b008b;font-weight:700>return</span> d + e
      <span style=color:#8b008b;font-weight:700>end</span>)

print(coroutine.resume(co, <span style=color:#b452cd>1</span>, <span style=color:#b452cd>2</span>, <span style=color:#b452cd>3</span>))
print(coroutine.resume(co, <span style=color:#b452cd>4</span>, <span style=color:#b452cd>5</span>))
print(coroutine.resume(co))
</code></pre></div><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>true	6
true	9
false	cannot resume dead coroutine
</code></pre></div><p>第一次 resume 时，将参数传递入 NL，</p><figure><img src=stdlib-resume.png></figure><p>协程内部执行 yield，返回状态 <code>LUA_YIELD</code> ，resume 通过 xmove 将结果从栈回收至 L，
最终 resume 自己压栈 bool 值 true 并 insert 所有返回值，作为调用 resume 的返回值。</p><figure><img src=stdlib-resume-return.png></figure><p>第二次调用 resume 时，传递参数 4 5，在协程内部，从中断的地方继续执行，
4 5 作为 yield 调用的返回值，赋值与 d e。</p><figure><img src=stdlib-resume-2.png></figure><p>最终协程内部 return 执行结束，resume 执行相同的过程，回收栈上的返回值。</p><figure><img src=stdlib-resume-return-2.png></figure><h3 id=status>status
<a class=anchor href=#status>#</a></h3><p>在 lua.h 中，定义线程状态有如下几种，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#228b22>/* thread status; 0 is OK */</span>
<span style=color:#1e889b>#define LUA_YIELD	1
</span><span style=color:#1e889b>#define LUA_ERRRUN	2
</span><span style=color:#1e889b>#define LUA_ERRSYNTAX	3
</span><span style=color:#1e889b>#define LUA_ERRMEM	4
</span><span style=color:#1e889b>#define LUA_ERRERR	5</span></code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 14</span>:
lua.h</div><p>在线程运行没有出错的情况下，对协程状态的检测会更加细致，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">482
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">483
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">484
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">485
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">486
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">487
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">488
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">489
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">490
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">491
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">492
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">493
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">494
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">495
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">496
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">497
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">498
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">499
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">500
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">501
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">502
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">503
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">504
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">505
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">506
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">507
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">508
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">509
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">510
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">511
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">512
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">513
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">514
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">515
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#1e889b>#define CO_RUN	0	</span><span style=color:#228b22>/* running */</span><span style=color:#1e889b>
</span><span style=color:#1e889b>#define CO_SUS	1	</span><span style=color:#228b22>/* suspended */</span><span style=color:#1e889b>
</span><span style=color:#1e889b>#define CO_NOR	2	</span><span style=color:#228b22>/* &#39;normal&#39; (it resumed another coroutine) */</span><span style=color:#1e889b>
</span><span style=color:#1e889b>#define CO_DEAD	3
</span><span style=color:#1e889b></span>
<span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#8b008b;font-weight:700>const</span> statnames[] =
    {<span style=color:#cd5555>&#34;running&#34;</span>, <span style=color:#cd5555>&#34;suspended&#34;</span>, <span style=color:#cd5555>&#34;normal&#34;</span>, <span style=color:#cd5555>&#34;dead&#34;</span>};

<span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>costatus</span> (lua_State *L, lua_State *co) {
  <span style=color:#8b008b;font-weight:700>if</span> (L == co) <span style=color:#8b008b;font-weight:700>return</span> CO_RUN;
  <span style=color:#8b008b;font-weight:700>switch</span> (lua_status(co)) {
    <span style=color:#8b008b;font-weight:700>case</span> LUA_YIELD:
      <span style=color:#8b008b;font-weight:700>return</span> CO_SUS;
    <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#b452cd>0</span>: {
      lua_Debug ar;
      <span style=color:#8b008b;font-weight:700>if</span> (lua_getstack(co, <span style=color:#b452cd>0</span>, &amp;ar) &gt; <span style=color:#b452cd>0</span>)  <span style=color:#228b22>/* does it have frames? */</span>
	<span style=color:#8b008b;font-weight:700>return</span> CO_NOR;  <span style=color:#228b22>/* it is running */</span>
      <span style=color:#8b008b;font-weight:700>else</span> <span style=color:#8b008b;font-weight:700>if</span> (lua_gettop(co) == <span style=color:#b452cd>0</span>)
	  <span style=color:#8b008b;font-weight:700>return</span> CO_DEAD;
      <span style=color:#8b008b;font-weight:700>else</span>
	<span style=color:#8b008b;font-weight:700>return</span> CO_SUS;  <span style=color:#228b22>/* initial state */</span>
    }
    <span style=color:#8b008b;font-weight:700>default</span>:  <span style=color:#228b22>/* some error occured */</span>
      <span style=color:#8b008b;font-weight:700>return</span> CO_DEAD;
  }
}


<span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>luaB_costatus</span> (lua_State *L) {
  lua_State *co = lua_tothread(L, <span style=color:#b452cd>1</span>);
  luaL_argcheck(L, co, <span style=color:#b452cd>1</span>, <span style=color:#cd5555>&#34;coroutine expected&#34;</span>);
  lua_pushstring(L, statnames[costatus(L, co)]);
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>1</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 15</span>:
lbaselib.c</div><p>在调用 <code>luaB_costatus</code> 时要明确一点，正在调用的线程，正是拥有控制权而正在运行的线程。</p><p><code>CO_RUN</code> 状态，对应于协程自身检测自身的状态，在检测的此刻必然是 running 状态。</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#8b008b;font-weight:700>local</span> co = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>(co)
      print(coroutine.status(co))
<span style=color:#8b008b;font-weight:700>end</span>)

coroutine.resume(co, co)
</code></pre></div><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>running
</code></pre></div><p>在协程刚刚新建/yield 之后，对应的状态为 <code>CO_SUS</code> 。</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#8b008b;font-weight:700>local</span> co = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>()
      coroutine.yield()
<span style=color:#8b008b;font-weight:700>end</span>)

print(coroutine.status(co))
coroutine.resume(co)
print(coroutine.status(co))
</code></pre></div><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>suspended
suspended
</code></pre></div><p>如果协程本身 resume 了其它协程，此刻检测其状态，对应 <code>CO_NOR</code> 。</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#8b008b;font-weight:700>local</span> co = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>(co)
      <span style=color:#8b008b;font-weight:700>local</span> a = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>()
	    print(coroutine.status(co))
      <span style=color:#8b008b;font-weight:700>end</span>)

      coroutine.resume(a)
<span style=color:#8b008b;font-weight:700>end</span>)

coroutine.resume(co, co)
</code></pre></div><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>normal
</code></pre></div><p>当协程执行结束/运行出错，状态都为 <code>CO_DEAD</code> 。</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#8b008b;font-weight:700>local</span> co = coroutine.create(<span style=color:#8b008b;font-weight:700>function</span>()
      coroutine.yield()
<span style=color:#8b008b;font-weight:700>end</span>)

coroutine.resume(co)
coroutine.resume(co)
coroutine.resume(co)

print(coroutine.status(co))
</code></pre></div><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>dead
</code></pre></div><p>需要注意的是，主线程是无法检测状态的，因为在 lua 代码层面根本没有相应的变量来对应其 <code>lua_State</code> 。</p><h2 id=debug>debug
<a class=anchor href=#debug>#</a></h2><p>标准库提供了 debug 库，在 lua 语言层面提供了接口，用于自省和设置钩子。</p><p>debug 库内部的实现可以印证之前所有的描述，这一章就来了解下 debug 库的相关实现。</p><h3 id=getinfo>getinfo
<a class=anchor href=#getinfo>#</a></h3><p>debug 库提供了如下函数，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">375
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">376
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">377
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">378
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">379
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">380
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">381
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">382
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">383
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">384
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">385
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">386
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">387
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">388
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">389
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">390
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">391
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> luaL_Reg dblib[] = {
  {<span style=color:#cd5555>&#34;debug&#34;</span>, db_debug},
  {<span style=color:#cd5555>&#34;getfenv&#34;</span>, db_getfenv},
  {<span style=color:#cd5555>&#34;gethook&#34;</span>, db_gethook},
  {<span style=color:#cd5555>&#34;getinfo&#34;</span>, db_getinfo},
  {<span style=color:#cd5555>&#34;getlocal&#34;</span>, db_getlocal},
  {<span style=color:#cd5555>&#34;getregistry&#34;</span>, db_getregistry},
  {<span style=color:#cd5555>&#34;getmetatable&#34;</span>, db_getmetatable},
  {<span style=color:#cd5555>&#34;getupvalue&#34;</span>, db_getupvalue},
  {<span style=color:#cd5555>&#34;setfenv&#34;</span>, db_setfenv},
  {<span style=color:#cd5555>&#34;sethook&#34;</span>, db_sethook},
  {<span style=color:#cd5555>&#34;setlocal&#34;</span>, db_setlocal},
  {<span style=color:#cd5555>&#34;setmetatable&#34;</span>, db_setmetatable},
  {<span style=color:#cd5555>&#34;setupvalue&#34;</span>, db_setupvalue},
  {<span style=color:#cd5555>&#34;traceback&#34;</span>, db_errorfb},
  {<span style=color:#658b00>NULL</span>, <span style=color:#658b00>NULL</span>}
};</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 16</span>:
ldblib.c</div><p>getinfo 用于运行时自省，可以得到很多运行时的信息。</p><p>根据官方文档<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>的描述，参数 thread 和 what 是可选的。</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>debug.getinfo ([thread,] function [, what])
</code></pre></div><p>在实现中，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> lua_State *<span style=color:#008b45>getthread</span> (lua_State *L, <span style=color:#00688b;font-weight:700>int</span> *arg) {
  <span style=color:#8b008b;font-weight:700>if</span> (lua_isthread(L, <span style=color:#b452cd>1</span>)) {
    *arg = <span style=color:#b452cd>1</span>;
    <span style=color:#8b008b;font-weight:700>return</span> lua_tothread(L, <span style=color:#b452cd>1</span>);
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    *arg = <span style=color:#b452cd>0</span>;
    <span style=color:#8b008b;font-weight:700>return</span> L;
  }
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 17</span>:
ldblib.c</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>db_getinfo</span> (lua_State *L) {
  lua_Debug ar;
  <span style=color:#00688b;font-weight:700>int</span> arg;
  lua_State *L1 = getthread(L, &amp;arg);
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *options = luaL_optstring(L, arg+<span style=color:#b452cd>2</span>, <span style=color:#cd5555>&#34;flnSu&#34;</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (lua_isnumber(L, arg+<span style=color:#b452cd>1</span>)) {
    <span style=color:#8b008b;font-weight:700>if</span> (!lua_getstack(L1, (<span style=color:#00688b;font-weight:700>int</span>)lua_tointeger(L, arg+<span style=color:#b452cd>1</span>), &amp;ar)) {
      lua_pushnil(L);  <span style=color:#228b22>/* level out of range */</span>
      <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>1</span>;
    }
  }
  <span style=color:#8b008b;font-weight:700>else</span> <span style=color:#8b008b;font-weight:700>if</span> (lua_isfunction(L, arg+<span style=color:#b452cd>1</span>)) {
    lua_pushfstring(L, <span style=color:#cd5555>&#34;&gt;%s&#34;</span>, options);
    options = lua_tostring(L, -<span style=color:#b452cd>1</span>);
    lua_pushvalue(L, arg+<span style=color:#b452cd>1</span>);
    lua_xmove(L, L1, <span style=color:#b452cd>1</span>);
  }
  <span style=color:#8b008b;font-weight:700>else</span>
    <span style=color:#8b008b;font-weight:700>return</span> luaL_argerror(L, arg+<span style=color:#b452cd>1</span>, <span style=color:#cd5555>&#34;function or level expected&#34;</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (!lua_getinfo(L1, options, &amp;ar))
    <span style=color:#8b008b;font-weight:700>return</span> luaL_argerror(L, arg+<span style=color:#b452cd>2</span>, <span style=color:#cd5555>&#34;invalid option&#34;</span>);
  lua_createtable(L, <span style=color:#b452cd>0</span>, <span style=color:#b452cd>2</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;S&#39;</span>)) {
    settabss(L, <span style=color:#cd5555>&#34;source&#34;</span>, ar.source);
    settabss(L, <span style=color:#cd5555>&#34;short_src&#34;</span>, ar.short_src);
    settabsi(L, <span style=color:#cd5555>&#34;linedefined&#34;</span>, ar.linedefined);
    settabsi(L, <span style=color:#cd5555>&#34;lastlinedefined&#34;</span>, ar.lastlinedefined);
    settabss(L, <span style=color:#cd5555>&#34;what&#34;</span>, ar.what);
  }
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;l&#39;</span>))
    settabsi(L, <span style=color:#cd5555>&#34;currentline&#34;</span>, ar.currentline);
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;u&#39;</span>))
    settabsi(L, <span style=color:#cd5555>&#34;nups&#34;</span>, ar.nups);
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;n&#39;</span>)) {
    settabss(L, <span style=color:#cd5555>&#34;name&#34;</span>, ar.name);
    settabss(L, <span style=color:#cd5555>&#34;namewhat&#34;</span>, ar.namewhat);
  }
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;L&#39;</span>))
    treatstackoption(L, L1, <span style=color:#cd5555>&#34;activelines&#34;</span>);
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(options, <span style=color:#cd5555>&#39;f&#39;</span>))
    treatstackoption(L, L1, <span style=color:#cd5555>&#34;func&#34;</span>);
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>1</span>;  <span style=color:#228b22>/* return table */</span>
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 18</span>:
ldblib.c</div><p>如果没有 thread，则从当前线程获取信息；如果没有 what，默认为 &ldquo;flnSu&rdquo;。</p><p>在 line 118 调用 <code>lua_getinfo</code> 来获取信息。</p><p>其中根据需要获取的信息的缩写，将所有信息存储到 <code>lua_Debug</code> 结构中返回。
不同的缩写对应不同的字段。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">346
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">347
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">348
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">349
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">350
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">351
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">352
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">353
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">354
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">355
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">356
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">357
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">358
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">359
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>struct</span> lua_Debug {
  <span style=color:#00688b;font-weight:700>int</span> event;
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *name;	<span style=color:#228b22>/* (n) */</span>
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *namewhat;	<span style=color:#228b22>/* (n) `global&#39;, `local&#39;, `field&#39;, `method&#39; */</span>
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *what;	<span style=color:#228b22>/* (S) `Lua&#39;, `C&#39;, `main&#39;, `tail&#39; */</span>
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *source;	<span style=color:#228b22>/* (S) */</span>
  <span style=color:#00688b;font-weight:700>int</span> currentline;	<span style=color:#228b22>/* (l) */</span>
  <span style=color:#00688b;font-weight:700>int</span> nups;		<span style=color:#228b22>/* (u) number of upvalues */</span>
  <span style=color:#00688b;font-weight:700>int</span> linedefined;	<span style=color:#228b22>/* (S) */</span>
  <span style=color:#00688b;font-weight:700>int</span> lastlinedefined;	<span style=color:#228b22>/* (S) */</span>
  <span style=color:#00688b;font-weight:700>char</span> short_src[LUA_IDSIZE]; <span style=color:#228b22>/* (S) */</span>
  <span style=color:#228b22>/* private part */</span>
  <span style=color:#00688b;font-weight:700>int</span> i_ci;  <span style=color:#228b22>/* active function */</span>
};</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 19</span>:
lua.h</div><p>在 <code>lua_getinfo</code> 内部，就是分别获取不同信息再整合到 <code>lua_Debug</code> 的过程。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">216
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">217
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">218
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">219
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">220
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">221
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">222
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">223
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">224
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">225
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">226
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">227
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">228
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">232
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">233
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">234
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">235
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">236
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">237
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">238
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">239
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">240
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">241
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">242
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">243
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">244
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">245
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">246
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">247
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">248
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">249
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">250
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">251
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">252
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">253
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">254
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">255
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">256
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">257
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">258
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">259
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>auxgetinfo</span> (lua_State *L, <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *what, lua_Debug *ar,
		    Closure *f, CallInfo *ci) {
  <span style=color:#00688b;font-weight:700>int</span> status = <span style=color:#b452cd>1</span>;
  <span style=color:#8b008b;font-weight:700>if</span> (f == <span style=color:#658b00>NULL</span>) {
    info_tailcall(ar);
    <span style=color:#8b008b;font-weight:700>return</span> status;
  }
  <span style=color:#8b008b;font-weight:700>for</span> (; *what; what++) {
    <span style=color:#8b008b;font-weight:700>switch</span> (*what) {
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;S&#39;</span>: {
	funcinfo(ar, f);
	<span style=color:#8b008b;font-weight:700>break</span>;
      }
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;l&#39;</span>: {
	ar-&gt;currentline = (ci) ? currentline(L, ci) : -<span style=color:#b452cd>1</span>;
	<span style=color:#8b008b;font-weight:700>break</span>;
      }
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;u&#39;</span>: {
	ar-&gt;nups = f-&gt;c.nupvalues;
	<span style=color:#8b008b;font-weight:700>break</span>;
      }
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;n&#39;</span>: {
	ar-&gt;namewhat = (ci) ? getfuncname(L, ci, &amp;ar-&gt;name) : <span style=color:#658b00>NULL</span>;
	<span style=color:#8b008b;font-weight:700>if</span> (ar-&gt;namewhat == <span style=color:#658b00>NULL</span>) {
	  ar-&gt;namewhat = <span style=color:#cd5555>&#34;&#34;</span>;  <span style=color:#228b22>/* not found */</span>
	  ar-&gt;name = <span style=color:#658b00>NULL</span>;
	}
	<span style=color:#8b008b;font-weight:700>break</span>;
      }
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;L&#39;</span>:
      <span style=color:#8b008b;font-weight:700>case</span> <span style=color:#cd5555>&#39;f&#39;</span>:  <span style=color:#228b22>/* handled by lua_getinfo */</span>
	<span style=color:#8b008b;font-weight:700>break</span>;
      <span style=color:#8b008b;font-weight:700>default</span>: status = <span style=color:#b452cd>0</span>;  <span style=color:#228b22>/* invalid option */</span>
    }
  }
  <span style=color:#8b008b;font-weight:700>return</span> status;
}


LUA_API <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>lua_getinfo</span> (lua_State *L, <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *what, lua_Debug *ar) {
  <span style=color:#00688b;font-weight:700>int</span> status;
  Closure *f = <span style=color:#658b00>NULL</span>;
  CallInfo *ci = <span style=color:#658b00>NULL</span>;
  lua_lock(L);
  <span style=color:#8b008b;font-weight:700>if</span> (*what == <span style=color:#cd5555>&#39;&gt;&#39;</span>) {
    StkId func = L-&gt;top - <span style=color:#b452cd>1</span>;
    luai_apicheck(L, ttisfunction(func));
    what++;  <span style=color:#228b22>/* skip the &#39;&gt;&#39; */</span>
    f = clvalue(func);
    L-&gt;top--;  <span style=color:#228b22>/* pop function */</span>
  }
  <span style=color:#8b008b;font-weight:700>else</span> <span style=color:#8b008b;font-weight:700>if</span> (ar-&gt;i_ci != <span style=color:#b452cd>0</span>) {  <span style=color:#228b22>/* no tail call? */</span>
    ci = L-&gt;base_ci + ar-&gt;i_ci;
    lua_assert(ttisfunction(ci-&gt;func));
    f = clvalue(ci-&gt;func);
  }
  status = auxgetinfo(L, what, ar, f, ci);
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(what, <span style=color:#cd5555>&#39;f&#39;</span>)) {
    <span style=color:#8b008b;font-weight:700>if</span> (f == <span style=color:#658b00>NULL</span>) setnilvalue(L-&gt;top);
    <span style=color:#8b008b;font-weight:700>else</span> setclvalue(L, L-&gt;top, f);
    incr_top(L);
  }
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(what, <span style=color:#cd5555>&#39;L&#39;</span>))
    collectvalidlines(L, f);
  lua_unlock(L);
  <span style=color:#8b008b;font-weight:700>return</span> status;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 20</span>:
ldebug.c</div><p>结合官方文档<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>，不难理解 getinfo 的行为。</p><h3 id=getlocal>getlocal
<a class=anchor href=#getlocal>#</a></h3><p>getlocal 方法，最终深入到 func 模块中的 <code>luaF_getlocalname</code> 函数，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#008b45>findlocal</span> (lua_State *L, CallInfo *ci, <span style=color:#00688b;font-weight:700>int</span> n) {
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *name;
  Proto *fp = getluaproto(ci);
  <span style=color:#8b008b;font-weight:700>if</span> (fp &amp;&amp; (name = luaF_getlocalname(fp, n, currentpc(L, ci))) != <span style=color:#658b00>NULL</span>)
    <span style=color:#8b008b;font-weight:700>return</span> name;  <span style=color:#228b22>/* is a local variable in a Lua function */</span>
  <span style=color:#8b008b;font-weight:700>else</span> {
    StkId limit = (ci == L-&gt;ci) ? L-&gt;top : (ci+<span style=color:#b452cd>1</span>)-&gt;func;
    <span style=color:#8b008b;font-weight:700>if</span> (limit - ci-&gt;base &gt;= n &amp;&amp; n &gt; <span style=color:#b452cd>0</span>)  <span style=color:#228b22>/* is &#39;n&#39; inside &#39;ci&#39; stack? */</span>
      <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#cd5555>&#34;(*temporary)&#34;</span>;
    <span style=color:#8b008b;font-weight:700>else</span>
      <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#658b00>NULL</span>;
  }
}


LUA_API <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#008b45>lua_getlocal</span> (lua_State *L, <span style=color:#8b008b;font-weight:700>const</span> lua_Debug *ar, <span style=color:#00688b;font-weight:700>int</span> n) {
  CallInfo *ci = L-&gt;base_ci + ar-&gt;i_ci;
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *name = findlocal(L, ci, n);
  lua_lock(L);
  <span style=color:#8b008b;font-weight:700>if</span> (name)
      luaA_pushobject(L, ci-&gt;base + (n - <span style=color:#b452cd>1</span>));
  lua_unlock(L);
  <span style=color:#8b008b;font-weight:700>return</span> name;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 21</span>:
ldebug.c</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#228b22>/*
</span><span style=color:#228b22>** Look for n-th local variable at line `line&#39; in function `func&#39;.
</span><span style=color:#228b22>** Returns NULL if not found.
</span><span style=color:#228b22>*/</span>
<span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#008b45>luaF_getlocalname</span> (<span style=color:#8b008b;font-weight:700>const</span> Proto *f, <span style=color:#00688b;font-weight:700>int</span> local_number, <span style=color:#00688b;font-weight:700>int</span> pc) {
  <span style=color:#00688b;font-weight:700>int</span> i;
  <span style=color:#8b008b;font-weight:700>for</span> (i = <span style=color:#b452cd>0</span>; i&lt;f-&gt;sizelocvars &amp;&amp; f-&gt;locvars[i].startpc &lt;= pc; i++) {
    <span style=color:#8b008b;font-weight:700>if</span> (pc &lt; f-&gt;locvars[i].endpc) {  <span style=color:#228b22>/* is variable active? */</span>
      local_number--;
      <span style=color:#8b008b;font-weight:700>if</span> (local_number == <span style=color:#b452cd>0</span>)
	<span style=color:#8b008b;font-weight:700>return</span> getstr(f-&gt;locvars[i].varname);
    }
  }
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#658b00>NULL</span>;  <span style=color:#228b22>/* not found */</span>
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 22</span>:
lfunc.c</div><p>其中正是通过 <code>f->locvars</code> 来进行寻找，这和 generator 章节是相同的。</p><h3 id=getupval>getupval
<a class=anchor href=#getupval>#</a></h3><p>getupval 方法，最终调用 api 模块中的 <code>lua_getupvalue</code> 函数，</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1039
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1040
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1041
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1042
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1043
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1044
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1045
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1046
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1047
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1048
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1049
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1050
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1051
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1052
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1053
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1054
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1055
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1056
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1057
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1058
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1059
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1060
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1061
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1062
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1063
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1064
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1065
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1066
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1067
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1068
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#008b45>aux_upvalue</span> (StkId fi, <span style=color:#00688b;font-weight:700>int</span> n, TValue **val) {
  Closure *f;
  <span style=color:#8b008b;font-weight:700>if</span> (!ttisfunction(fi)) <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#658b00>NULL</span>;
  f = clvalue(fi);
  <span style=color:#8b008b;font-weight:700>if</span> (f-&gt;c.isC) {
    <span style=color:#8b008b;font-weight:700>if</span> (!(<span style=color:#b452cd>1</span> &lt;= n &amp;&amp; n &lt;= f-&gt;c.nupvalues)) <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#658b00>NULL</span>;
    *val = &amp;f-&gt;c.upvalue[n-<span style=color:#b452cd>1</span>];
    <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#cd5555>&#34;&#34;</span>;
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    Proto *p = f-&gt;l.p;
    <span style=color:#8b008b;font-weight:700>if</span> (!(<span style=color:#b452cd>1</span> &lt;= n &amp;&amp; n &lt;= p-&gt;sizeupvalues)) <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#658b00>NULL</span>;
    *val = f-&gt;l.upvals[n-<span style=color:#b452cd>1</span>]-&gt;v;
    <span style=color:#8b008b;font-weight:700>return</span> getstr(p-&gt;upvalues[n-<span style=color:#b452cd>1</span>]);
  }
}


LUA_API <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *<span style=color:#008b45>lua_getupvalue</span> (lua_State *L, <span style=color:#00688b;font-weight:700>int</span> funcindex, <span style=color:#00688b;font-weight:700>int</span> n) {
  <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *name;
  TValue *val;
  lua_lock(L);
  name = aux_upvalue(index2adr(L, funcindex), n, &amp;val);
  <span style=color:#8b008b;font-weight:700>if</span> (name) {
    setobj2s(L, L-&gt;top, val);
    api_incr_top(L);
  }
  lua_unlock(L);
  <span style=color:#8b008b;font-weight:700>return</span> name;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 23</span>:
lapi.c</div><p>其中正是通过 <code>Closure.upvalues</code> 来寻找 upval 的。</p><h3 id=hook>hook
<a class=anchor href=#hook>#</a></h3><p>debug 模块提供的另一方面的功能就是 hook。</p><p>hook 有 4 种类型<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>， 分别为 <code>call return line count</code> 。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">308
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">309
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">310
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">311
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">312
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">313
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">314
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">315
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">316
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">317
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">318
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">319
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">320
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">321
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">322
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">323
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">324
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#228b22>/*
</span><span style=color:#228b22>** Event codes
</span><span style=color:#228b22>*/</span>
<span style=color:#1e889b>#define LUA_HOOKCALL	0
</span><span style=color:#1e889b>#define LUA_HOOKRET	1
</span><span style=color:#1e889b>#define LUA_HOOKLINE	2
</span><span style=color:#1e889b>#define LUA_HOOKCOUNT	3
</span><span style=color:#1e889b>#define LUA_HOOKTAILRET 4
</span><span style=color:#1e889b></span>

<span style=color:#228b22>/*
</span><span style=color:#228b22>** Event masks
</span><span style=color:#228b22>*/</span>
<span style=color:#1e889b>#define LUA_MASKCALL	(1 &lt;&lt; LUA_HOOKCALL)
</span><span style=color:#1e889b>#define LUA_MASKRET	(1 &lt;&lt; LUA_HOOKRET)
</span><span style=color:#1e889b>#define LUA_MASKLINE	(1 &lt;&lt; LUA_HOOKLINE)
</span><span style=color:#1e889b>#define LUA_MASKCOUNT	(1 &lt;&lt; LUA_HOOKCOUNT)</span></code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 24</span>:
lua.h</div><p>sethook 先解析 mask 和 count，再调用 <code>lua_sethook</code> 设置 hook。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">225
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">226
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">227
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">228
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">232
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>makemask</span> (<span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *smask, <span style=color:#00688b;font-weight:700>int</span> count) {
  <span style=color:#00688b;font-weight:700>int</span> mask = <span style=color:#b452cd>0</span>;
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(smask, <span style=color:#cd5555>&#39;c&#39;</span>)) mask |= LUA_MASKCALL;
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(smask, <span style=color:#cd5555>&#39;r&#39;</span>)) mask |= LUA_MASKRET;
  <span style=color:#8b008b;font-weight:700>if</span> (strchr(smask, <span style=color:#cd5555>&#39;l&#39;</span>)) mask |= LUA_MASKLINE;
  <span style=color:#8b008b;font-weight:700>if</span> (count &gt; <span style=color:#b452cd>0</span>) mask |= LUA_MASKCOUNT;
  <span style=color:#8b008b;font-weight:700>return</span> mask;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 25</span>:
ldblib.c</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">258
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">259
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">260
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">261
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">262
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">263
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">264
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">265
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">266
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">267
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">268
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">269
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">270
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">271
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">272
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">273
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">274
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">275
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">276
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">277
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">278
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">279
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#8b008b;font-weight:700>static</span> <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>db_sethook</span> (lua_State *L) {
  <span style=color:#00688b;font-weight:700>int</span> arg, mask, count;
  lua_Hook func;
  lua_State *L1 = getthread(L, &amp;arg);
  <span style=color:#8b008b;font-weight:700>if</span> (lua_isnoneornil(L, arg+<span style=color:#b452cd>1</span>)) {
    lua_settop(L, arg+<span style=color:#b452cd>1</span>);
    func = <span style=color:#658b00>NULL</span>; mask = <span style=color:#b452cd>0</span>; count = <span style=color:#b452cd>0</span>;  <span style=color:#228b22>/* turn off hooks */</span>
  }
  <span style=color:#8b008b;font-weight:700>else</span> {
    <span style=color:#8b008b;font-weight:700>const</span> <span style=color:#00688b;font-weight:700>char</span> *smask = luaL_checkstring(L, arg+<span style=color:#b452cd>2</span>);
    luaL_checktype(L, arg+<span style=color:#b452cd>1</span>, LUA_TFUNCTION);
    count = luaL_optint(L, arg+<span style=color:#b452cd>3</span>, <span style=color:#b452cd>0</span>);
    func = hookf; mask = makemask(smask, count);
  }
  gethooktable(L);
  lua_pushlightuserdata(L, L1);
  lua_pushvalue(L, arg+<span style=color:#b452cd>1</span>);
  lua_rawset(L, -<span style=color:#b452cd>3</span>);  <span style=color:#228b22>/* set new hook */</span>
  lua_pop(L, <span style=color:#b452cd>1</span>);  <span style=color:#228b22>/* remove hook table */</span>
  lua_sethook(L1, func, mask, count);  <span style=color:#228b22>/* set hooks */</span>
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>0</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 26</span>:
ldblib.c</div><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#228b22>/*
</span><span style=color:#228b22>** this function can be called asynchronous (e.g. during a signal)
</span><span style=color:#228b22>*/</span>
LUA_API <span style=color:#00688b;font-weight:700>int</span> <span style=color:#008b45>lua_sethook</span> (lua_State *L, lua_Hook func, <span style=color:#00688b;font-weight:700>int</span> mask, <span style=color:#00688b;font-weight:700>int</span> count) {
  <span style=color:#8b008b;font-weight:700>if</span> (func == <span style=color:#658b00>NULL</span> || mask == <span style=color:#b452cd>0</span>) {  <span style=color:#228b22>/* turn off hooks? */</span>
    mask = <span style=color:#b452cd>0</span>;
    func = <span style=color:#658b00>NULL</span>;
  }
  L-&gt;hook = func;
  L-&gt;basehookcount = count;
  resethookcount(L);
  L-&gt;hookmask = cast_byte(mask);
  <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>1</span>;
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 27</span>:
ldebug.c</div><p>其中将所有 hook 信息存储到当前 <code>lua_State</code> 中。</p><p>hook 调用的时间点散落在 lvm.c 和 ldo.c 中，全部通过 <code>luaD_callhook</code> 来调用。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#00688b;font-weight:700>void</span> <span style=color:#008b45>luaD_callhook</span> (lua_State *L, <span style=color:#00688b;font-weight:700>int</span> event, <span style=color:#00688b;font-weight:700>int</span> line) {
  lua_Hook hook = L-&gt;hook;
  <span style=color:#8b008b;font-weight:700>if</span> (hook &amp;&amp; L-&gt;allowhook) {
    ptrdiff_t top = savestack(L, L-&gt;top);
    ptrdiff_t ci_top = savestack(L, L-&gt;ci-&gt;top);
    lua_Debug ar;
    ar.event = event;
    ar.currentline = line;
    <span style=color:#8b008b;font-weight:700>if</span> (event == LUA_HOOKTAILRET)
      ar.i_ci = <span style=color:#b452cd>0</span>;  <span style=color:#228b22>/* tail call; no debug information about it */</span>
    <span style=color:#8b008b;font-weight:700>else</span>
      ar.i_ci = cast_int(L-&gt;ci - L-&gt;base_ci);
    luaD_checkstack(L, LUA_MINSTACK);  <span style=color:#228b22>/* ensure minimum stack size */</span>
    L-&gt;ci-&gt;top = L-&gt;top + LUA_MINSTACK;
    lua_assert(L-&gt;ci-&gt;top &lt;= L-&gt;stack_last);
    L-&gt;allowhook = <span style=color:#b452cd>0</span>;  <span style=color:#228b22>/* cannot call hooks inside a hook */</span>
    lua_unlock(L);
    (*hook)(L, &amp;ar);
    lua_lock(L);
    lua_assert(!L-&gt;allowhook);
    L-&gt;allowhook = <span style=color:#b452cd>1</span>;
    L-&gt;ci-&gt;top = restorestack(L, ci_top);
    L-&gt;top = restorestack(L, top);
  }
}</code></pre></td></tr></table></div></div><div class=src-block-caption><span class=src-block-number>Code Snippet 28</span>:
ldo.c</div><p>可能通过搜索 <code>luaD_callhook</code> 的调用位置，确认不同的 mask 对应的调用时机，
这一点和 vm 的运行相关，细节就不再赘述。</p><h2 id=practice>practice
<a class=anchor href=#practice>#</a></h2><p>标准库的代码量并不小，但是安排的架构很清晰，读者可根据自己的需要和兴趣有目的的按点阅读。</p><table><thead><tr><th>章节涉及文件</th><th>建议阅读程度</th></tr></thead><tbody><tr><td>linit.c</td><td>★ ★ ★ ★ ★</td></tr><tr><td>lbaselib.c</td><td>★ ★ ★ ★ ☆</td></tr><tr><td>lmathlib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>lstrlib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>ltablib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>liolib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>loslib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>loadlib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>ldblib.c</td><td>★ ★ ☆ ☆ ☆</td></tr><tr><td>ldebug.c</td><td>★ ★ ☆ ☆ ☆</td></tr></tbody></table><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#5>http://www.lua.org/manual/5.1/manual.html#5</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#5.9>http://www.lua.org/manual/5.1/manual.html#5.9</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#lua%5Fgetinfo>http://www.lua.org/manual/5.1/manual.html#lua%5Fgetinfo</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>: <a href=http://www.lua.org/manual/5.1/manual.html#lua%5Fsethook>http://www.lua.org/manual/5.1/manual.html#lua%5Fsethook</a> <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/DreamAndDead/lua-5.1-source-guide/commit/8c359ebae66c3a96c4a0c7ed6ba49ad52483055a title="最后修改者 DreamAndDead | February 23, 2021" target=_blank rel=noopener><img src=/lua-5.1-source-guide/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 23, 2021</span></a></div><div><a class="flex align-center" href=https://github.com/DreamAndDead/lua-5.1-source-guide/edit/master/site/content/docs/stdlib/index.md target=_blank rel=noopener><img src=/lua-5.1-source-guide/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span></a></div></div></footer><div class=book-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lua-book"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#register>register</a></li><li><a href=#module>module</a></li><li><a href=#coroutine>coroutine</a><ul><li><a href=#create>create</a></li><li><a href=#resume-and-yield>resume & yield</a></li><li><a href=#status>status</a></li></ul></li><li><a href=#debug>debug</a><ul><li><a href=#getinfo>getinfo</a></li><li><a href=#getlocal>getlocal</a></li><li><a href=#getupval>getupval</a></li><li><a href=#hook>hook</a></li></ul></li><li><a href=#practice>practice</a></li></ul></li></ul></nav></div></aside></main></body></html>