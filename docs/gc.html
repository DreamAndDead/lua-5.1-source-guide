<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-01-20 三 17:54 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>gc</title>
<meta name="generator" content="Org mode">
<meta name="author" content="DreamAndDead">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link id="theme" rel="stylesheet" type="text/css" href="htmlize.css">
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">gc</h1>
<p>
本章来讲解 Lua 内部实现的 gc 机制。
</p>

<div id="outline-container-org01d7562" class="outline-2">
<h2 id="org01d7562"><span class="section-number-2">1</span> algo</h2>
<div class="outline-text-2" id="text-1">
<p>
gc 算法有很多种，Lua 采用一种增量式三色标记清除算法来实现 gc 机制。
</p>

<p>
之所以说一种，是因为采用的 gc 算法与其说是一个算法，不如说是一类算法，
大体的思想是相同的，不过在实现细节有些许不同。
</p>
</div>

<div id="outline-container-org66923ba" class="outline-3">
<h3 id="org66923ba"><span class="section-number-3">1.1</span> mark &amp; sweep</h3>
<div class="outline-text-3" id="text-1-1">
<p>
深入之前，先来了解一下经典的双色标记清除算法。
</p>

<p>
初始阶段，新建的所有的对象，标记为白色，
</p>


<div id="org87725de" class="figure">
<p><img src="gc-2-color-root.png" alt="gc-2-color-root.png">
</p>
</div>

<p>
标记阶段，将所有从 root 可达的对象标记为黑色；
</p>


<div id="orgabca1ea" class="figure">
<p><img src="gc-2-color-root-1.png" alt="gc-2-color-root-1.png">
</p>
</div>

<p>
回收阶段，将所有白色对象回收，同时将所有黑色对象重新标记回白色；
</p>


<div id="org50d09f7" class="figure">
<p><img src="gc-2-color-root-2.png" alt="gc-2-color-root-2.png">
</p>
</div>

<p>
gc 的过程，所有对象在两种颜色间完成标记和清理。
</p>


<div id="org7d50276" class="figure">
<p><img src="gc-2-color.png" alt="gc-2-color.png">
</p>
</div>


<div id="org9bb4551" class="figure">
<p><img src="gc-not-inc.png" alt="gc-not-inc.png">
</p>
</div>

<p>
非增量
</p>

<p>
collect 过程必须执行结束，才能执行程序
</p>
</div>
</div>


<div id="outline-container-orgdb68781" class="outline-3">
<h3 id="orgdb68781"><span class="section-number-3">1.2</span> tri color inc mark and sweep</h3>
<div class="outline-text-3" id="text-1-2">

<div id="org8b25b56" class="figure">
<p><img src="gc-3-color.png" alt="gc-3-color.png">
</p>
</div>

<p>
barrier
</p>
</div>
</div>




<div id="outline-container-org0c87f84" class="outline-3">
<h3 id="org0c87f84"><span class="section-number-3">1.3</span> 4 color</h3>
<div class="outline-text-3" id="text-1-3">
<p>
double white
</p>


<p>
Tables use backward barriers, all other traversable objects use forward barriers.
</p>


<p>
A write barrier in a garbage collector is a fragment of code emitted by the compiler immediately before every store operation to ensure that (e.g.) generational invariants are maintained.”
</p>
</div>
</div>
</div>



<div id="outline-container-orgabfdbd7" class="outline-2">
<h2 id="orgabfdbd7"><span class="section-number-2">2</span> reality</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgb8ff4c6" class="outline-3">
<h3 id="orgb8ff4c6"><span class="section-number-3">2.1</span> state</h3>
<div class="outline-text-3" id="text-2-1">

<div id="org20fcf78" class="figure">
<p><img src="gc-state.png" alt="gc-state.png">
</p>
</div>
</div>
</div>


<div id="outline-container-orgef9abdc" class="outline-3">
<h3 id="orgef9abdc"><span class="section-number-3">2.2</span> gclist</h3>
<div class="outline-text-3" id="text-2-2">
<p>
g-&gt;grey
-&gt;gclist
</p>


<p>
g-&gt;grayagain
</p>

<p>
g-&gt;rootgc
</p>
</div>
</div>


<div id="outline-container-org8cbe035" class="outline-3">
<h3 id="org8cbe035"><span class="section-number-3">2.3</span> bit</h3>
<div class="outline-text-3" id="text-2-3">

<div id="org3cedd50" class="figure">
<p><img src="gc-bit-mark.png" alt="gc-bit-mark.png">
</p>
</div>

<p>
Simple description
The Lua garbage collector is a mark &amp; sweep collector. The collector has two major phases mark &amp; sweep that it runs each collection cycle. During the mark phases the collector traverse the Lua stack and into tables to mark values it finds as live. Next the sweep phases will walk a list of all collectible values and free all dead values it finds.
</p>

<p>
Detailed description
All collectible type objects have a 'marked' bit field. The bits are defined as (copied from header "lgc.h"):
</p>

<p>
bit 0 - object is white (type 0)
bit 1 - object is white (type 1)
bit 2 - object is black
bit 3 - for userdata: has been finalized
bit 3 - for tables: has weak keys (note this bit has two different meanings one for userdata and one for tables)
bit 4 - for tables: has weak values
bit 5 - object is fixed (should not be collected)
bit 6 - object is "super" fixed (only the main thread) 
</p>

<p>
The garbage collector keeps track of a current white (type 0 or 1) and objects with the other white are dead objects that can be collected during the sweep states.
</p>

<p>
An object's color is defined by which of the first 3 bits (0, 1, 2) are set:
</p>

<p>
It is white if one of the two white bits (0,1) are set and the black bit is clear. Only one white bit should be used by a white object.
It is gray if all three color bits (0,1,2) are clear.
It is black if the black bit is set and the two white bits are clear. 
</p>

<p>
Garbage collector states (each collection cycle passes through these states in this order):
</p>

<p>
GCSpause - Start of collection cycle. At this state all objects should be marked with the current white. The main lua<sub>State</sub>, globals table, registry, and metatables are marked gray and added to the gray list. The state now changes to GCSpropagate.
GCSpropagate - Each object in the gray list is removed and marked black, then any white (type 0 or 1) objects it references are marked gray and added to the gray list. Once the gray list is empty the current white is switched to the other white. All objects marked with the old white type are now dead objects. The state now changes to GCSsweepstring.
GCSsweepstring - The color of each string in the internal strings hashtable is checked. If the color matches the old white type that string is dead and is freed. If the color matches the current white (newly created string) or is gray (some other object references it), then it is alive and its color is reset to the current white. Once all strings are checked the state is changed to GCSsweep.
GCSsweep - The color of each objects in the global rootgc list (this list holds all objects except strings) is checked just like the strings during the GCSsweepstring state. Dead objects are freed and removed from the rootgc list. Live objects have their color reset to the current white. Once all objects have been checked the state is changed to GCSfinalize.
GCSfinalize - This state will finalize all dead userdata objects by running their "_<sub>gc</sub>" metamethod. Once all dead userdata objects have been finailzed the state is changed to GCSpause and this completes a cycle of the garbage collector. 
</p>




<p>
<a href="http://wiki.luajit.org/New-Garbage-Collector">http://wiki.luajit.org/New-Garbage-Collector</a>
</p>

<p>
<a href="https://www.zhihu.com/question/62000722">https://www.zhihu.com/question/62000722</a>
</p>

<p>
<a href="https://juejin.cn/post/6844903896368824328">https://juejin.cn/post/6844903896368824328</a>
</p>

<p>
<a href="http://www.lua.org/manual/5.1/manual.html#2.10">http://www.lua.org/manual/5.1/manual.html#2.10</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org64ef47d" class="outline-2">
<h2 id="org64ef47d"><span class="section-number-2">3</span> weaktable</h2>
<div class="outline-text-2" id="text-3">
<p>
Tables use backward barriers, all other traversable objects use forward barriers.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

<p>Revised: 2021-01-20 三 17:54</p>
<p>Created: 2021-01-19 二 15:16</p>
<p>Author: DreamAndDead</p>
<p>Email: <a href="mailto:dreamanddead@foxmail.com">dreamanddead@foxmail.com</a></p>
<script src="https://utteranc.es/client.js" repo="DreamAndDead/DreamAndDead.github.io" issue-term="pathname" label="Comment" theme="github-light" crossorigin="anonymous" async></script>
</div>
</body>
</html>
