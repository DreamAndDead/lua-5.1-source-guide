<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-01-14 四 17:47 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>opcode</title>
<meta name="generator" content="Org mode">
<meta name="author" content="DreamAndDead">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link id="theme" rel="stylesheet" type="text/css" href="htmlize.css">
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">opcode</h1>
<p>
按顺序，本章应该讲解 parser 相关的内容。
</p>

<p>
之前提到，parser 模块将语法分析与代码生成揉合在一起，为了更容易理解 parser 的功能，
先对最终生成的代码 opcode 做一些了解，到时就可以带着目的去阅读。
</p>

<p>
opcode 字节码，是编译阶段的最终结果。
类比来看，C 编译为机器码，由机器执行；lua 编译为 opcode 由 vm 执行。
</p>

<p>
可以说，opcode 是上层 lua 代码与 vm 的中间层，是语义的约定。
本章关注 opcode 的表示方式及含义。
</p>

<div id="outline-container-org3a86c34" class="outline-2">
<h2 id="org3a86c34"><span class="section-number-2">1</span> format</h2>
<div class="outline-text-2" id="text-1">
<p>
所有 opcode 都是定长的，4 bytes 32 bits，单个指令用 unsigned int 表示。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>llimits.h</label><pre class="src src-C"><span class="linenr">84: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">85: </span><span class="org-comment">** type for virtual-machine instructions</span>
<span class="linenr">86: </span><span class="org-comment">** must be an unsigned with (at least) 4 bytes (see details in lopcodes.h)</span>
<span class="linenr">87: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">88: </span><span class="org-keyword">typedef</span> <span class="org-type">lu_int32</span> <span class="org-type">Instruction</span>;
</pre>
</div>

<p>
指令内部可分为类型和参数两部分，根据参数的安排方式，所有指令可分为 3 类操作模式。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">31: </span><span class="org-keyword">enum</span> <span class="org-type">OpMode</span> {<span class="org-variable-name">iABC</span>, <span class="org-variable-name">iABx</span>, <span class="org-variable-name">iAsBx</span>};  <span class="org-comment-delimiter">/* </span><span class="org-comment">basic instruction format</span><span class="org-comment-delimiter"> */</span>
</pre>
</div>

<ul class="org-ul">
<li>iABC，接受 A B C 三个参数</li>
<li>iABx，接受 A Bx 两个参数</li>
<li>iAsBx，接受 A sBx 两个参数</li>
</ul>

<p>
A B C Bx 是无符号数，而 sBx 是有符号数（s 即 signed）。
</p>


<div id="org89aa428" class="figure">
<p><img src="opcode-format.png" alt="opcode-format.png">
</p>
</div>

<p>
三种类型的指令在 32 bits 的空间中进行如下的划分
</p>
<ul class="org-ul">
<li>Op 表示指令类型，占据 6 bits，在最低位</li>
<li>A C B 分别占据 8 9 9 bits，从低位到高位排列</li>
<li>Bx 占据 B C 两者的空间</li>
<li>sBx 和 Bx 占据的空间相同，不过解析为有符号数</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>lopcodes.h</label><pre class="src src-C"><span class="linenr">34: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">35: </span><span class="org-comment">** size and position of opcode arguments.</span>
<span class="linenr">36: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">37: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">SIZE_C</span>          9
<span class="linenr">38: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">SIZE_B</span>          9
<span class="linenr">39: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">SIZE_Bx</span>         (SIZE_C + SIZE_B)
<span class="linenr">40: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">SIZE_A</span>          8
<span class="linenr">41: </span>
<span class="linenr">42: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">SIZE_OP</span>         6
<span class="linenr">43: </span>
<span class="linenr">44: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">POS_OP</span>          0
<span class="linenr">45: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">POS_A</span>           (POS_OP + SIZE_OP)
<span class="linenr">46: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">POS_C</span>           (POS_A + SIZE_A)
<span class="linenr">47: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">POS_B</span>           (POS_C + SIZE_C)
<span class="linenr">48: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">POS_Bx</span>          POS_C
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcde4062" class="outline-2">
<h2 id="orgcde4062"><span class="section-number-2">2</span> param</h2>
<div class="outline-text-2" id="text-2">
<p>
A C B 的长度分别是 8 9 9 bits，都解析为无符号数。
Bx 占据 18 位，解析为无符号数。
sBx 和 Bx 占据同一空间，但是解析为有符号数。
</p>

<p>
不同参数表示不同的范围。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">param</th>
<th scope="col" class="org-right">len(bits)</th>
<th scope="col" class="org-left">range</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">A</td>
<td class="org-right">8</td>
<td class="org-left">0 -&gt; 2<sup>8</sup> - 1</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-right">9</td>
<td class="org-left">0 -&gt; 2<sup>9</sup> - 1</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-right">9</td>
<td class="org-left">0 -&gt; 2<sup>9</sup> - 1</td>
</tr>

<tr>
<td class="org-left">Bx</td>
<td class="org-right">18</td>
<td class="org-left">0 -&gt; 2<sup>18</sup> - 1</td>
</tr>

<tr>
<td class="org-left">sBx</td>
<td class="org-right">18</td>
<td class="org-left">-(2<sup>17</sup> - 1) -&gt; 2<sup>17</sup> - 1</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">65: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXARG_A</span>        ((1&lt;&lt;SIZE_A)-1)
<span class="linenr">66: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXARG_B</span>        ((1&lt;&lt;SIZE_B)-1)
<span class="linenr">67: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXARG_C</span>        ((1&lt;&lt;SIZE_C)-1)
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">57: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXARG_Bx</span>        ((1&lt;&lt;SIZE_Bx)-1)
<span class="linenr">58: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXARG_sBx</span>        (MAXARG_Bx&gt;&gt;1)         <span class="org-comment-delimiter">/* </span><span class="org-comment">`sBx' is signed</span><span class="org-comment-delimiter"> */</span>
</pre>
</div>

<p>
lua 并不用反码补码的逻辑来理解 sBx，而只是将同样字节表示的 Bx 减去 offset 得到 sBx。
</p>


<div id="orgfc9b50d" class="figure">
<p><img src="opcode-Bx-sBx.png" alt="opcode-Bx-sBx.png">
</p>
</div>

<p>
offset 就是 sBx 的最大值，所以 <code>1111 1..1 1111</code> 对于 sBx 是没有意义的。
</p>
</div>
</div>

<div id="outline-container-org29e8ff5" class="outline-2">
<h2 id="org29e8ff5"><span class="section-number-2">3</span> kind</h2>
<div class="outline-text-2" id="text-3">
<p>
指令类型共有 38 种，用 enum OpCode 标识，
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">146: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">147: </span><span class="org-comment">** grep "ORDER OP" if you change these enums</span>
<span class="linenr">148: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">149: </span>
<span class="linenr">150: </span><span class="org-keyword">typedef</span> <span class="org-keyword">enum</span> {
<span class="linenr">151: </span><span class="org-comment-delimiter">/*</span><span class="org-comment">----------------------------------------------------------------------</span>
<span class="linenr">152: </span><span class="org-comment">name            args    description</span>
<span class="linenr">153: </span><span class="org-comment">------------------------------------------------------------------------</span><span class="org-comment-delimiter">*/</span>
<span class="linenr">154: </span><span class="org-variable-name">OP_MOVE</span>,<span class="org-comment-delimiter">/*      </span><span class="org-comment">A B     R(A) := R(B)</span><span class="org-comment-delimiter">                                    */</span>
<span class="linenr">155: </span><span class="org-variable-name">OP_LOADK</span>,<span class="org-comment-delimiter">/*     </span><span class="org-comment">A Bx    R(A) := Kst(Bx)</span><span class="org-comment-delimiter">                                 */</span>
<span class="linenr">156: </span><span class="org-variable-name">OP_LOADBOOL</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B C   R(A) := (Bool)B; if (C) pc++</span><span class="org-comment-delimiter">                    */</span>
<span class="linenr">157: </span><span class="org-variable-name">OP_LOADNIL</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A B     R(A) := ... := R(B) := nil</span><span class="org-comment-delimiter">                      */</span>
<span class="linenr">158: </span><span class="org-variable-name">OP_GETUPVAL</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B     R(A) := UpValue[B]</span><span class="org-comment-delimiter">                              */</span>
<span class="linenr">159: </span>
<span class="linenr">160: </span><span class="org-variable-name">OP_GETGLOBAL</span>,<span class="org-comment-delimiter">/* </span><span class="org-comment">A Bx    R(A) := Gbl[Kst(Bx)]</span><span class="org-comment-delimiter">                            */</span>
<span class="linenr">161: </span><span class="org-variable-name">OP_GETTABLE</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B C   R(A) := R(B)[RK(C)]</span><span class="org-comment-delimiter">                             */</span>
<span class="linenr">162: </span>
<span class="linenr">163: </span><span class="org-variable-name">OP_SETGLOBAL</span>,<span class="org-comment-delimiter">/* </span><span class="org-comment">A Bx    Gbl[Kst(Bx)] := R(A)</span><span class="org-comment-delimiter">                            */</span>
<span class="linenr">164: </span><span class="org-variable-name">OP_SETUPVAL</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B     UpValue[B] := R(A)</span><span class="org-comment-delimiter">                              */</span>
<span class="linenr">165: </span><span class="org-variable-name">OP_SETTABLE</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B C   R(A)[RK(B)] := RK(C)</span><span class="org-comment-delimiter">                            */</span>
<span class="linenr">166: </span>
<span class="linenr">167: </span><span class="org-variable-name">OP_NEWTABLE</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B C   R(A) := {} (size = B,C)</span><span class="org-comment-delimiter">                         */</span>
<span class="linenr">168: </span>
<span class="linenr">169: </span><span class="org-variable-name">OP_SELF</span>,<span class="org-comment-delimiter">/*      </span><span class="org-comment">A B C   R(A+1) := R(B); R(A) := R(B)[RK(C)]</span><span class="org-comment-delimiter">             */</span>
<span class="linenr">170: </span>
<span class="linenr">171: </span><span class="org-variable-name">OP_ADD</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) + RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">172: </span><span class="org-variable-name">OP_SUB</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) - RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">173: </span><span class="org-variable-name">OP_MUL</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) * RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">174: </span><span class="org-variable-name">OP_DIV</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) / RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">175: </span><span class="org-variable-name">OP_MOD</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) % RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">176: </span><span class="org-variable-name">OP_POW</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) ^ RK(C)</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">177: </span><span class="org-variable-name">OP_UNM</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B     R(A) := -R(B)</span><span class="org-comment-delimiter">                                   */</span>
<span class="linenr">178: </span><span class="org-variable-name">OP_NOT</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B     R(A) := not R(B)</span><span class="org-comment-delimiter">                                */</span>
<span class="linenr">179: </span><span class="org-variable-name">OP_LEN</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B     R(A) := length of R(B)</span><span class="org-comment-delimiter">                          */</span>
<span class="linenr">180: </span>
<span class="linenr">181: </span><span class="org-variable-name">OP_CONCAT</span>,<span class="org-comment-delimiter">/*    </span><span class="org-comment">A B C   R(A) := R(B).. ... ..R(C)</span><span class="org-comment-delimiter">                       */</span>
<span class="linenr">182: </span>
<span class="linenr">183: </span><span class="org-variable-name">OP_JMP</span>,<span class="org-comment-delimiter">/*       </span><span class="org-comment">sBx     pc+=sBx</span><span class="org-comment-delimiter">                                 */</span>
<span class="linenr">184: </span>
<span class="linenr">185: </span><span class="org-variable-name">OP_EQ</span>,<span class="org-comment-delimiter">/*        </span><span class="org-comment">A B C   if ((RK(B) == RK(C)) ~= A) then pc++</span><span class="org-comment-delimiter">            */</span>
<span class="linenr">186: </span><span class="org-variable-name">OP_LT</span>,<span class="org-comment-delimiter">/*        </span><span class="org-comment">A B C   if ((RK(B) &lt;  RK(C)) ~= A) then pc++</span><span class="org-comment-delimiter">            */</span>
<span class="linenr">187: </span><span class="org-variable-name">OP_LE</span>,<span class="org-comment-delimiter">/*        </span><span class="org-comment">A B C   if ((RK(B) &lt;= RK(C)) ~= A) then pc++</span><span class="org-comment-delimiter">            */</span>
<span class="linenr">188: </span>
<span class="linenr">189: </span><span class="org-variable-name">OP_TEST</span>,<span class="org-comment-delimiter">/*      </span><span class="org-comment">A C     if not (R(A) &lt;=&gt; C) then pc++</span><span class="org-comment-delimiter">                   */</span> 
<span class="linenr">190: </span><span class="org-variable-name">OP_TESTSET</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A B C   if (R(B) &lt;=&gt; C) then R(A) := R(B) else pc++</span><span class="org-comment-delimiter">     */</span> 
<span class="linenr">191: </span>
<span class="linenr">192: </span><span class="org-variable-name">OP_CALL</span>,<span class="org-comment-delimiter">/*      </span><span class="org-comment">A B C   R(A), ... ,R(A+C-2) := R(A)(R(A+1), ... ,R(A+B-1))</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">193: </span><span class="org-variable-name">OP_TAILCALL</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A B C   return R(A)(R(A+1), ... ,R(A+B-1))</span><span class="org-comment-delimiter">              */</span>
<span class="linenr">194: </span><span class="org-variable-name">OP_RETURN</span>,<span class="org-comment-delimiter">/*    </span><span class="org-comment">A B     return R(A), ... ,R(A+B-2)      (see note)</span><span class="org-comment-delimiter">      */</span>
<span class="linenr">195: </span>
<span class="linenr">196: </span><span class="org-variable-name">OP_FORLOOP</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A sBx   R(A)+=R(A+2);</span>
<span class="linenr">197: </span><span class="org-comment">                        if R(A) &lt;?= R(A+1) then { pc+=sBx; R(A+3)=R(A) }</span><span class="org-comment-delimiter">*/</span>
<span class="linenr">198: </span><span class="org-variable-name">OP_FORPREP</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A sBx   R(A)-=R(A+2); pc+=sBx</span><span class="org-comment-delimiter">                           */</span>
<span class="linenr">199: </span>
<span class="linenr">200: </span><span class="org-variable-name">OP_TFORLOOP</span>,<span class="org-comment-delimiter">/*  </span><span class="org-comment">A C     R(A+3), ... ,R(A+2+C) := R(A)(R(A+1), R(A+2)); </span>
<span class="linenr">201: </span><span class="org-comment">                        if R(A+3) ~= nil then R(A+2)=R(A+3) else pc++</span><span class="org-comment-delimiter">   */</span> 
<span class="linenr">202: </span><span class="org-variable-name">OP_SETLIST</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A B C   R(A)[(C-1)*FPF+i] := R(A+i), 1 &lt;= i &lt;= B</span><span class="org-comment-delimiter">        */</span>
<span class="linenr">203: </span>
<span class="linenr">204: </span><span class="org-variable-name">OP_CLOSE</span>,<span class="org-comment-delimiter">/*     </span><span class="org-comment">A       close all variables in the stack up to (&gt;=) R(A)</span><span class="org-comment-delimiter">*/</span>
<span class="linenr">205: </span><span class="org-variable-name">OP_CLOSURE</span>,<span class="org-comment-delimiter">/*   </span><span class="org-comment">A Bx    R(A) := closure(KPROTO[Bx], R(A), ... ,R(A+n))</span><span class="org-comment-delimiter">  */</span>
<span class="linenr">206: </span>
<span class="linenr">207: </span><span class="org-variable-name">OP_VARARG</span><span class="org-comment-delimiter">/*     </span><span class="org-comment">A B     R(A), R(A+1), ..., R(A+B-1) = vararg</span><span class="org-comment-delimiter">            */</span>
<span class="linenr">208: </span>} <span class="org-type">OpCode</span>;
<span class="linenr">209: </span>
<span class="linenr">210: </span>
<span class="linenr">211: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">NUM_OPCODES</span>     (cast(<span class="org-type">int</span>, OP_VARARG) + 1)
</pre>
</div>

<p>
注释描述了相应类型的指令所接受的参数和功能。
</p>
</div>
</div>

<div id="outline-container-orgd70b78b" class="outline-2">
<h2 id="orgd70b78b"><span class="section-number-2">4</span> model</h2>
<div class="outline-text-2" id="text-4">
<p>
想要了解指令具体的功能，就需要提前对 vm 的执行模型有一些了解。
</p>


<div id="org34662f7" class="figure">
<p><img src="opcode-model.png" alt="opcode-model.png">
</p>
</div>

<p>
vm 为编程语言提供了更大的灵活性，原因就在于这个虚拟的机器内部可以自由构造，而不用面对一成不变的 x86 架构。
</p>

<p>
不管 vm 如何设计，目的都是执行 opcode，实现其描述的语义。
lua 实现的 vm 主要由图中的几个部分构成。
</p>
</div>

<div id="outline-container-org98748f5" class="outline-3">
<h3 id="org98748f5"><span class="section-number-3">4.1</span> Code &amp; pc</h3>
<div class="outline-text-3" id="text-4-1">
<p>
vm 在执行时，必须要有执行的蓝图，即输入的字节码。
</p>

<p>
Code 就表示 vm 要执行的字节码，在内部以指令数组的形式来存储。
</p>

<p>
pc 的概念都不陌生，用于索引当前正在执行的指令。
</p>
</div>
</div>

<div id="outline-container-orgef8f1a1" class="outline-3">
<h3 id="orgef8f1a1"><span class="section-number-3">4.2</span> Stack</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Stack 时刻记录着 vm 执行指令时的状态。
</p>

<p>
lua 中的 vm 比较特殊，存在寄存器的概念，但是将寄存器的存储区域放在栈中（准确地说是栈底）。
</p>
</div>
</div>

<div id="outline-container-org5eff8ad" class="outline-3">
<h3 id="org5eff8ad"><span class="section-number-3">4.3</span> Kst</h3>
<div class="outline-text-3" id="text-4-3">
<p>
这是一个辅助结构，用于记录 lua 代码中出现的常量，在指令中通过 kst 中的索引来使用这些常量。
</p>
</div>
</div>

<div id="outline-container-orged04459" class="outline-3">
<h3 id="orged04459"><span class="section-number-3">4.4</span> Gbl</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Gbl 是全局表，以 table 结构来实现，对应 lua 语言中“全局”的概念，比如全局变量，就存储在这里。
</p>
</div>
</div>

<div id="outline-container-orgd92445b" class="outline-3">
<h3 id="orgd92445b"><span class="section-number-3">4.5</span> UpValue</h3>
<div class="outline-text-3" id="text-4-5">
<p>
记录闭包引用的上值，之后再详细解释。
</p>
</div>
</div>
</div>

<div id="outline-container-org136b60f" class="outline-2">
<h2 id="org136b60f"><span class="section-number-2">5</span> meaning</h2>
<div class="outline-text-2" id="text-5">
<p>
对应 vm 模型的粗略了解，下面来看指令后的功能描述表达了什么含义。
</p>

<p>
<code>R(A)</code> 表示索引为 A 的寄存器，因为寄存器存储在栈中，所以 <code>R(A)</code> 直接索引栈中的空间。
</p>

<p>
寄存器是可读写的，如果出现在赋值左边，表示寄存器的位置；出现在赋值右边，表示使用相应位置的值。
</p>


<div id="org231b6db" class="figure">
<p><img src="opcode-model-r.png" alt="opcode-model-r.png">
</p>
</div>

<p>
<code>Kst(Bx)</code> 表示索引为 Bx 的常量，从 kst 表中取值。
</p>

<p>
常量表在执行时是只读的。
</p>


<div id="org5320893" class="figure">
<p><img src="opcode-model-kst.png" alt="opcode-model-kst.png">
</p>
</div>

<p>
<code>RK(B)</code> 根据 B 的大小，用于索引寄存器/常量，只用于只读。
</p>


<div id="org52a310d" class="figure">
<p><img src="opcode-model-rk.png" alt="opcode-model-rk.png">
</p>
</div>

<p>
这里和之前参数空间的长度安排巧妙地联系在一起。
</p>

<p>
A B C 三个参数，长度分别为 8 9 9 bits。
在 opcode 的整体设计中，没有 RK(A)，只有 RK(B) RK(C)。
</p>

<p>
所以使用 B C 中比 A 多出的 1 个高位 bit，用于辨别 RK 表示的是 R 还是 K。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">R/K</th>
<th scope="col" class="org-left">bits</th>
<th scope="col" class="org-left">range</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">R</td>
<td class="org-left">0&#x2026;&#x2026;..</td>
<td class="org-left">0 -&gt; 255</td>
</tr>

<tr>
<td class="org-left">K</td>
<td class="org-left">1&#x2026;&#x2026;..</td>
<td class="org-left">256 -&gt; 511</td>
</tr>
</tbody>
</table>

<p>
这样，相应的宏也就不难理解。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">114: </span><span class="org-comment-delimiter">/*</span>
<span class="linenr">115: </span><span class="org-comment">** Macros to operate RK indices</span>
<span class="linenr">116: </span><span class="org-comment-delimiter">*/</span>
<span class="linenr">117: </span>
<span class="linenr">118: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">this bit 1 means constant (0 means register)</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">119: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">BITRK</span>           (1 &lt;&lt; (SIZE_B - 1))
<span class="linenr">120: </span>
<span class="linenr">121: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">test whether value is a constant</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">122: </span><span class="org-preprocessor">#define</span> <span class="org-function-name">ISK</span>(<span class="org-variable-name">x</span>)          ((x) &amp; BITRK)
<span class="linenr">123: </span>
<span class="linenr">124: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">gets the index of the constant</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">125: </span><span class="org-preprocessor">#define</span> <span class="org-function-name">INDEXK</span>(<span class="org-variable-name">r</span>)       ((<span class="org-type">int</span>)(r) &amp; ~BITRK)
<span class="linenr">126: </span>
<span class="linenr">127: </span><span class="org-preprocessor">#define</span> <span class="org-variable-name">MAXINDEXRK</span>      (BITRK - 1)
<span class="linenr">128: </span>
<span class="linenr">129: </span><span class="org-comment-delimiter">/* </span><span class="org-comment">code a constant index as a RK value</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">130: </span><span class="org-preprocessor">#define</span> <span class="org-function-name">RKASK</span>(<span class="org-variable-name">x</span>)        ((x) | BITRK)
</pre>
</div>

<p>
<code>Gbl</code> 是全局表，Stack 和 Kst 都以数组来实现，所以只需要整数索引，而 Gbl 是真正的表，
用 table 来实现，这意味着索引可以是除 nil 外的任意值。
所以在索引使用 Gbl 时，通常使用间接的方式。
</p>


<div id="org83390a3" class="figure">
<p><img src="opcode-model-gbl.png" alt="opcode-model-gbl.png">
</p>
</div>


<p>
<code>UpValue</code> 表和 Kst 类似，以数组表示，用整数索引，但是可读写。
</p>


<div id="orgea9e3fc" class="figure">
<p><img src="opcode-model-upval.png" alt="opcode-model-upval.png">
</p>
</div>

<p>
有了上面符号的理解，读者应该能读懂大部分指令所表达的功能。
</p>

<p>
本质上，vm 的运行过程就是不断的执行指令，操作不同区域的数据的过程。
</p>

<p>
下面列几个简单示例。
</p>
</div>

<div id="outline-container-org39b377c" class="outline-3">
<h3 id="org39b377c"><span class="section-number-3">5.1</span> move</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">154: </span>OP_MOVE,<span class="org-comment-delimiter">/*      </span><span class="org-comment">A B     R(A) := R(B)</span><span class="org-comment-delimiter">                                    */</span>
</pre>
</div>

<p>
move 很容易理解，直接进行寄存器间的赋值。
</p>


<div id="orga83cdbe" class="figure">
<p><img src="opcode-model-move.png" alt="opcode-model-move.png">
</p>
</div>
</div>
</div>

<div id="outline-container-org956dd61" class="outline-3">
<h3 id="org956dd61"><span class="section-number-3">5.2</span> getglobal</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">160: </span>OP_GETGLOBAL,<span class="org-comment-delimiter">/* </span><span class="org-comment">A Bx    R(A) := Gbl[Kst(Bx)]</span><span class="org-comment-delimiter">                            */</span>
</pre>
</div>

<p>
Gbl 因为不使用整数索引，所以在引用其中元素时，需要 Kst 作间接的引用。
</p>


<div id="orgcc4c6c0" class="figure">
<p><img src="opcode-model-getglobal.png" alt="opcode-model-getglobal.png">
</p>
</div>
</div>
</div>

<div id="outline-container-orge056f8f" class="outline-3">
<h3 id="orge056f8f"><span class="section-number-3">5.3</span> add</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>lopcodes.h</label><pre class="src src-c"><span class="linenr">171: </span>OP_ADD,<span class="org-comment-delimiter">/*       </span><span class="org-comment">A B C   R(A) := RK(B) + RK(C)</span><span class="org-comment-delimiter">                           */</span>
</pre>
</div>

<p>
add 是二元运算，其中使用 RK 来引用。
</p>


<div id="orgffeb2e5" class="figure">
<p><img src="opcode-model-add.png" alt="opcode-model-add.png">
</p>
</div>
</div>
</div>

<div id="outline-container-org4991f0c" class="outline-3">
<h3 id="org4991f0c"><span class="section-number-3">5.4</span> more</h3>
<div class="outline-text-3" id="text-5-4">
<p>
ChunkSpy 的作者对于 opcode 有更深刻的理解，在其发布 ChunkSpy 程序的时候，也附带了描述 opcode 的文档<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>，
推荐读者详细阅读。
</p>
</div>
</div>
</div>

<div id="outline-container-org152ccef" class="outline-2">
<h2 id="org152ccef"><span class="section-number-2">6</span> meta</h2>
<div class="outline-text-2" id="text-6">
<p>
opcode 模块除了定义指令的类型和格式，同时也记录了指令的其它信息，用于辅助代码生成。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>lopcodes.c</label><pre class="src src-C"><span class="linenr"> 59: </span><span class="org-preprocessor">#define</span> <span class="org-function-name">opmode</span>(<span class="org-variable-name">t</span>,<span class="org-variable-name">a</span>,<span class="org-variable-name">b</span>,<span class="org-variable-name">c</span>,<span class="org-variable-name">m</span>) (((t)&lt;&lt;7) | ((a)&lt;&lt;6) | ((b)&lt;&lt;4) | ((c)&lt;&lt;2) | (m))
<span class="linenr"> 60: </span>
<span class="linenr"> 61: </span><span class="org-keyword">const</span> <span class="org-type">lu_byte</span> <span class="org-variable-name">luaP_opmodes</span>[NUM_OPCODES] = {
<span class="linenr"> 62: </span><span class="org-comment-delimiter">/*       </span><span class="org-comment">T  A    B       C     mode                opcode</span><span class="org-comment-delimiter">       */</span>
<span class="linenr"> 63: </span>  opmode(0, 1, OpArgR, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_MOVE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 64: </span> ,opmode(0, 1, OpArgK, OpArgN, iABx)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LOADK</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 65: </span> ,opmode(0, 1, OpArgU, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LOADBOOL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 66: </span> ,opmode(0, 1, OpArgR, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LOADNIL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 67: </span> ,opmode(0, 1, OpArgU, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_GETUPVAL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 68: </span> ,opmode(0, 1, OpArgK, OpArgN, iABx)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_GETGLOBAL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 69: </span> ,opmode(0, 1, OpArgR, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_GETTABLE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 70: </span> ,opmode(0, 0, OpArgK, OpArgN, iABx)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SETGLOBAL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 71: </span> ,opmode(0, 0, OpArgU, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SETUPVAL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 72: </span> ,opmode(0, 0, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SETTABLE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 73: </span> ,opmode(0, 1, OpArgU, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_NEWTABLE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 74: </span> ,opmode(0, 1, OpArgR, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SELF</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 75: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_ADD</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 76: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SUB</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 77: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_MUL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 78: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_DIV</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 79: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_MOD</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 80: </span> ,opmode(0, 1, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_POW</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 81: </span> ,opmode(0, 1, OpArgR, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_UNM</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 82: </span> ,opmode(0, 1, OpArgR, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_NOT</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 83: </span> ,opmode(0, 1, OpArgR, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LEN</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 84: </span> ,opmode(0, 1, OpArgR, OpArgR, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_CONCAT</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 85: </span> ,opmode(0, 0, OpArgR, OpArgN, iAsBx)           <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_JMP</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 86: </span> ,opmode(1, 0, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_EQ</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 87: </span> ,opmode(1, 0, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LT</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 88: </span> ,opmode(1, 0, OpArgK, OpArgK, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_LE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 89: </span> ,opmode(1, 1, OpArgR, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_TEST</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 90: </span> ,opmode(1, 1, OpArgR, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_TESTSET</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 91: </span> ,opmode(0, 1, OpArgU, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_CALL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 92: </span> ,opmode(0, 1, OpArgU, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_TAILCALL</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 93: </span> ,opmode(0, 0, OpArgU, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_RETURN</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 94: </span> ,opmode(0, 1, OpArgR, OpArgN, iAsBx)           <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_FORLOOP</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 95: </span> ,opmode(0, 1, OpArgR, OpArgN, iAsBx)           <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_FORPREP</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 96: </span> ,opmode(1, 0, OpArgN, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_TFORLOOP</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 97: </span> ,opmode(0, 0, OpArgU, OpArgU, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_SETLIST</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 98: </span> ,opmode(0, 0, OpArgN, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_CLOSE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr"> 99: </span> ,opmode(0, 1, OpArgU, OpArgN, iABx)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_CLOSURE</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">100: </span> ,opmode(0, 1, OpArgU, OpArgN, iABC)            <span class="org-comment-delimiter">/* </span><span class="org-comment">OP_VARARG</span><span class="org-comment-delimiter"> */</span>
<span class="linenr">101: </span>};
</pre>
</div>

<p>
这些信息用 1 byte 8 bits 来记录，其中
</p>
<ul class="org-ul">
<li>T，表示指令是否有 test 操作</li>
<li>A，表示是否修改了 R(A)</li>
<li>mode，表示指令属于 iABC/iABx/iAsBx 的哪一种</li>
<li>B C，表示 B C 参数的使用方式
<ul class="org-ul">
<li>OpArgN，未使用</li>
<li>OpArgU，使用</li>
<li>OpArgR，作为寄存器索引/跳转偏移量</li>
<li>OpArgK，作为常量索引/RK索引</li>
</ul></li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>lopcodes.h</label><pre class="src src-c"><span class="org-comment-delimiter">/*</span>
<span class="org-comment">** masks for instruction properties. The format is:</span>
<span class="org-comment">** bits 0-1: op mode</span>
<span class="org-comment">** bits 2-3: C arg mode</span>
<span class="org-comment">** bits 4-5: B arg mode</span>
<span class="org-comment">** bit 6: instruction set register A</span>
<span class="org-comment">** bit 7: operator is a test</span>
<span class="org-comment-delimiter">*/</span>  

<span class="org-keyword">enum</span> <span class="org-type">OpArgMask</span> {
  <span class="org-variable-name">OpArgN</span>,  <span class="org-comment-delimiter">/* </span><span class="org-comment">argument is not used</span><span class="org-comment-delimiter"> */</span>
  <span class="org-variable-name">OpArgU</span>,  <span class="org-comment-delimiter">/* </span><span class="org-comment">argument is used</span><span class="org-comment-delimiter"> */</span>
  <span class="org-variable-name">OpArgR</span>,  <span class="org-comment-delimiter">/* </span><span class="org-comment">argument is a register or a jump offset</span><span class="org-comment-delimiter"> */</span>
  <span class="org-variable-name">OpArgK</span>   <span class="org-comment-delimiter">/* </span><span class="org-comment">argument is a constant or register/constant</span><span class="org-comment-delimiter"> */</span>
};
</pre>
</div>

<p>
相应地，相关的宏就不难理解。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>lopcodes.h</label><pre class="src src-c"><span class="org-preprocessor">#define</span> <span class="org-function-name">getOpMode</span>(<span class="org-variable-name">m</span>)    (cast(<span class="org-keyword">enum</span> <span class="org-type">OpMode</span>, luaP_opmodes[m] &amp; 3))
<span class="org-preprocessor">#define</span> <span class="org-function-name">getBMode</span>(<span class="org-variable-name">m</span>)     (cast(<span class="org-keyword">enum</span> <span class="org-type">OpArgMask</span>, (luaP_opmodes[m] &gt;&gt; 4) &amp; 3))
<span class="org-preprocessor">#define</span> <span class="org-function-name">getCMode</span>(<span class="org-variable-name">m</span>)     (cast(<span class="org-keyword">enum</span> <span class="org-type">OpArgMask</span>, (luaP_opmodes[m] &gt;&gt; 2) &amp; 3))
<span class="org-preprocessor">#define</span> <span class="org-function-name">testAMode</span>(<span class="org-variable-name">m</span>)    (luaP_opmodes[m] &amp; (1 &lt;&lt; 6))
<span class="org-preprocessor">#define</span> <span class="org-function-name">testTMode</span>(<span class="org-variable-name">m</span>)    (luaP_opmodes[m] &amp; (1 &lt;&lt; 7))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7c483b" class="outline-2">
<h2 id="orgf7c483b"><span class="section-number-2">7</span> practice</h2>
<div class="outline-text-2" id="text-7">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">文件</th>
<th scope="col" class="org-left">建议</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">lopcodes.h</td>
<td class="org-left">仔细阅读</td>
</tr>

<tr>
<td class="org-left">lopcodes.c</td>
<td class="org-left">仔细阅读</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
: <a href="a no frills introduction to lua 5.1 vm instructions.pdf">a no frills introduction to lua 5.1 vm instructions.pdf</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">

<p>Updated: 2021-01-14 四 17:46</p>
<p>Created: 2021-01-06 三 16:12</p>
<p>Author: DreamAndDead</p>
<p>Email: <a href="mailto:dreamanddead@foxmail.com">dreamanddead@foxmail.com</a></p>
<script src="https://utteranc.es/client.js" repo="DreamAndDead/DreamAndDead.github.io" issue-term="pathname" label="Comment" theme="github-light" crossorigin="anonymous" async></script>
</div>
</body>
</html>
